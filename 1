<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNCR Sensor App - Tutorial (Inline Approach)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Styles for 1:1 Fidelity */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        #app-container {
            width: 100%;
            max-width: 400px; 
            height: 100vh;
            max-height: 100vh;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 0;
            margin: 0 auto;
        }

        /* Small phones (iPhone SE, etc.) */
        @media (max-width: 375px) {
            #app-container {
                max-width: 100%;
                border-radius: 0;
            }
            
            /* Tutorial adjustments for iPhone SE (375x667) */
            .tutorial-inline-tooltip {
                max-width: calc(100% - 16px);
                min-width: auto;
                width: calc(100% - 16px);
                padding: 0.5rem 0.75rem;
                font-size: 0.7rem;
                line-height: 1.25;
                bottom: 8px;
                left: 8px;
                transform: none;
                border-radius: 6px;
            }
            
            .tutorial-inline-tooltip h4 {
                font-size: 0.75rem;
                margin-bottom: 0.2rem;
            }
            
            .tutorial-inline-tooltip p {
                font-size: 0.7rem;
                line-height: 1.25;
                margin-bottom: 0.3rem;
            }
            
            .tutorial-inline-tooltip .btn-next-inline,
            .tutorial-inline-tooltip .btn-skip-inline {
                font-size: 0.7rem;
                padding: 0.4rem 0.75rem;
                margin-bottom: 0.25rem;
            }
            
            .tutorial-pointer-circle {
                width: 50px;
                height: 50px;
                border-width: 2px;
            }
            
            .tutorial-pointer {
                font-size: 32px;
            }
            
            .tutorial-highlight-inline {
                outline-width: 2px;
                outline-offset: 1px;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            }
            
            .tutorial-inline-tooltip.configuring {
                top: 8px;
                bottom: auto;
                left: 8px;
                right: 8px;
                width: calc(100% - 16px);
                max-width: calc(100% - 16px);
            }
        }

        /* Medium phones (Samsung Galaxy, iPhone 12/13/14) */
        @media (min-width: 376px) and (max-width: 428px) {
            #app-container {
                max-width: 100%;
                border-radius: 0;
            }
        }

        /* Large phones (iPhone 14 Pro Max, etc.) */
        @media (min-width: 429px) and (max-width: 480px) {
            #app-container {
                max-width: 100%;
                border-radius: 0;
            }
        }

        /* Desktop: Move app container down and add border radius */
        @media (min-width: 769px) {
            #app-container {
                margin-top: 40px;
                border-radius: 0.75rem;
                max-height: 800px;
            }
        }
        
        /* Inline Tutorial Styles */
        .tutorial-inline-tooltip {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.98);
            color: white;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(102, 126, 234, 0.3);
            z-index: 10000;
            max-width: 320px;
            min-width: 280px;
            font-size: 0.875rem;
            line-height: 1.4;
            pointer-events: none;
            /* Smooth floating transitions - no flash */
            opacity: 0;
            transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out, left 0.5s ease-in-out, top 0.5s ease-in-out, transform 0.5s ease-in-out;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .tutorial-inline-tooltip.visible {
            opacity: 1;
        }
        
        @media (max-width: 480px) {
            .tutorial-inline-tooltip {
                max-width: calc(100% - 12px);
                min-width: auto;
                width: calc(100% - 12px);
                padding: 0.5rem 0.625rem 0.5rem 0.625rem;
                font-size: 0.75rem;
                line-height: 1.3;
                bottom: 6px;
                left: 6px;
                transform: none;
                border-radius: 6px;
            }
        }
        
        /* Removed slideInTooltip animation - using smooth fade-in instead */
        
        .tutorial-inline-tooltip::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }
        
        .tutorial-inline-tooltip.top::before {
            bottom: -16px;
            left: 20px;
            border-top-color: #764ba2;
        }
        
        .tutorial-inline-tooltip.bottom::before {
            top: -16px;
            left: 20px;
            border-bottom-color: #764ba2;
        }
        
        .tutorial-inline-tooltip.left::before {
            right: -16px;
            top: 50%;
            transform: translateY(-50%);
            border-left-color: #764ba2;
        }
        
        .tutorial-inline-tooltip.right::before {
            left: -16px;
            top: 50%;
            transform: translateY(-50%);
            border-right-color: #764ba2;
        }
        
        .tutorial-highlight-inline {
            position: relative;
            z-index: 9999;
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
            border-radius: 6px;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            animation: pulseHighlight 3s ease-in-out infinite;
        }
        
        .tutorial-pointer {
            position: absolute;
            font-size: 40px;
            color: #3b82f6;
            z-index: 10002;
            pointer-events: none;
            animation: bouncePointer 2.5s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            margin: 0;
            padding: 0;
            line-height: 1;
        }
        
        /* Gentle pulsing "Tap!" text animation for Step 14 */
        @keyframes flashTap {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.98); }
        }
        
        .tutorial-tap-text {
            position: fixed;
            color: #3b82f6;
            font-weight: bold;
            font-size: 18px;
            z-index: 10001;
            pointer-events: none;
            animation: flashTap 1.5s ease-in-out infinite;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }
        
        @media (max-width: 375px) {
            .tutorial-tap-text {
                font-size: 16px;
            }
        }
        
        .tutorial-pointer-circle {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #d82a27;
            background: rgba(216, 42, 39, 0.15);
            z-index: 10001;
            pointer-events: none;
            animation: pulseCircle 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 2px rgba(216, 42, 39, 0.3);
            opacity: 0;
            transition: opacity 0.5s ease-in-out, left 0.5s ease-in-out, top 0.5s ease-in-out;
        }
        
        .tutorial-pointer-circle.visible {
            opacity: 1;
        }
        
        /* No transition when first appearing - instant appearance */
        .tutorial-pointer-circle.first-appear {
            transition: none !important;
        }
        
        @media (max-width: 480px) {
            .tutorial-pointer {
                font-size: 32px;
            }
            .tutorial-pointer-circle {
                width: 50px;
                height: 50px;
                border-width: 2.5px;
            }
        }
        
        @keyframes bouncePointer {
            0%, 100% {
                transform: translate(-50%, -50%) translateY(0) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) translateY(-8px) scale(1.05);
            }
        }
        
        @keyframes pulseCircle {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.08);
                opacity: 0.9;
            }
        }
        
        .tutorial-inline-tooltip.configuring {
            top: 20px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            transition: top 0.5s ease-in-out, left 0.5s ease-in-out, transform 0.5s ease-in-out, opacity 0.4s ease-in-out;
        }
        
        @media (max-width: 480px) {
            .tutorial-inline-tooltip.configuring {
                top: 8px;
                bottom: auto;
                left: 50%;
                transform: translateX(-50%);
                transition: top 0.5s ease-in-out, left 0.5s ease-in-out, transform 0.5s ease-in-out, opacity 0.4s ease-in-out;
            }
        }
        
        @keyframes pulseHighlight {
            0%, 100% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.25);
            }
        }
        
        .tutorial-step-indicator-inline {
            position: fixed;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            z-index: 10001;
            font-weight: 500;
        }
        
        @media (max-width: 480px) {
            .tutorial-step-indicator-inline {
                top: 4px;
                padding: 0.25rem 0.5rem;
                font-size: 0.65rem;
                max-width: calc(100% - 16px);
                white-space: nowrap;
                border-radius: 8px;
            }
        }
        
        .tutorial-inline-tooltip h4 {
            margin: 0 0 0.375rem 0;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        @media (max-width: 480px) {
            .tutorial-inline-tooltip h4 {
                font-size: 0.8rem;
                margin: 0 0 0.25rem 0;
            }
        }
        
        .tutorial-inline-tooltip p {
            margin: 0 0 0.5rem 0;
            line-height: 1.4;
        }
        
        @media (max-width: 480px) {
            .tutorial-inline-tooltip p {
                margin: 0 0 0.375rem 0;
                font-size: 0.75rem;
                line-height: 1.3;
            }
        }
        
        .tutorial-inline-tooltip .btn-next-inline {
            background: white;
            color: #764ba2;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            pointer-events: auto;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
        }
        
        @media (max-width: 480px) {
            .tutorial-inline-tooltip .btn-next-inline {
                padding: 0.375rem 0.75rem;
                font-size: 0.7rem;
                margin-bottom: 0.25rem;
            }
        }
        
        .tutorial-inline-tooltip .btn-next-inline:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .tutorial-inline-tooltip .btn-skip-inline {
            background: transparent;
            color: white;
            border: 1px solid white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 0;
            pointer-events: auto;
            font-size: 0.875rem;
        }
        
        @media (max-width: 480px) {
            .tutorial-inline-tooltip .btn-skip-inline {
                padding: 0.375rem 0.75rem;
                font-size: 0.7rem;
            }
        }

        /* Red Header Bar */
        .header-bar {
            background-color: #d82a27; 
            color: white;
            padding: 0.75rem 0.5rem;
            display: flex;
            align-items: center;
            height: 56px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .header-title {
            font-size: 1.125rem; /* text-xl */
            font-weight: 500; /* Medium weight for title fidelity */
            letter-spacing: 0.025em; /* Tracking-wide */
        }

        /* Sub-Header (Measurement Info on Setup Screens) */
        .sub-header-bar {
            background-color: #d82a27; 
            color: white;
            padding: 0.25rem 1rem 0.5rem 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* List Item Separator */
        .list-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 0.8rem 1rem; /* Precise padding */
        }
        
        /* Simulates the light gray text header above sections */
        .section-header {
            color: #757575;
            padding: 0.5rem 1rem;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
            text-transform: uppercase;
        }

        /* Icon sizing for fidelity */
        .app-icon {
            width: 24px;
            height: 24px;
            stroke-width: 2.2;
        }

        /* Spinner for loading screens */
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Styling for the small sensor images */
        .sensor-icon-1 {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid #ccc;
        }
        .sensor-icon-2 {
            width: 32px;
            height: 32px;
            background-color: #a51e24; /* Red body */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid #a51e24;
            border-radius: 4px 4px 0 0;
            margin-top: 2px;
        }
        .sensor-tip {
            width: 12px;
            height: 8px;
            background-color: #e5e5e5;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px 2px 0 0;
        }
        .sensor-bottom {
            width: 32px;
            height: 4px;
            background-color: #333; /* Dark base */
            position: absolute;
            bottom: -4px;
        }
        .signal-bar-svg {
            display: flex;
            align-items: flex-end;
            height: 16px;
            width: 16px;
            gap: 1px;
        }
        .signal-bar {
            width: 4px;
            background-color: #000;
            border-radius: 1px;
        }

        /* Styling for the list item icons */
        .icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        /* Device Home Screen Styles */
        .device-image-placeholder {
            width: 60px;
            height: 90px;
            background-color: #ccc;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            border: 1px solid #aaa;
        }
        .device-image-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 35px;
            background-color: #eee;
            border-bottom: 1px solid #aaa;
        }
        .ok-status-container {
            width: 30px;
            height: 30px;
            background-color: #049504;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
        }
        .menu-icon-container {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
        }
        .setup-icon-container {
            background-color: #3f51b5;
        }
        .diagnostics-icon-container {
            background-color: #00bcd4;
        }

        /* Setup Menu Styles */
        .setup-percentage {
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: #222;
            border-bottom: 1px solid #eee;
        }
        .setup-menu-item {
            display: flex;
            align-items: center;
            padding: 13px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .setup-menu-item:hover {
            background-color: #f5f5f5;
        }
        .setup-menu-item-text {
            flex-grow: 1;
            font-size: 0.95em;
            color: #222;
        }
        .setup-item-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 15px;
        }
        .setup-chevron {
            color: #ccc;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        .setup-section-header {
            background-color: #f0f0f0;
            color: #707070;
            font-size: 0.8em;
            padding: 8px 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #ccc;
            cursor: pointer;
        }
        .setup-section-header:hover {
            background-color: #e5e5e5;
        }
        .setup-color-green { color: #37B85F; }
        .setup-color-orange { color: #E88326; }
        .setup-color-blue { color: #3A90D0; }
        .setup-color-purple { color: #9A59B5; }
        .setup-color-dark { color: #666666; }
        .setup-color-red { color: #D22129; }

        /* Adjustment Screen Diagram Styles */
        .distance-line {
            stroke-dasharray: 4 2;
            stroke-width: 1.5;
            stroke: #333;
        }

        /* Smooth scrolling for screen transitions */
        #screen-view {
            scroll-behavior: smooth;
        }

        /* Sensor Selection Page Styles */
        .sensor-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 15px;
        }

        .sensor-btn {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
        }

        .sensor-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .sensor-btn:active {
            transform: translateY(0);
        }

        /* Interactive Dial Styles */
        .clock-face {
            width: 80px;
            height: 80px;
            border-width: 2px;
            border-color: #6b7280; 
            position: relative;
        }

        .dial-number {
            position: absolute;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            user-select: none;
        }
        
        .dial-number.active {
            color: #6b7280; 
            transform: translate(-50%, -50%) scale(1.1);
        }

        .pointer-wrapper {
            position: absolute;
            top: 40px;
            left: 40px;
            width: 30px;
            height: 1px;
            transform-origin: 0 0;
        }

        .pointer-wrapper::before {
            content: '';
            position: absolute;
            right: 0; 
            top: -4px;
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 10px solid #6b7280;
        }

        /* Hide native number input spinners - we use custom buttons */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        .pointer-wrapper::after {
            content: '';
            position: absolute;
            left: -3px; 
            top: -3px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6b7280;
        }

        /* Device Home Screen Styles */
        .header-section {
            padding: 0.5rem 1rem;
            color: #4b5563;
            font-weight: 500;
            font-size: 0.875rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .info-block {
            line-height: 1.2;
        }
        .measurement-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.75rem;
            max-width: 100%;
        }
        .measurement-value-block {
            min-height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .divider {
            height: 8px;
            background-color: #f3f4f6;
        }
        .main-value {
            color: #10b981;
            line-height: 1;
            display: flex; 
            justify-content: center;
            align-items: flex-end;
        }
        .value-number {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            padding-right: 2px;
        }
        .value-percent-sign {
            font-size: 1.5rem; 
            font-weight: 700;
            line-height: 1;
            position: relative;
            bottom: 0px; 
        }
        .check-icon-container {
            width: 48px;
            height: 48px;
            border-radius: 0.375rem;
            background-color: #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.25rem;
            color: white;
            margin: 0 auto;
        }
        .left-column-align {
            min-height: 96px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* Prevent text selection on clickable measurement values */
        .cursor-pointer {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .value-unit {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            position: relative;
            bottom: 0px;
            color: #10b981;
        }

    </style>
</head>
<body class="selection:bg-red-200">

    <div id="app-container">
        <!-- Main Content Area (Screen will be injected here) -->
        <div id="screen-view" class="flex-grow overflow-y-auto overflow-x-hidden bg-white">
            <!-- Screen content goes here -->
        </div>
    </div>

    <!-- The common Modal Structure (hidden by default) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-20 hidden flex justify-center items-end"
         onclick="if(event.target.id === 'modal-overlay') hideModal()">
        <!-- The modal box itself, content generated by JS -->
        <div id="modal-box" class="w-full sm:max-w-md bg-white rounded-t-lg shadow-2xl overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 90vh; overflow-y: auto;">
            <!-- Modal Content (Injected here) -->
        </div>
    </div>

<script>
    // Global State
    let currentScreen = 'SENSOR_SELECTION';
    let history = [];
    const screenView = document.getElementById('screen-view');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalBox = document.getElementById('modal-box');
    
    // Constant device info for consistency
    const DEVICE_NAME = "VEGAPULS C 23";
    const DEVICE_SERIAL = "71595362";
    const HART_TAG = "hart#1-2501419";
    const MEASUREMENT_VALUE = "98.06"; // Split from unit for styling
    const MEASUREMENT_UNIT = "%";
    
    let deviceAddress = 0; 
    let accessCode = '1234';
    let distanceA = '2.000 ft';
    let distanceB = '40.000 ft';
    // Initialize loopCurrentMode based on deviceAddress
    let loopCurrentMode = deviceAddress === 0 ? 'Analogue current output (4 ... 20 mA)' : 'Fixed current (4 mA)';
    
    // Track selected sensor type
    let selectedSensorType = 'HART'; // Default to HART
    
    // Track selected device number (1, 2, or 3)
    let selectedDeviceNumber = 1; // Default to device 1
    
    // Helper functions to get device info based on device number and sensor type
    function getDeviceTag(deviceNum, sensorType) {
        const tagEndings = {
            1: '2501419',
            2: '2501430',
            3: '2501450'
        };
        const prefix = sensorType === 'MODBUS' ? 'modbus' : sensorType === 'ANALOG' ? 'analog' : 'hart';
        return `${prefix}#${deviceNum}-${tagEndings[deviceNum]}`;
    }
    
    function getDeviceImage(deviceNum) {
        const images = {
            1: 'cncr-190.png',
            2: 'cncr-220.png',
            3: 'cncr-110.png'
        };
        return images[deviceNum] || images[1];
    }
    
    function getDeviceName(deviceNum) {
        const names = {
            1: 'VEGAPULS C 23',
            2: 'CNCR-220',
            3: 'CNCR-110'
        };
        return names[deviceNum] || names[1];
    }
    
    function getDeviceSerial(deviceNum) {
        const serials = {
            1: '71595362',
            2: '67772231',
            3: '73102322'
        };
        return serials[deviceNum] || serials[1];
    }
    
    // Modbus instrument addresses
    let instrumentAddressModbus = 1;
    let instrumentAddressLevelmaster = 31;
    
    // Application settings
    let mediumType = 'Bulk solid';
    let applicationType = 'Bunker (large volume)';
    
    // Track expanded state for Extended Functions and Diagnostics
    let isExtendedFunctionsExpanded = false;
    let isDiagnosticsExpanded = false;
    
    // Measurement type rotation order
    const MEASUREMENT_TYPES = [
        'Percent',
        'Lin. percent',
        'Filling height',
        'Distance',
        'Scaled',
        'Measurement reliability',
        'Electronics temperature',
        'Meas. rate',
        'Current output'
    ];
    
    // Track which measurement type each position is showing (default: 0=Percent, 1=Lin. percent, 2=Filling height)
    let measurementTypeIndex1 = 0; // Left position (Percent)
    let measurementTypeIndex2 = 1; // Middle top (Lin. percent)
    let measurementTypeIndex3 = 2; // Middle bottom (Filling height)
    
    // Function to get value and unit for a measurement type
    function getMeasurementValue(typeIndex) {
        const type = MEASUREMENT_TYPES[typeIndex];
        const placeholderValue = '58.87';
        
        switch(type) {
            case 'Percent':
                return { value: MEASUREMENT_VALUE, unit: MEASUREMENT_UNIT };
            case 'Lin. percent':
                return { value: MEASUREMENT_VALUE, unit: MEASUREMENT_UNIT };
            case 'Filling height':
                return { value: '12.340', unit: 'ft' };
            case 'Distance':
                return { value: '25.250', unit: 'ft' };
            case 'Scaled':
                return { value: '1123', unit: 'kg' };
            case 'Measurement reliability':
                return { value: '15', unit: 'dB' };
            case 'Electronics temperature':
                return { value: '22.1', unit: 'Â°F' };
            case 'Meas. rate':
                return { value: '0.000', unit: 'Hz' };
            case 'Current output':
                return { value: '13.419', unit: 'mA' };
            default:
                return { value: placeholderValue, unit: '' };
        }
    }
    
    // Function to rotate measurement type index
    function rotateMeasurementType(indexVar) {
        return (indexVar + 1) % MEASUREMENT_TYPES.length;
    }
    
    // Function to handle clicking on a measurement value
    function cycleMeasurementType(position) {
        // Check if tutorial has locked distance display - only block position 1
        if (window.tutorialDistanceLocked && position === 1) {
            console.log('Tutorial: Distance is locked, preventing cycling of position 1');
            return; // Don't allow cycling position 1 when distance is locked
        }
        
        // During Step 14 tutorial (ANALOG), only allow tapping position 1 (the green main value)
        // HART and MODBUS allow tapping any position
        if (window.tutorialActive && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps.length > 0) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            if (step && step.clickTarget === 'MEASUREMENT_CYCLED' && window.tutorialSensorType === 'ANALOG' && position !== 1) {
                console.log('Tutorial: Only the green main value (position 1) can be tapped during Step 14');
                return; // Block positions 2 and 3 during Step 14 for ANALOG
            }
        }
        
        // During Step 16 tutorial (ANALOG), only allow tapping position 2 (Lin. percent)
        if (window.tutorialActive && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps.length > 0) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            if (step && step.clickTarget === 'CURRENT_OUTPUT_CYCLED' && window.tutorialSensorType === 'ANALOG' && position !== 2) {
                console.log('Tutorial: Only position 2 (Lin. percent) can be tapped during Step 16');
                return; // Block positions 1 and 3 during Step 16
            }
        }
        
        if (position === 1) {
            measurementTypeIndex1 = rotateMeasurementType(measurementTypeIndex1);
        } else if (position === 2) {
            measurementTypeIndex2 = rotateMeasurementType(measurementTypeIndex2);
        } else if (position === 3) {
            measurementTypeIndex3 = rotateMeasurementType(measurementTypeIndex3);
        }
        
        // Tutorial: Check if Distance is now displayed (Distance is at index 3 in MEASUREMENT_TYPES)
        // Only check position 1 (the green main value) during Step 14
        // CRITICAL: Only advance to Step 15 AFTER distance is selected, locked, and rendered
        if (window.tutorialActive && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps.length > 0) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            
            // Step 14: Check if Distance is shown (for HART, MODBUS, and ANALOG tutorials)
            if (step && step.clickTarget === 'MEASUREMENT_CYCLED') {
                // For ANALOG: only check position 1 (the green main value)
                // For HART and MODBUS: check all positions (user can tap any measurement value)
                const isAnalogTutorial = window.tutorialSensorType === 'ANALOG';
                let isDistanceShown = false;
                
                if (isAnalogTutorial) {
                    // ANALOG: only position 1 can show distance
                    isDistanceShown = measurementTypeIndex1 === 3;
                } else {
                    // HART and MODBUS: check all positions for distance
                    isDistanceShown = measurementTypeIndex1 === 3 || 
                                     measurementTypeIndex2 === 3 || 
                                     measurementTypeIndex3 === 3;
                }
                
                if (isDistanceShown) {
                    console.log('Tutorial: Distance reading is now displayed! Locking positions...');
                    
                    // Lock position(s) showing distance - prevent further cycling
                    window.tutorialDistanceLocked = true;
                    
                    // For ANALOG tutorial, keep positions 2 and 3 unlocked so user can change Lin. percent to Current output
                    // For HART and MODBUS, lock all positions
                    
                    // Disable onclick handlers for positions showing distance (but keep normal appearance)
                    setTimeout(() => {
                        // Always lock position 1 if it shows distance
                        if (measurementTypeIndex1 === 3) {
                            const position1Element = document.querySelector('div[onclick*="cycleMeasurementType(1)"]');
                            if (position1Element) {
                                position1Element.style.pointerEvents = 'none';
                                position1Element.style.cursor = 'default';
                            }
                        }
                        
                        if (isAnalogTutorial) {
                            // For ANALOG: explicitly ensure positions 2 and 3 remain clickable
                            const position2Element = document.querySelector('div[onclick*="cycleMeasurementType(2)"]');
                            const position3Element = document.querySelector('div[onclick*="cycleMeasurementType(3)"]');
                            if (position2Element) {
                                position2Element.style.pointerEvents = '';
                                position2Element.style.cursor = 'pointer';
                            }
                            if (position3Element) {
                                position3Element.style.pointerEvents = '';
                                position3Element.style.cursor = 'pointer';
                            }
                        } else {
                            // For HART and MODBUS: lock all positions
                            const position1Element = document.querySelector('div[onclick*="cycleMeasurementType(1)"]');
                            const position2Element = document.querySelector('div[onclick*="cycleMeasurementType(2)"]');
                            const position3Element = document.querySelector('div[onclick*="cycleMeasurementType(3)"]');
                            if (position1Element) {
                                position1Element.style.pointerEvents = 'none';
                                position1Element.style.cursor = 'default';
                            }
                            if (position2Element) {
                                position2Element.style.pointerEvents = 'none';
                                position2Element.style.cursor = 'default';
                            }
                            if (position3Element) {
                                position3Element.style.pointerEvents = 'none';
                                position3Element.style.cursor = 'default';
                            }
                        }
                    }, 100);
                    
                    // Mark action as complete
                    window.waitingForAction = false;
                    waitingForAction = false;
                    
                    // Render screen first to show distance is locked
                    renderScreen();
                    
                    // CRITICAL: Only advance to Step 15 AFTER distance is confirmed to be selected and locked
                    setTimeout(() => {
                        // Verify distance is still displayed
                        const distanceStillShown = isAnalogTutorial 
                            ? (window.tutorialDistanceLocked && measurementTypeIndex1 === 3)
                            : (window.tutorialDistanceLocked && (measurementTypeIndex1 === 3 || measurementTypeIndex2 === 3 || measurementTypeIndex3 === 3));
                        
                        if (distanceStillShown && window.tutorialActive) {
                            console.log('Tutorial: Distance confirmed selected and locked. Advancing to Step 15 (About Distance Reading)');
                            
                            // Ensure waitingForAction is false and synced
                            window.waitingForAction = false;
                            if (typeof waitingForAction !== 'undefined') {
                                waitingForAction = false;
                            }
                            
                            // Use the proper nextTutorialStep function to advance
                            if (window.nextTutorialStep && typeof window.nextTutorialStep === 'function') {
                                console.log('Tutorial: Calling window.nextTutorialStep()');
                            window.nextTutorialStep();
                            } else if (typeof nextTutorialStep === 'function') {
                                console.log('Tutorial: Calling local nextTutorialStep()');
                                nextTutorialStep();
                            }
                        }
                    }, 300);
                }
            }
            
            // Step 16: Check if Current output is shown in position 2 (for ANALOG tutorial)
            if (step && step.clickTarget === 'CURRENT_OUTPUT_CYCLED' && window.tutorialSensorType === 'ANALOG') {
                // Check if position 2 (top middle) is showing Current output (index 8 in MEASUREMENT_TYPES)
                const currentType = MEASUREMENT_TYPES[measurementTypeIndex2];
                const isCurrentOutputShown = measurementTypeIndex2 === 8 || currentType === 'Current output';
                
                console.log('Tutorial Step 16: Checking for Current output. measurementTypeIndex2:', measurementTypeIndex2, 'currentType:', currentType, 'isCurrentOutputShown:', isCurrentOutputShown);
                
                if (isCurrentOutputShown) {
                    console.log('Tutorial: Current output is now displayed! Advancing to Step 17...');
                    
                    // Remove "Tap!" text when Current output is shown
                    const existingTapText = document.querySelector('.tutorial-tap-text');
                    if (existingTapText) {
                        existingTapText.remove();
                    }
                    window.tutorialTapTextElement = null;
                    
                    // Mark action as complete
                    window.waitingForAction = false;
                    waitingForAction = false;
                    
                    // Advance to Step 17 immediately (don't wait for renderScreen)
                    setTimeout(() => {
                        if (window.tutorialActive) {
                            console.log('Tutorial: Current output confirmed. Calling nextTutorialStep()...');
                            if (window.nextTutorialStep && typeof window.nextTutorialStep === 'function') {
                                window.nextTutorialStep();
                            } else if (typeof nextTutorialStep === 'function') {
                                nextTutorialStep();
                            } else {
                                console.error('Tutorial: nextTutorialStep function not found!');
                            }
                        } else {
                            console.error('Tutorial: Tutorial is not active!');
                        }
                    }, 100);
                    // Still render screen but don't return early - let it render
                }
            }
        }
        
        renderScreen();
    }

    // --- Utility Functions (Icons) ---
    // High-fidelity icons using custom SVGs
    function getIcon(name, classNames = "app-icon") {
        let path = '';
        let colorClass = 'text-gray-700'; 
        let fill = 'none'; 
        let strokeWidth = 2.2;
        let viewBox = '0 0 24 24';

        switch (name) {
            case 'back':
                path = '<path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>';
                strokeWidth = 3;
                break;
            case 'settings': // Top-right icon on Overview - Gear icon (filled gray)
                fill = 'currentColor';
                colorClass = 'text-gray-500';
                path = '<path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>';
                break;
            case 'setup-tools': // Setup icon on Device Home (1000000639.jpg)
                path = '<path d="M12 2l-7 12h14l-7-12z"/><path d="M12 22l-7-12h14l-7 12z" transform="rotate(180 12 12)"/><path d="M4 12h16"/>';
                colorClass = 'text-blue-600';
                break;
            case 'diag-stethoscope': // Diagnostics icon on Device Home
                path = '<path d="M4 14V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v10"/><path d="M10 22h4"/><path d="M12 18v4"/><path d="M15 14h-6"/><path d="M17 12h4"/><path d="M3 12h4"/><circle cx="12" cy="12" r="6"/>';
                colorClass = 'text-orange-500';
                break;
            case 'chevron-right':
                path = '<path d="m9 18 6-6-6-6"/>';
                strokeWidth = 2.5;
                break;
            case 'compass': // Scanning icon
                path = '<path d="M18.8 6.2C15.9 3.5 12 2 12 2S8.1 3.5 5.2 6.2c-2.7 2.6-4.5 6.3-4.2 9.8 0 3.8 2 7 5 7s5-3 5-7c0 3.8 2 7 5 7s5-3 5-7c.3-3.5-1.5-7.2-4.2-9.8z"/><path d="M12 2v7"/><path d="M12 17v5"/><path d="M22 12h-7"/><path d="M9 12h-7"/>';
                break;
            case 'search':
                path = '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>';
                break;
            case 'ruler': // Adjustment icon (1000000641.jpg)
                path = '<path d="M4 14s.5-5 5-5 5 5 5 5"/><path d="M19 14s-.5-5-5-5-5 5-5 5"/><path d="M12 4v16"/><path d="M2 12h20"/>';
                colorClass = 'text-yellow-600';
                break;
            case 'battery': // Application icon (1000000641.jpg)
                path = '<rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><path d="M22 10h-2"/>';
                colorClass = 'text-green-600';
                break;
            case 'zap': // Current output / Adjustment
                path = '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>';
                colorClass = 'text-blue-500';
                break;
            case 'chart': // Damping, Linearization
                path = '<rect x="2" y="2" width="20" height="20" rx="2" ry="2"/><path d="M7 16l4-4 4 4 4-4"/><path d="M10 16h4v-4"/>';
                colorClass = 'text-purple-600';
                break;
            case 'scaling': // Scaling icon
                path = '<line x1="18" x2="6" y1="6" y2="18"/><circle cx="7" cy="7" r="3"/><circle cx="17" cy="17" r="3"/>';
                colorClass = 'text-blue-700';
                break;
            case 'lock': // Access Protection
                path = '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>';
                break;
            case 'false-signal': // False signal suppression
                path = '<path d="M12 2v20"/><path d="M17 12h5"/><path d="M2 12h5"/><path d="M12 7v10"/>';
                colorClass = 'text-red-500';
                break;
            case 'edit': // Edit false signal
                path = '<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>';
                break;
            case 'gear': // Interference behaviour, Mode of operation
                path = '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.5 1.5 0 0 0 1.4-1.5V9.5a1.5 1.5 0 0 0-1.4-1.5l-2.6-.5c-.3-.8-.7-1.5-1.2-2.1L14 3.6a1.5 1.5 0 0 0-2.8 0l-.8 1.4c-.5.6-.9 1.3-1.2 2.1l-2.6.5a1.5 1.5 0 0 0-1.4 1.5v4c0 .8.6 1.5 1.4 1.5l2.6.5c.3.8.7 1.5 1.2 2.1l.8 1.4a1.5 1.5 0 0 0 2.8 0l.8-1.4c.5-.6.9-1.3 1.2-2.1l2.6-.5Z"/>';
                break;
            case 'pvx': // HART variables (Using mock 'PVx' text)
                path = '';
                return `<div class="w-8 h-6 flex items-center justify-center text-xs font-bold text-[#D82A27] bg-white border border-[#D82A27] rounded px-1 py-0 mr-2">PVx</div>`;
                break;
            case 'device-address': // Device address
                path = '<circle cx="12" cy="12" r="2"/><path d="M16 4h2a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-2"/><path d="M8 4H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h2"/><path d="M12 2v20"/>';
                colorClass = 'text-red-600';
                break;
            case 'status': // Status
                path = '<path d="M20 10a5 5 0 0 0-5-5H9a5 5 0 0 0-5 5v2"/><path d="M12 17v5"/><path d="M4 12h16"/><path d="M12 17a3 3 0 0 0 3-3V9a3 3 0 0 0-3-3 3 3 0 0 0-3 3v5a3 3 0 0 0 3 3z"/>';
                colorClass = 'text-green-500';
                break;
            case 'echo-wave': // Echo curve
                path = '<path d="M2 12s.5 4 4 4 3-4 5-4 3 4 5 4 4-4 4-4"/><path d="M2 16h20"/>';
                colorClass = 'text-orange-500';
                break;
            case 'peak-indicator': // Peak indicator
                path = '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>';
                colorClass = 'text-purple-600';
                break;
            case 'measured-values': // Measured values
                path = '<path d="M3 3v18h18"/><path d="M18 17h3"/><path d="M12 12h4"/><path d="M12 7h4"/><path d="M7 17v-4h4v4"/>';
                colorClass = 'text-orange-400';
                break;
            case 'simulation': // Simulation
                path = '<path d="m21.73 18-9-16-9 16z"/><path d="M12 9v4"/><path d="M12 17h.01"/>';
                break;
            case 'info': // Sensor information
                path = '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>';
                break;
            case 'details': // Sensor details
                path = '<path d="M13 10h-2"/><path d="M15 14h-4"/><path d="M12 18h-1"/><path d="M2 3h20v18H2z"/>';
                colorClass = 'text-purple-700';
                break;
            default:
                return '';
        }

        return `<svg xmlns="http://www.w3.org/2000/svg" class="${classNames} ${colorClass} stroke-current" viewBox="${viewBox}" fill="${fill}" stroke-linecap="round" stroke-linejoin="round" stroke-width="${strokeWidth}">${path}</svg>`;
    }

    // Custom SVG for the green filled circle (Orientation Help)
    function getGreenCircleIcon() {
        return `<div class="p-2 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="app-icon fill-current text-green-500" viewBox="0 0 24 24" stroke="none"><circle cx="12" cy="12" r="10"/></svg>
                </div>`;
    }

    // Custom checkmark (1000000639.jpg)
    function getOkCheckmark() {
        return `<div class="w-10 h-10 flex items-center justify-center rounded-full bg-green-500 text-white shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>`;
    }

    // --- Components ---

    function createHeader(title, hasBackButton = true, rightIcon = null, showSubHeader = false) {
        let backButton = hasBackButton ?
            `<button onclick="goBack()" class="p-2 -ml-2 text-white hover:bg-red-700 rounded-full transition duration-150">
                ${getIcon('back', 'app-icon w-6 h-6')}
            </button>` :
            `<div class="w-6 h-6 -ml-2"></div>`; 

        let rightContent = rightIcon ?
            `<div class="p-2 -mr-2 text-white">${getIcon(rightIcon, 'app-icon w-6 h-6')}</div>` :
            `<div class="w-6 h-6 -mr-2"></div>`; 

        let subHeader = showSubHeader ? `
            <div class="sub-header-bar flex justify-between w-full">
                <span class="font-light text-sm tracking-wide">${MEASUREMENT_VALUE}${MEASUREMENT_UNIT}</span>
                <span class="font-light text-xs">${getDeviceTag(selectedDeviceNumber, selectedSensorType)}</span>
            </div>
        ` : '';

        return `
            <div class="sticky top-0 z-10">
                <div class="header-bar px-4">
                    ${backButton}
                    <h1 class="header-title flex-grow text-center">${title}</h1>
                    ${rightContent}
                </div>
                ${subHeader}
            </div>
        `;
    }

    function createListItem(icon, title, subtitle, onClickAction) {
        let iconHtml;
        if (icon === 'green-circle') {
            iconHtml = getGreenCircleIcon();
        } else if (icon === 'pvx') {
            iconHtml = getIcon('pvx');
        } else {
            iconHtml = `<div class="p-2">${getIcon(icon)}</div>`;
        }
        
        const subtitleClass = subtitle ? 'text-xs text-gray-500' : 'hidden';

        return `
            <div onclick="${onClickAction}" 
                 class="list-item flex items-center cursor-pointer hover:bg-gray-100 transition duration-100 bg-white">
                ${iconHtml}
                <div class="flex-grow ml-3">
                    <div class="text-sm font-normal text-gray-800">${title}</div>
                    <div class="${subtitleClass}">${subtitle}</div>
                </div>
                <div class="text-gray-400">${getIcon('chevron-right', 'w-5 h-5')}</div>
            </div>
        `;
    }

    function createDeviceListItem(name, serial, signalStrength, onClickAction) {
        // High fidelity signal strength SVG
        const signalSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20s.01 0 .01 0c.01 0 0 0 0 0h.01a.99.99 0 0 0-.01-1.99V20z" fill="currentColor" stroke="none"/>
                <path d="M14 17a2.5 2.5 0 0 0-4 0v-4a2.5 2.5 0 0 0 4 0v4z" fill="currentColor" stroke="none"/>
                <path d="M16 14a5 5 0 0 0-8 0v-7a5 5 0 0 0 8 0v7z" fill="currentColor" stroke="none"/>
                <path d="M18 11a7.5 7.5 0 0 0-12 0v-10a7.5 7.5 0 0 0 12 0v10z" fill="none"/>
            </svg>
        `;

        const placeholderImg = "https://placehold.co/40x40/f0f0f0/808080?text=S"; 

        return `
            <div onclick="${onClickAction}" 
                 class="list-item flex items-center cursor-pointer hover:bg-gray-100 transition duration-100 bg-white">
                <img src="${placeholderImg}" onerror="this.onerror=null; this.src='https://placehold.co/40x40/f0f0f0/808080?text=S';" 
                     alt="Sensor Icon" class="w-10 h-10 object-contain mr-3 rounded-md">
                <div class="flex-grow">
                    <div class="text-base font-normal text-gray-800">${name}</div>
                    <div class="text-xs text-gray-500">${serial}</div>
                </div>
                <div class="mr-4">${signalSvg}</div>
                <div class="text-gray-400">${getIcon('chevron-right', 'w-5 h-5')}</div>
            </div>
        `;
    }
    
    // --- Screens ---

    function renderOverviewScreen() {
        return `
            ${createHeader('Overview', false, 'settings')}
            
            <!-- Category Header 1 -->
            <div class="px-4 pt-3 pb-1 text-xs font-semibold text-gray-500 bg-white">
                Device adjustment
            </div>

            <!-- List Item: Setup & Diagnosis -->
            <div onclick="goToScreen('DEVICE_LIST')" class="flex items-center p-4 bg-white hover:bg-gray-50 cursor-pointer transition border-b border-gray-100">
                <!-- Icon: Setup & Diagnosis (Three horizontal lines with circles) -->
                <div class="icon-container">
                    <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 100 100" 
                        width="24" 
                        height="24"
                        stroke="#10B981" 
                        stroke-width="5" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"
                        fill="none"
                        class="text-green-600"
                    >
                        <!-- Top Slider -->
                        <line x1="10" y1="20" x2="90" y2="20" />
                        <circle cx="35" cy="20" r="10" fill="white" />

                        <!-- Middle Slider -->
                        <line x1="10" y1="50" x2="90" y2="50" />
                        <circle cx="65" cy="50" r="10" fill="white" />

                        <!-- Bottom Slider -->
                        <line x1="10" y1="80" x2="90" y2="80" />
                        <circle cx="35" cy="80" r="10" fill="white" />
                    </svg>
                </div>
                
                <div class="flex-grow">
                    <p class="text-base font-medium text-gray-800">Setup & Diagnosis</p>
                    <p class="text-sm text-gray-500">Show device data and modify these via Bluetooth</p>
                </div>

                <!-- Forward Arrow -->
                <span class="text-xl font-light text-gray-400">&gt;</span>
            </div>
            
            <!-- List Item: Orientation help -->
            <div onclick="console.log('Orientation help clicked')" class="flex items-center p-4 bg-white hover:bg-gray-50 cursor-pointer transition border-b border-gray-100">
                <!-- Icon: Orientation help (Green circle) -->
                <div class="icon-container">
                    <div class="w-5 h-5 border-2 border-green-500 rounded-full flex items-center justify-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    </div>
                </div>
                
                <div class="flex-grow">
                    <p class="text-base font-medium text-gray-800">Orientation help</p>
                    <p class="text-sm text-gray-500">Tool for optimum orientation of your sensor</p>
                </div>

                <!-- Forward Arrow -->
                <span class="text-xl font-light text-gray-400">&gt;</span>
            </div>
            
            <!-- A large blank space, matching the screenshot -->
            <div class="h-4 bg-gray-100"></div>

            <!-- List Item: Contact -->
            <div onclick="console.log('Contact clicked')" class="flex items-center p-4 bg-white hover:bg-gray-50 cursor-pointer transition border-b border-gray-100">
                <!-- Icon: Contact (Orange phone icon) -->
                <div class="icon-container text-orange-500">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                </div>
                
                <div class="flex-grow">
                    <p class="text-base font-medium text-gray-800">Contact</p>
                    <p class="text-sm text-gray-500">Your contact persons</p>
                </div>

                <!-- Forward Arrow -->
                <span class="text-xl font-light text-gray-400">&gt;</span>
            </div>
        `;
    }

    function renderSensorSelectionScreen() {
        return `
            <div class="bg-white flex-grow">
                <div class="px-4 pt-6 pb-4 text-center">
                    <h1 class="text-2xl font-bold mb-4" style="color: #764ba2; font-size: 32px; margin-bottom: 20px;">CNCR Setup Wizard</h1>
                    <p class="text-base text-gray-600 mb-6" style="color: #666; margin-bottom: 30px; font-size: 16px; line-height: 1.6;">Welcome! Let's configure your CNCR sensor. Please select your sensor type to begin.</p>
                </div>
                
                <div class="sensor-selection">
                    <button class="sensor-btn" onclick="selectedSensorType = 'HART'; startTutorial('HART'); setTimeout(() => goToScreen('OVERVIEW'), 100);">HART Sensor</button>
                    <button class="sensor-btn" onclick="selectedSensorType = 'MODBUS'; startTutorial('MODBUS'); setTimeout(() => goToScreen('OVERVIEW'), 100);">MODBUS Sensor</button>
                    <button class="sensor-btn" onclick="selectedSensorType = 'ANALOG'; startTutorial('ANALOG'); setTimeout(() => goToScreen('OVERVIEW'), 100);">ANALOG Sensor</button>
                </div>
                
                <div class="px-4 py-6 border-t border-gray-200 mt-4">
                    <p class="text-sm text-gray-600 mb-4 text-center" style="color: #666; margin-bottom: 16px; font-size: 14px;">View training recap in text format:</p>
                    <div class="flex flex-col gap-3">
                        <button class="w-full py-2 px-4 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition text-sm" onclick="showTextRecap('HART');">View HART Recap</button>
                        <button class="w-full py-2 px-4 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition text-sm" onclick="showTextRecap('MODBUS');">View MODBUS Recap</button>
                        <button class="w-full py-2 px-4 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition text-sm" onclick="showTextRecap('ANALOG');">View ANALOG Recap</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderDeviceListScreen() {
        // New design matching the provided HTML
        return `
            ${createHeader('Setup & Diagnosis')}
            
            <!-- Bluetooth Devices Header -->
            <div class="px-4 py-3 text-sm flex items-center justify-between text-gray-700 bg-white border-b border-gray-100">
                <span class="font-medium">Bluetooth devices</span>
                <!-- Loading Spinner -->
                <div class="animate-spin h-5 w-5 border-2 border-white border-t-gray-500 rounded-full"></div>
                </div>

            <!-- Filtering/Search Bar -->
            <div class="px-4 pb-2 pt-2 bg-white border-b border-gray-100">
                <div class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                    <!-- Search Icon (Inline SVG) -->
                    <svg class="w-5 h-5 text-gray-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" placeholder="Filtering..." class="flex-grow focus:outline-none text-gray-700 placeholder-gray-500 text-sm">
                </div>
            </div>
            
            <!-- Device List -->
            <div class="flex-grow overflow-y-auto bg-white">
                <!-- Device Item 1 -->
                <div onclick="selectedDeviceNumber = 1; goToScreen('CONNECTING')" class="flex items-center p-4 bg-white hover:bg-gray-50 cursor-pointer transition border-b border-gray-100">
                    <!-- Device Image -->
                    <div class="mr-4 flex-shrink-0 flex items-center justify-center -ml-2" style="width: 48px; height: 64px;">
                        <img src="${getDeviceImage(1)}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/48x64/e5e7eb/4b5563?text=CNCR'" 
                             alt="CNCR Device" 
                             class="object-contain"
                             style="width: 48px; height: 64px; object-fit: contain; display: block;">
            </div>
            
                    <div class="flex-grow min-w-0">
                        <p class="text-base font-semibold text-gray-800">${getDeviceTag(1, selectedSensorType)}</p>
                        <p class="text-sm text-gray-500 truncate">${getDeviceName(1)} (#${getDeviceSerial(1)})</p>
                    </div>

                    <div class="flex items-center space-x-3 text-gray-700 ml-3 flex-shrink-0">
                        <!-- Signal (4 bars) -->
                        <div class="signal-bar-svg">
                            <div class="signal-bar" style="height: 8px;"></div>
                            <div class="signal-bar" style="height: 11px;"></div>
                            <div class="signal-bar" style="height: 14px;"></div>
                            <div class="signal-bar" style="height: 16px;"></div>
                        </div>
                        <!-- Forward Arrow -->
                        <span class="text-xl font-light text-gray-400">&gt;</span>
                    </div>
                </div>

                <!-- Device Item 2 -->
                <div onclick="selectedDeviceNumber = 2; goToScreen('CONNECTING')" class="flex items-center p-4 bg-white hover:bg-gray-50 cursor-pointer transition border-b border-gray-100">
                    <!-- Device Image -->
                    <div class="mr-4 flex-shrink-0 flex items-center justify-center -ml-2" style="width: 48px; height: 64px;">
                        <img src="${getDeviceImage(2)}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/72x96/e5e7eb/4b5563?text=CNCR'" 
                             alt="CNCR Device" 
                             class="object-contain"
                             style="width: 72px; height: 96px; object-fit: contain; display: block; margin-top: -16px;">
                    </div>
                    
                    <div class="flex-grow min-w-0">
                        <p class="text-base font-semibold text-gray-800">${getDeviceTag(2, selectedSensorType)}</p>
                        <p class="text-sm text-gray-500 truncate">${getDeviceName(2)} (#${getDeviceSerial(2)})</p>
                    </div>

                    <div class="flex items-center space-x-3 text-gray-700 ml-3 flex-shrink-0">
                        <!-- Signal (4 bars) -->
                        <div class="signal-bar-svg">
                            <div class="signal-bar" style="height: 8px;"></div>
                            <div class="signal-bar" style="height: 11px;"></div>
                            <div class="signal-bar" style="height: 14px;"></div>
                            <div class="signal-bar" style="height: 16px;"></div>
                        </div>
                        <!-- Forward Arrow -->
                        <span class="text-xl font-light text-gray-400">&gt;</span>
                    </div>
                </div>

                <!-- Device Item 3 -->
                <div onclick="selectedDeviceNumber = 3; goToScreen('CONNECTING')" class="flex items-center p-4 bg-white hover:bg-gray-50 cursor-pointer transition border-b border-gray-100">
                    <!-- Device Image -->
                    <div class="mr-4 flex-shrink-0 flex items-center justify-center -ml-2" style="width: 48px; height: 64px;">
                        <img src="${getDeviceImage(3)}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/72x96/e5e7eb/4b5563?text=CNCR'" 
                             alt="CNCR Device" 
                             class="object-contain"
                             style="width: 72px; height: 96px; object-fit: contain; display: block; margin-top: -16px;">
                    </div>
                    
                    <div class="flex-grow min-w-0">
                        <p class="text-base font-semibold text-gray-800">${getDeviceTag(3, selectedSensorType)}</p>
                        <p class="text-sm text-gray-500 truncate">${getDeviceName(3)} (#${getDeviceSerial(3)})</p>
                    </div>

                    <div class="flex items-center space-x-3 text-gray-700 ml-3 flex-shrink-0">
                        <!-- Signal (4 bars) -->
                        <div class="signal-bar-svg">
                            <div class="signal-bar" style="height: 8px;"></div>
                            <div class="signal-bar" style="height: 11px;"></div>
                            <div class="signal-bar" style="height: 14px;"></div>
                            <div class="signal-bar" style="height: 16px;"></div>
                        </div>
                        <!-- Forward Arrow -->
                        <span class="text-xl font-light text-gray-400">&gt;</span>
                    </div>
                </div>
            </div>

            <!-- Floating Action Button Container (Above the bottom nav) -->
            <div class="p-4 bg-white border-t border-gray-100">
                <button class="w-full bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg shadow-md hover:bg-gray-300 transition uppercase text-sm">
                    Show Demo Devices
                </button>
            </div>
        `;
    }

    function renderConnectingScreen() {
        // 1000000634.jpg
        setTimeout(() => {
            if (currentScreen === 'CONNECTING') {
                goToScreen('ACCESS_CODE', true);
            }
        }, 3000); 

        return `
            ${createHeader('Connection')}
            <div class="flex flex-col items-center justify-center flex-grow text-gray-600 bg-gray-100 min-h-0 py-12">
                <div class="spinner border-4 w-12 h-12" style="border-top: 4px solid #d82a27; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p class="mt-4 text-sm font-medium">Connecting ...</p>
            </div>
        `;
    }

    function renderAccessCodeScreen() {
        // Improved design matching the provided code
        return `
            ${createHeader('Connection')}
            <div class="flex-grow bg-gray-100 min-h-0">
                <div class="px-4 pt-6 pb-6 flex flex-col items-center">
                    <div class="text-sm text-gray-700 mb-5 font-normal text-center" style="color: #444444;">
                        Enter access code for Bluetooth connection
                    </div>

                    <div class="flex items-center justify-center mb-10">
                        <input type="tel" 
                               value="${accessCode}" 
                               id="access-code-input"
                               class="w-30 h-8 px-2 border border-gray-300 bg-white rounded-sm text-base mr-3 text-center"
                               style="width: 120px; height: 34px; box-sizing: border-box;"
                               maxlength="4" 
                               inputmode="numeric" 
                               oninput="accessCode = this.value; if(this.value.length === 4) goToScreen('AUTHENTICATING');" />
                    <button onclick="goToScreen('AUTHENTICATING')"
                                class="w-15 h-8 px-0 bg-gray-300 text-gray-800 border-none cursor-pointer font-medium uppercase text-sm rounded-sm hover:bg-gray-400 transition"
                                style="width: 60px; height: 34px; color: #333333; background-color: #e0e0e0;">
                        OK
                    </button>
                </div>
                
                    <button class="w-full py-4 mb-3 bg-gray-300 text-gray-800 border-none text-center text-sm font-medium uppercase rounded-sm shadow-sm cursor-pointer hover:bg-gray-400 transition"
                            style="padding: 16px; background-color: #e0e0e0; color: #333333; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">
                        WHERE CAN I FIND THE ACCESS CODE?
                    </button>

                    <button class="w-full py-4 mb-3 bg-gray-300 text-gray-800 border-none text-center text-sm font-medium uppercase rounded-sm shadow-sm cursor-pointer hover:bg-gray-400 transition"
                            style="padding: 16px; background-color: #e0e0e0; color: #333333; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">
                        FORGOTTEN YOUR BLUETOOTH ACCESS CODE?
                    </button>
                </div>
            </div>
        `;
    }
    
    function renderAuthenticatingScreen() {
        // 1000000637.jpg
        setTimeout(() => {
            if (currentScreen === 'AUTHENTICATING') {
                goToScreen('DEVICE_HOME', true);
            }
        }, 3000); 

        return `
            ${createHeader('Connection')}
            <div class="flex flex-col items-center justify-center flex-grow text-gray-600 bg-gray-100 min-h-0 py-12">
                <div class="spinner border-4 w-12 h-12" style="border-top: 4px solid #d82a27; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p class="mt-4 text-sm font-medium">Waiting for authentication ...</p>
            </div>
        `;
    }


    // Helper function to render measurement value HTML
    function renderMeasurementValue(position) {
        let measurement, type, index;
        if (position === 1) {
            index = measurementTypeIndex1;
        } else if (position === 2) {
            index = measurementTypeIndex2;
        } else {
            index = measurementTypeIndex3;
        }
        
        measurement = getMeasurementValue(index);
        type = MEASUREMENT_TYPES[index];
        
        if (position === 1 && type === 'Percent') {
            return `
                <div class="main-value">
                    <span class="value-number">${measurement.value}</span>
                    <span class="value-percent-sign">${measurement.unit}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">${type}</div>
            `;
        } else {
            return `
                <p class="text-xl font-bold text-gray-800 leading-tight">${measurement.value} ${measurement.unit}</p>
                <p class="text-xs text-gray-500 leading-tight">${type}</p>
            `;
        }
    }

    function renderDeviceHomeScreen() {
        // Redesigned device home screen
        const measurement1 = getMeasurementValue(measurementTypeIndex1);
        const type1 = MEASUREMENT_TYPES[measurementTypeIndex1];
        const measurement2 = getMeasurementValue(measurementTypeIndex2);
        const type2 = MEASUREMENT_TYPES[measurementTypeIndex2];
        const measurement3 = getMeasurementValue(measurementTypeIndex3);
        const type3 = MEASUREMENT_TYPES[measurementTypeIndex3];
        
        const deviceTag = getDeviceTag(selectedDeviceNumber, selectedSensorType);
        return `
            ${createHeader(deviceTag)}
            <div class="bg-white flex-grow">
                <!-- 1. Device Information Header -->
                <div class="header-section">
                    Device information
                    </div>

                <!-- 2. Device Details Content Area -->
                <div class="p-4">
                    <div class="flex space-x-4 items-start">
                        <!-- Sensor Image -->
                        <div class="flex-shrink-0 w-16 h-24 flex items-center justify-center overflow-hidden">
                            <img src="${getDeviceImage(selectedDeviceNumber)}" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/60x90/e5e7eb/4b5563?text=DEVICE'" 
                                 alt="Device Image" 
                                 class="w-full h-full object-contain">
                        </div>
                        
                        <!-- Text Details -->
                        <div class="flex flex-col space-y-4 pt-1">
                            <!-- Device Name -->
                            <div class="info-block">
                                <p class="text-xs text-gray-500 font-medium">Device name</p>
                                <p class="text-xl font-bold text-gray-800 leading-none">${getDeviceName(selectedDeviceNumber)}</p>
                            </div>
                            <!-- Serial Number -->
                            <div class="info-block">
                                <p class="text-xs text-gray-500 font-medium">Serial number</p>
                                <p class="text-xl font-bold text-gray-800 leading-none">${getDeviceSerial(selectedDeviceNumber)}</p>
                            </div>
                        </div>
                </div>
            </div>
            
                <!-- Horizontal Divider -->
                <div class="divider"></div>

                <!-- 3. Measured Values Section -->
                <div class="p-4 flex justify-between items-start space-x-2">
                    <!-- Left: Primary Value (Position 1) - Always large green format -->
                    <div onclick="cycleMeasurementType(1)" class="text-center flex-1 cursor-pointer left-column-align">
                        <div class="main-value">
                            <span class="value-number">${measurement1.value}</span>
                            <span class="value-unit">${measurement1.unit}</span>
                </div>
                        <div class="text-xs text-gray-500 mt-1">${type1}</div>
                </div>

                    <!-- Middle: Secondary Values -->
                    <div class="flex-1 text-center px-2">
                        <!-- Top Value: Position 2 -->
                        <div onclick="cycleMeasurementType(2)" class="info-block mb-3 measurement-value-block ${(window.tutorialActive && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps[window.currentTutorialStep] && window.tutorialSteps[window.currentTutorialStep].clickTarget === 'MEASUREMENT_CYCLED') ? 'cursor-not-allowed' : 'cursor-pointer'}">
                            <p class="text-xl font-bold text-gray-800 leading-tight">${measurement2.value} ${measurement2.unit}</p>
                            <p class="measurement-label text-gray-500 leading-tight" style="font-size: ${type2.length > 15 ? '0.65rem' : '0.75rem'};">${type2}</p>
                </div>
                        
                        <!-- Bottom Value: Position 3 -->
                        <div onclick="cycleMeasurementType(3)" class="info-block measurement-value-block ${(window.tutorialActive && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps[window.currentTutorialStep] && window.tutorialSteps[window.currentTutorialStep].clickTarget === 'MEASUREMENT_CYCLED') ? 'cursor-not-allowed' : 'cursor-pointer'}">
                            <p class="text-xl font-bold text-gray-800 leading-tight">${measurement3.value} ${measurement3.unit}</p>
                            <p class="measurement-label text-gray-500 leading-tight" style="font-size: ${type3.length > 15 ? '0.65rem' : '0.75rem'};">${type3}</p>
            </div>
                    </div>

                    <!-- Right: OK Status and Checkmark Icon -->
                    <div class="flex-1 text-center cursor-pointer left-column-align">
                        <div class="check-icon-container">
                            &#x2713;
                        </div>
                        <div class="text-sm text-gray-600 mt-1">OK</div>
                    </div>
                </div>
                
                <!-- Instructional Text -->
                <div class="px-4 pt-2 pb-4">
                    <p class="text-sm text-gray-600 leading-relaxed">
                By tapping onto a measured value, you can change the measured value type.
                    </p>
            </div>

                <!-- Horizontal Divider -->
                <div class="divider"></div>

                <!-- 4. Device Adjustment Header -->
                <div class="header-section border-b-0" style="padding-bottom: 0;">
                    Device adjustment
                </div>

                <div class="px-4" style="padding-top: 0.5rem;">
                    
                    <div class="border-t border-gray-200" style="margin-top: 0;">
                        <div onclick="goToScreen('SETUP_MENU')" class="flex items-center py-3 cursor-pointer border-b border-gray-200 hover:bg-gray-50 transition">
                            <div class="menu-icon-container setup-icon-container">
                                <i class="fas fa-cog text-white" style="font-size: 18px;"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-base font-medium text-black m-0" style="font-size: 16px; font-weight: 500;">Setup</p>
                                <p class="text-xs text-gray-400 mt-0.5 m-0" style="font-size: 12px; color: #999; margin: 2px 0 0 0;">Edit sensor parameters and settings</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 ml-2.5" style="font-size: 14px; color: #ccc; margin-left: 10px;"></i>
                        </div>

                        <div onclick="goToScreen('DIAGNOSTICS_MENU')" class="flex items-center py-3 cursor-pointer hover:bg-gray-50 transition">
                            <div class="menu-icon-container diagnostics-icon-container">
                                <i class="fas fa-stethoscope text-white" style="font-size: 18px;"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-base font-medium text-black m-0" style="font-size: 16px; font-weight: 500;">Diagnostics</p>
                                <p class="text-xs text-gray-400 mt-0.5 m-0" style="font-size: 12px; color: #999; margin: 2px 0 0 0;">Display status and diagnosis information</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 ml-2.5" style="font-size: 14px; color: #ccc; margin-left: 10px;"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSetupMenuScreen() {
        const extendedArrow = isExtendedFunctionsExpanded ? '&#8963;' : '&#8964;'; // Up arrow when expanded, down when collapsed
        const diagnosticsArrow = isDiagnosticsExpanded ? '&#8963;' : '&#8964;';
        
        return `
            ${createHeader(getDeviceName(selectedDeviceNumber), true, null, false)}

            <!-- Percentage and Sensor Tag Display -->
            <div class="setup-percentage bg-white flex items-center justify-between px-4" style="gap: 8px;">
                <span style="font-size: 0.9em; flex-shrink: 0;">${MEASUREMENT_VALUE} ${MEASUREMENT_UNIT}</span>
                <span class="flex-1 text-center whitespace-nowrap" style="font-size: 0.85em;">${getDeviceTag(selectedDeviceNumber, selectedSensorType)}</span>
            </div>

            <!-- Main Menu Items -->
            <div class="bg-white">
                <!-- Measurement loop name -->
                <div onclick="console.log('Measurement loop name clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Measurement loop name</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>

                <!-- Application -->
                <div onclick="goToScreen('APPLICATION')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="appGradient" x1="0" y1="14" x2="0" y2="28" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#34D399"/>
                                    <stop offset="1" stop-color="#10B981"/>
                                </linearGradient>
                            </defs>
                            <rect x="7" y="6" width="18" height="20" rx="4" stroke="#047857" stroke-width="2.5" fill="#FFFFFF"/>
                            <rect x="8.5" y="15" width="15" height="9.5" rx="2.5" fill="url(#appGradient)"/>
                            <rect x="13" y="4.5" width="6" height="2" rx="0.5" fill="#047857"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Application</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Units -->
                <div onclick="console.log('Units clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <line x1="7" y1="25" x2="25" y2="7" stroke="#FF9933" stroke-width="3" stroke-linecap="round"/>
                            <text x="5" y="14" font-family="Inter, sans-serif" font-size="14" font-weight="600" fill="#FF9933">m</text>
                            <text x="18" y="27" font-family="Inter, sans-serif" font-size="14" font-weight="600" fill="#FF9933">ft</text>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Units</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>
            
                <!-- Adjustment -->
                <div onclick="goToScreen('ADJUSTMENT')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="#3B82F6" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 1.5L4 14.5H11L9.5 22.5L20 9.5H13L13 1.5Z" stroke="none"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Adjustment</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>
            </div>

            <!-- Extended Functions Header -->
            <div class="setup-section-header" onclick="toggleList('EXTENDED_FUNCTIONS')">
                <span>Extended functions</span>
                <span style="font-size: 1.2em; line-height: 0.5;">${extendedArrow}</span>
            </div>

            <!-- Extended Functions List -->
            ${isExtendedFunctionsExpanded ? (selectedSensorType === 'MODBUS' ? renderModbusExtendedFunctions() : renderHARTExtendedFunctions()) : ''}

            <!-- Diagnostics Header -->
            <div class="setup-section-header" onclick="toggleList('DIAGNOSTICS_MENU')">
                <span>Diagnostics</span>
                <span style="font-size: 1.2em; line-height: 0.5;">${diagnosticsArrow}</span>
            </div>

            <!-- Diagnostics List -->
            ${isDiagnosticsExpanded ? renderDiagnosticsList() : ''}
        `;
    }
    
    function renderHARTExtendedFunctions() {
        return `
            <div class="bg-white">
                <!-- Damping -->
                <div onclick="console.log('Damping clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-purple" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M4 12C6.66667 12 7.33333 17 10 17C12.6667 17 13.3333 7 16 7C18.6667 7 19.3333 12 22 12" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Damping</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Current output -->
                <div onclick="console.log('Current output clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor" class="setup-color-blue" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path d="M13 1.01L14.93 7.03C15.01 7.28 15.22 7.46 15.48 7.46H22.01L10.01 23.01L11.51 14.01C11.59 13.76 11.37 13.56 11.12 13.56H4.01L13 1.01Z"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Current output</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>

                <!-- Linearization -->
                <div onclick="console.log('Linearization clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M4 20H20" stroke="currentColor"/>
                            <path d="M4 16H8V12H12V8H16V4H20" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Linearization</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>

                <!-- Scaling -->
                <div onclick="console.log('Scaling clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" fill="none" stroke-width="1.5"/>
                            <text x="5" y="10" font-size="6" font-weight="bold" fill="#3A90D0">%</text>
                            <text x="14" y="19" font-size="6" font-weight="bold" fill="#3A90D0">kg</text>
                            <line x1="8" y1="17" x2="16" y2="8" stroke="#3A90D0" stroke-width="1.5"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Scaling</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Access protection -->
                <div onclick="console.log('Access protection clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <rect x="4" y="4" width="16" height="16" rx="1" stroke="currentColor"/>
                            <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor"/>
                            <line x1="12" y1="4" x2="12" y2="20" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Access protection</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>
            
                <!-- False signal suppression -->
                <div onclick="console.log('False signal suppression clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M4 20L8 16L12 18L16 14L20 16" stroke="currentColor"/>
                            <path d="M18 10L20 16L16 14" stroke="currentColor"/>
                            <circle cx="20" cy="16" r="1.5" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">False signal suppression</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>

                <!-- Edit false signal -->
                <div onclick="console.log('Edit false signal clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M15 4L20 9L9 20H4V15L15 4Z" stroke="#D22129"/>
                            <path d="M17 6L18.5 7.5" stroke="#D22129"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Edit false signal</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>

                <!-- Interference behaviour -->
                <div onclick="console.log('Interference behaviour clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Interference behaviour</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- HART variables -->
                <div onclick="console.log('HART variables clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-red" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <text x="4" y="16" font-size="14" font-weight="bold" fill="currentColor">PV</text>
                            <text x="14" y="19" font-size="6" font-weight="bold" fill="currentColor">x</text>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">HART variables</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Device address -->
                <div onclick="goToScreen('DEVICE_ADDRESS')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <circle cx="12" cy="6" r="2" fill="currentColor"/>
                            <circle cx="6" cy="18" r="2" fill="currentColor"/>
                            <circle cx="18" cy="18" r="2" fill="currentColor"/>
                            <path d="M12 8V16M16 16L18 16M6 16L8 16" stroke="currentColor"/>
                            <line x1="12" y1="8" x2="6" y2="16" stroke="currentColor"/>
                            <line x1="12" y1="8" x2="18" y2="16" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Device address</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Reset -->
                <div onclick="console.log('Reset clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M12 4V1L16 5L12 9V6C7.58 6 4 9.58 4 14C4 18.42 7.58 22 12 22C16.42 22 20 18.42 20 14H18C18 17.31 15.31 20 12 20C8.69 20 6 17.31 6 14C6 10.69 8.69 8 12 8V4Z" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Reset</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Mode of operation -->
                <div onclick="console.log('Mode of operation clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <circle cx="12" cy="12" r="4" stroke="currentColor"/>
                            <path d="M17.828 6.17188L20.6569 3.34305L21.0003 3.6864L19.5861 5.10065M6.17188 17.828L3.34305 20.6569L3.6864 21.0003L5.10065 19.5861M17.828 17.828L20.6569 20.6569L21.0003 21.0003L19.5861 19.5861M6.17188 6.17188L3.34305 3.34305L3.6864 3.6864L5.10065 5.10065" stroke="currentColor"/>
                            <path d="M12 4V3M12 21V20M20 12H21M3 12H4" stroke="currentColor" stroke-linecap="round"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Mode of operation</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Status signals -->
                <div onclick="console.log('Status signals clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-red" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M3 12H6.5L8.5 7L12.5 17L14.5 12H21" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Status signals</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>
            </div>
        `;
    }
    
    function renderModbusExtendedFunctions() {
        return `
            <div class="bg-white">
                <!-- Damping -->
                <div onclick="console.log('Damping clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-purple" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M4 12C6.66667 12 7.33333 17 10 17C12.6667 17 13.3333 7 16 7C18.6667 7 19.3333 12 22 12" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Damping</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Linearization -->
                <div onclick="console.log('Linearization clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M4 20H20" stroke="currentColor"/>
                            <path d="M4 16H8V12H12V8H16V4H20" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Linearization</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Scaling -->
                <div onclick="console.log('Scaling clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" fill="none" stroke-width="1.5"/>
                            <text x="5" y="10" font-size="6" font-weight="bold" fill="#3A90D0">%</text>
                            <text x="14" y="19" font-size="6" font-weight="bold" fill="#3A90D0">kg</text>
                            <line x1="8" y1="17" x2="16" y2="8" stroke="#3A90D0" stroke-width="1.5"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Scaling</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- RS485 interface -->
                <div onclick="console.log('RS485 interface clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">RS485 interface</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Modbus -->
                <div onclick="console.log('Modbus clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Modbus</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Levelmaster -->
                <div onclick="console.log('Levelmaster clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Levelmaster</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Modbus variables -->
                <div onclick="console.log('Modbus variables clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-red" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <text x="4" y="16" font-size="14" font-weight="bold" fill="currentColor">PV</text>
                            <text x="14" y="19" font-size="6" font-weight="bold" fill="currentColor">x</text>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Modbus variables</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Access protection -->
                <div onclick="console.log('Access protection clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <rect x="4" y="4" width="16" height="16" rx="1" stroke="currentColor"/>
                            <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor"/>
                            <line x1="12" y1="4" x2="12" y2="20" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Access protection</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- False signal suppression -->
                <div onclick="console.log('False signal suppression clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M4 20L8 16L12 18L16 14L20 16" stroke="currentColor"/>
                            <path d="M18 10L20 16L16 14" stroke="currentColor"/>
                            <circle cx="20" cy="16" r="1.5" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">False signal suppression</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Edit false signal -->
                <div onclick="console.log('Edit false signal clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M15 4L20 9L9 20H4V15L15 4Z" stroke="#D22129"/>
                            <path d="M17 6L18.5 7.5" stroke="#D22129"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Edit false signal</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Interference behaviour -->
                <div onclick="console.log('Interference behaviour clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Interference behaviour</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Device address -->
                <div onclick="goToScreen('DEVICE_ADDRESS')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <circle cx="12" cy="6" r="2" fill="currentColor"/>
                            <circle cx="6" cy="18" r="2" fill="currentColor"/>
                            <circle cx="18" cy="18" r="2" fill="currentColor"/>
                            <path d="M12 8V16M16 16L18 16M6 16L8 16" stroke="currentColor"/>
                            <line x1="12" y1="8" x2="6" y2="16" stroke="currentColor"/>
                            <line x1="12" y1="8" x2="18" y2="16" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Device address</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Reset -->
                <div onclick="console.log('Reset clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-dark" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M12 4V1L16 5L12 9V6C7.58 6 4 9.58 4 14C4 18.42 7.58 22 12 22C16.42 22 20 18.42 20 14H18C18 17.31 15.31 20 12 20C8.69 20 6 17.31 6 14C6 10.69 8.69 8 12 8V4Z" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Reset</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Status signals -->
                <div onclick="console.log('Status signals clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" class="setup-color-red" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; stroke-width: 1.5;">
                            <path d="M3 12H6.5L8.5 7L12.5 17L14.5 12H21" stroke="currentColor"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Status signals</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>
            </div>
        `;
    }

    function renderSetupMenuScreen() {
        const extendedArrow = isExtendedFunctionsExpanded ? '&#8963;' : '&#8964;'; // Up arrow when expanded, down when collapsed
        const diagnosticsArrow = isDiagnosticsExpanded ? '&#8963;' : '&#8964;';
        
        return `
            ${createHeader(getDeviceName(selectedDeviceNumber), true, null, false)}

            <!-- Percentage and Sensor Tag Display -->
            <div class="setup-percentage bg-white flex items-center justify-between px-4" style="gap: 8px;">
                <span style="font-size: 0.9em; flex-shrink: 0;">${MEASUREMENT_VALUE} ${MEASUREMENT_UNIT}</span>
                <span class="flex-1 text-center whitespace-nowrap" style="font-size: 0.85em;">${getDeviceTag(selectedDeviceNumber, selectedSensorType)}</span>
            </div>

            <!-- Main Menu Items -->
            <div class="bg-white">
                <!-- Measurement loop name -->
                <div onclick="console.log('Measurement loop name clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#404040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Measurement loop name</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>

                <!-- Application -->
                <div onclick="goToScreen('APPLICATION')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="appGradient" x1="0" y1="14" x2="0" y2="28" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#34D399"/>
                                    <stop offset="1" stop-color="#10B981"/>
                                </linearGradient>
                            </defs>
                            <rect x="7" y="6" width="18" height="20" rx="4" stroke="#047857" stroke-width="2.5" fill="#FFFFFF"/>
                            <rect x="8.5" y="15" width="15" height="9.5" rx="2.5" fill="url(#appGradient)"/>
                            <rect x="13" y="4.5" width="6" height="2" rx="0.5" fill="#047857"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Application</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Units -->
                <div onclick="console.log('Units clicked')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <line x1="7" y1="25" x2="25" y2="7" stroke="#FF9933" stroke-width="3" stroke-linecap="round"/>
                            <text x="5" y="14" font-family="Inter, sans-serif" font-size="14" font-weight="600" fill="#FF9933">m</text>
                            <text x="18" y="27" font-family="Inter, sans-serif" font-size="14" font-weight="600" fill="#FF9933">ft</text>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Units</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>
            
                <!-- Adjustment -->
                <div onclick="goToScreen('ADJUSTMENT')" class="setup-menu-item">
                    <span class="setup-item-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="#3B82F6" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 1.5L4 14.5H11L9.5 22.5L20 9.5H13L13 1.5Z" stroke="none"/>
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Adjustment</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </div>
            </div>

            <!-- Extended Functions Header -->
            <div class="setup-section-header" onclick="toggleList('EXTENDED_FUNCTIONS')">
                <span>Extended functions</span>
                <span style="font-size: 1.2em; line-height: 0.5;">${extendedArrow}</span>
            </div>

            <!-- Extended Functions List -->
            ${isExtendedFunctionsExpanded ? (selectedSensorType === 'MODBUS' ? renderModbusExtendedFunctions() : renderHARTExtendedFunctions()) : ''}

            <!-- Diagnostics Header -->
            <div class="setup-section-header" onclick="toggleList('DIAGNOSTICS_MENU')">
                <span>Diagnostics</span>
                <span style="font-size: 1.2em; line-height: 0.5;">${diagnosticsArrow}</span>
            </div>

            <!-- Diagnostics List -->
            ${isDiagnosticsExpanded ? renderDiagnosticsList() : ''}
        `;
    }

    function renderExtendedFunctionsList() {
        // 1000000649.jpg and 1000000651.jpg
        return `
            <div class="shadow-sm border-t border-gray-200">
                ${createListItem('chart', 'Damping', '', "console.log('Damping clicked')")}
                ${createListItem('zap', 'Current output', '', "console.log('Current output clicked')")}
                ${createListItem('chart', 'Linearization', '', "console.log('Linearization clicked')")}
                ${createListItem('scaling', 'Scaling', '', "console.log('Scaling clicked')")}
                ${createListItem('lock', 'Access protection', '', "console.log('Access protection clicked')")}
                ${createListItem('false-signal', 'False signal suppression', '', "console.log('False signal suppression clicked')")}
                ${createListItem('edit', 'Edit false signal', '', "console.log('Edit false signal clicked')")}
                ${createListItem('gear', 'Interference behaviour', '', "console.log('Interference behaviour clicked')")}
                ${createListItem('pvx', 'HART variables', '', "console.log('HART variables clicked')")}
                ${createListItem('device-address', 'Device address', '', "goToScreen('DEVICE_ADDRESS')")}
                ${createListItem('reset', 'Reset', '', "console.log('Reset clicked')")}
                ${createListItem('gear', 'Mode of operation', '', "console.log('Mode of operation clicked')")}
                ${createListItem('heartbeat', 'Status signals', '', "console.log('Status signals clicked')")}
            </div>
        `;
    }

    function renderDiagnosticsList() {
        return `
            <div class="bg-white">
                <!-- Item 1: Status -->
                <div onclick="console.log('Status clicked')" class="setup-menu-item hover:bg-teal-50 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-teal-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 10l5-5m0 0l5 5m-5-5v14" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 16.5l2 2 2-2M15 11l-3 3-3-3" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 14.5a8 8 0 0116 0" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Status</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Item 2: Echo curve -->
                <div onclick="console.log('Echo curve clicked')" class="setup-menu-item hover:bg-teal-50 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-teal-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18M3 18h18M3 6h18" opacity="0.2"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12c.5-2.5 2-4 4-4s3.5 1.5 4 4 2 4 4 4 3.5-1.5 4-4" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Echo curve</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Item 3: Peak indicator -->
                <div onclick="console.log('Peak indicator clicked')" class="setup-menu-item hover:bg-purple-50 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 12h-1m-2-5v-1" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Peak indicator</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Item 4: Measured values -->
                <div onclick="console.log('Measured values clicked')" class="setup-menu-item hover:bg-orange-50 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 14s1-1 4-1 4 1 4 1" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 14s1-1 4-1 4 1 4 1" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 14h2M21 14h-2" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Measured values</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Item 5: Simulation -->
                <div onclick="console.log('Simulation clicked')" class="setup-menu-item hover:bg-yellow-50 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13l-3 3-3-3m3 3V3" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 19h14a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2z" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Simulation</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Item 6: Sensor information -->
                <div onclick="console.log('Sensor information clicked')" class="setup-menu-item hover:bg-gray-100 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Sensor information</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Item 7: Sensor details -->
                <div onclick="console.log('Sensor details clicked')" class="setup-menu-item hover:bg-indigo-50 transition">
                    <span class="setup-item-icon">
                        <svg class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" opacity="0.4" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 6v.01M7 10v.01M7 14v.01M7 18v.01" />
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        </svg>
                    </span>
                    <span class="setup-menu-item-text">Sensor details</span>
                    <svg class="setup-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                </div>
            </div>
        `;
    }


    function renderApplicationScreen() {
        // Get the appropriate sensor tag based on selected sensor type and device number
        const sensorTag = getDeviceTag(selectedDeviceNumber, selectedSensorType);
        
        // 1000000661.jpg
        return `
            ${createHeader('Application', true, null, false)}
            
            <!-- Status Bar/Quick Info -->
            <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-white">
                <span class="text-sm font-semibold text-gray-700 flex-1">${MEASUREMENT_VALUE} ${MEASUREMENT_UNIT}</span>
                <span class="text-sm text-gray-500 flex-1 text-center whitespace-nowrap">${sensorTag}</span>
                <span class="flex-1"></span>
            </div>
            
            <div class="section-header">Recording of installation conditions</div>
            <div class="p-6 flex justify-center bg-white border-b border-gray-200 mb-4">
                <!-- Simple silo/bunker graphic -->
                <svg width="200" height="180" viewBox="0 0 250 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Sensor -->
                    <rect x="115" y="5" width="20" height="15" fill="#585858"/>
                    <rect x="120" y="20" width="10" height="20" fill="#757575"/>
                    <!-- Bunker Outline (Top-heavy structure from image) -->
                    <path d="M75 40 L175 40 L200 180 L50 180 Z" fill="#eee" stroke="#333" stroke-width="2"/>
                    <!-- Medium / Bulk Solid -->
                    <rect x="50" y="140" width="150" height="40" fill="#a0a0a0"/>
                    <path d="M50 140 L200 140 L180 110 L70 110 Z" fill="#755a42"/>
                    <line x1="70" y1="110" x2="180" y2="110" stroke="#555" stroke-width="2"/>
                </svg>
            </div>
            
            <div class="mt-4 bg-white">
                <button onclick="showModal('MEDIUM_TYPE_MODAL', 'Type of medium', '${mediumType}')" class="w-full text-left p-4 border-t border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                    <div>
                        <p class="text-base font-semibold text-gray-800">Type of medium</p>
                        <p class="text-sm text-gray-500 mt-0.5">${mediumType}</p>
                    </div>
                    <!-- Chevron Right Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button onclick="showModal('APPLICATION_TYPE_MODAL', 'Application', '${applicationType}')" class="w-full text-left p-4 border-t border-b border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                    <div>
                        <p class="text-base font-semibold text-gray-800">Application</p>
                        <p class="text-sm text-gray-500 mt-0.5">${applicationType}</p>
                    </div>
                    <!-- Chevron Right Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>
        `;
    }

    function renderDeviceAddressScreen() {
        // Modbus-specific layout
        if (selectedSensorType === 'MODBUS') {
        return `
                ${createHeader('Device address', true, null, false)}
                
                <!-- Status Bar/Quick Info -->
                <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-white">
                    <span class="text-sm font-semibold text-gray-700 flex-1">${MEASUREMENT_VALUE} ${MEASUREMENT_UNIT}</span>
                    <span class="text-sm text-gray-500 flex-1 text-center whitespace-nowrap">${getDeviceTag(selectedDeviceNumber, selectedSensorType)}</span>
                    <span class="flex-1"></span>
            </div>

                <!-- Subtitle -->
                <div class="px-4 pt-4 pb-2 bg-white">
                    <p class="text-gray-500 text-sm">Setting of the device address</p>
                </div>

                <!-- Images/Icons Row -->
                <div class="flex justify-around items-center px-4 py-4 bg-white border-b border-gray-200">
                    <!-- Device Image -->
                    <div class="w-[150px] h-[150px] flex justify-center items-center">
                        <img src="${getDeviceImage(selectedDeviceNumber)}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/150x150/e5e7eb/4b5563?text=DEVICE'" 
                             alt="Radar Device" 
                             class="w-full h-auto object-contain rounded-lg p-1">
                    </div>

                    <!-- Interactive Dial -->
                    <div class="w-[100px] h-[100px] flex justify-center items-center">
                        <div class="clock-face rounded-full bg-white shadow-lg" id="device-address-dial">
                            <div id="dial-pointer" class="pointer-wrapper" style="transform: rotate(-54deg);"></div>
                        </div>
                    </div>
                </div>

                <!-- Interactive List Items -->
                <div class="mt-4 bg-white">
                    <!-- Item 1: Instrument address Modbus -->
                    <button onclick="showModal('MODBUS_ADDRESS_MODAL', 'Instrument address Modbus', instrumentAddressModbus, '[1 ... 247]')" class="w-full text-left p-4 border-t border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                        <div>
                            <p class="text-base font-semibold text-gray-800">Instrument address Modbus</p>
                            <p class="text-sm text-gray-500 mt-0.5">${instrumentAddressModbus}</p>
                        </div>
                    </button>

                    <!-- Item 2: Instrument address Levelmaster (Non-editable) -->
                    <div class="w-full text-left p-4 border-t border-b border-gray-200 flex justify-between items-center">
                        <div>
                            <p class="text-base font-semibold text-gray-800">Instrument address Levelmaster</p>
                            <p class="text-sm text-gray-500 mt-0.5">${instrumentAddressLevelmaster}</p>
                        </div>
                    </div>
            </div>
        `;
    }
    
        // HART/ANALOG layout (original)
        return `
            ${createHeader('Device address', true, null, false)}
            
            <!-- Status Bar/Quick Info -->
            <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-white">
                <span class="text-sm font-semibold text-gray-700 flex-1">${MEASUREMENT_VALUE} ${MEASUREMENT_UNIT}</span>
                <span class="text-sm text-gray-500 flex-1 text-center">${getDeviceTag(selectedDeviceNumber, selectedSensorType)}</span>
                <span class="flex-1"></span>
            </div>

            <!-- Subtitle -->
            <div class="px-4 pt-4 pb-2 bg-white">
                <p class="text-gray-500 text-sm">Setting of the device address</p>
            </div>

            <!-- Images/Icons Row -->
            <div class="flex justify-around items-center px-4 py-4 bg-white border-b border-gray-200">
                <!-- Device Image -->
                <div class="w-[150px] h-[150px] flex justify-center items-center">
                    <img src="${getDeviceImage(selectedDeviceNumber)}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/150x150/e5e7eb/4b5563?text=DEVICE'" 
                         alt="Radar Device" 
                         class="w-full h-auto object-contain rounded-lg p-1">
                </div>

                <!-- Interactive Dial -->
                <div class="w-[100px] h-[100px] flex justify-center items-center">
                    <div class="clock-face rounded-full bg-white shadow-lg" id="device-address-dial">
                        <div id="dial-pointer" class="pointer-wrapper" style="transform: rotate(-54deg);"></div>
                    </div>
                </div>
            </div>

            <!-- Interactive List Items -->
            <div class="mt-4 bg-white">
                <!-- Item 1: Device address -->
                <button onclick="showModal('DEVICE_ADDRESS_MODAL', 'Device address', deviceAddress, '[0 ... 63]')" class="w-full text-left p-4 border-t border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                    <div>
                        <p class="text-base font-semibold text-gray-800">Device address</p>
                        <p class="text-sm text-gray-500 mt-0.5">${deviceAddress < 10 ? deviceAddress.toString() : deviceAddress.toString().padStart(2, '0')}</p>
                    </div>
                    <!-- Chevron Right Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                </button>

                <!-- Item 2: Loop current mode -->
                <button onclick="console.log('Loop current mode clicked')" class="w-full text-left p-4 border-t border-b border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                    <div>
                        <p class="text-base font-semibold text-gray-800">Loop current mode</p>
                        <p class="text-sm text-gray-500 mt-0.5">${loopCurrentMode}</p>
                    </div>
                    <!-- Chevron Right Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>
        `;
    }
    
    function renderAdjustmentScreen() {
        // Get the appropriate sensor tag based on selected sensor type and device number
        const sensorTag = getDeviceTag(selectedDeviceNumber, selectedSensorType);
        
        // 1000000643.jpg
        return `
            ${createHeader('Adjustment', true, null, false)}
            
            <!-- Status Bar/Quick Info -->
            <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-white">
                <span class="text-sm font-semibold text-gray-700 flex-1">${MEASUREMENT_VALUE} ${MEASUREMENT_UNIT}</span>
                <span class="text-sm text-gray-500 flex-1 text-center whitespace-nowrap">${sensorTag}</span>
                <span class="flex-1"></span>
            </div>
            
            <!-- Tank Diagram -->
            <div class="w-full bg-white">
                <img src="min-max.png" 
                     onerror="this.onerror=null; this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=min-max.png'" 
                     alt="Adjustment Diagram" 
                     class="w-full h-auto object-contain"
                     style="display: block; image-rendering: auto; -ms-interpolation-mode: bicubic; max-width: 100%; margin: 0; padding: 0;">
                    </div>
            
            <div class="mt-4 bg-white">
                <button onclick="showModal('ADJUSTMENT_INPUT', 'Distance A (max. adjustment)', distanceA, '[-98.425 ft ... 98.425 ft]', 'Distance from sensor reference plane to product surface at max. level', 'distanceA')" class="w-full text-left p-4 border-t border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                    <div>
                        <p class="text-base font-semibold text-gray-800">Distance A (max. adjustment)</p>
                        <p class="text-sm text-gray-500 mt-0.5">${distanceA}</p>
                </div>
                    <!-- Chevron Right Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button onclick="showModal('ADJUSTMENT_INPUT', 'Distance B (min. adjustment)', distanceB, '[-98.425 ft ... 98.425 ft]', 'Distance from sensor reference plane to product surface at min. level', 'distanceB')" class="w-full text-left p-4 border-t border-b border-gray-200 hover:bg-gray-50 transition duration-150 flex justify-between items-center">
                    <div>
                        <p class="text-base font-semibold text-gray-800">Distance B (min. adjustment)</p>
                        <p class="text-sm text-gray-500 mt-0.5">${distanceB}</p>
                    </div>
                    <!-- Chevron Right Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>
        `;
    }

    // --- Navigation and State Logic ---

    function goToScreen(newScreen, replaceHistory = false) {
        // Special case for dropdown menus in Setup
        if (newScreen === 'EXTENDED_FUNCTIONS' || newScreen === 'DIAGNOSTICS_MENU') {
            toggleList(newScreen);
            return;
        }

        // Tutorial: Block navigation if tutorial is active and we're on first step (OVERVIEW)
        // This prevents bypassing the lock overlay by clicking quickly
        if (window.tutorialActive && tutorialActive && tutorialSteps && tutorialSteps.length > 0) {
            const currentStep = tutorialSteps[currentTutorialStep];
            if (currentStep && currentStep.screen === 'OVERVIEW' && currentTutorialStep === 0) {
                // If trying to navigate away from OVERVIEW on first step, block it
                if (newScreen !== 'OVERVIEW' && newScreen !== 'SENSOR_SELECTION') {
                    console.log('Tutorial: Blocking navigation - must press Start or Exit Tutorial first');
                    return; // Block navigation
                }
            }
        }

        if (newScreen !== currentScreen) {
            if (!replaceHistory) {
                // Only push if the previous screen wasn't an expanded list state
                if (currentScreen !== 'EXTENDED_FUNCTIONS' && currentScreen !== 'DIAGNOSTICS_MENU') {
                    history.push(currentScreen);
                } else {
                     // If moving from an expanded list, push the SETUP_MENU itself
                     history.push('SETUP_MENU');
                }
            }
            currentScreen = newScreen;
            
            // Create lock overlay immediately when arriving at OVERVIEW if tutorial is active
            // Do this synchronously before renderScreen() to prevent race conditions
            if (newScreen === 'OVERVIEW' && window.tutorialActive && tutorialActive && tutorialSteps && tutorialSteps.length > 0) {
                const firstStep = tutorialSteps[0];
                if (firstStep && firstStep.screen === 'OVERVIEW' && currentTutorialStep === 0) {
                    // Create overlay immediately (synchronously) to prevent bypass
                    // Use requestAnimationFrame to ensure DOM is ready
                    requestAnimationFrame(() => {
                        if (currentScreen === 'OVERVIEW' && tutorialActive) {
                            createTutorialLockOverlay();
                        }
                    });
                }
            }
            
            renderScreen();
        } 
    }
    
    function toggleList(listName) {
        if (listName === 'EXTENDED_FUNCTIONS') {
            const wasExpanded = isExtendedFunctionsExpanded;
            isExtendedFunctionsExpanded = !isExtendedFunctionsExpanded;
            
            console.log('=== toggleList EXTENDED_FUNCTIONS CALLED ===');
            console.log('wasExpanded:', wasExpanded, 'now:', isExtendedFunctionsExpanded);
            
            // Tutorial: ALWAYS try to detect if tutorial is waiting for Extended Functions
            // Check both window properties and local variables
            const tutorialIsActive = window.tutorialActive || tutorialActive;
            console.log('tutorialIsActive:', tutorialIsActive, 'window.tutorialActive:', window.tutorialActive, 'local tutorialActive:', tutorialActive);
            
            if (tutorialIsActive) {
                console.log('Tutorial is active! Checking for Extended Functions step...');
                
                // Get current step - try both window and local
                const currentStepIndex = window.currentTutorialStep !== undefined ? window.currentTutorialStep : currentTutorialStep;
                const steps = window.tutorialSteps || tutorialSteps;
                
                console.log('currentStepIndex:', currentStepIndex, 'steps length:', steps ? steps.length : 0);
                
                if (steps && steps.length > 0 && currentStepIndex !== undefined && currentStepIndex < steps.length) {
                    const step = steps[currentStepIndex];
                    console.log('Current step object:', step);
                    console.log('step.clickTarget:', step ? step.clickTarget : 'none');
                    console.log('step.screen:', step ? step.screen : 'none');
                    
                    // Check if this is the Extended Functions step - be very permissive
                    const isExtendedFunctionsStep = step && step.clickTarget === 'EXTENDED_FUNCTIONS';
                    const isSetupMenuStep = step && step.screen === 'SETUP_MENU';
                    const justExpanded = !wasExpanded && isExtendedFunctionsExpanded;
                    
                    console.log('isExtendedFunctionsStep:', isExtendedFunctionsStep);
                    console.log('isSetupMenuStep:', isSetupMenuStep);
                    console.log('justExpanded:', justExpanded);
                    
                    // If we're on Extended Functions step OR on SETUP_MENU and just expanded, advance
                    if (isExtendedFunctionsStep || (isSetupMenuStep && justExpanded)) {
                        console.log('*** TUTORIAL: Extended Functions DETECTED! Advancing... ***');
                        
                        // Mark action as complete - update ALL variables IMMEDIATELY
                        // Set both BEFORE any async operations
                        waitingForAction = false;
                        window.waitingForAction = false;
                        
                        // Also update currentTutorialStep to ensure we're on the right step
                        if (window.currentTutorialStep !== undefined) {
                            currentTutorialStep = window.currentTutorialStep;
                        }
                        
                        console.log('Set waitingForAction to false. Local:', waitingForAction, 'Window:', window.waitingForAction);
                        console.log('Current step index before advance:', currentTutorialStep, 'window:', window.currentTutorialStep);
                        
                        // Re-render screen to show expanded list
                        renderScreen();
                        
                        // Advance to next step IMMEDIATELY - don't wait
                        // The state is already set, so we can advance right away
                        console.log('Attempting to advance tutorial immediately...');
                        console.log('Before advance - waitingForAction. Local:', waitingForAction, 'Window:', window.waitingForAction);
                        
                        // Double-check waitingForAction is still false (it should be)
                        if (window.waitingForAction) {
                            console.log('WARNING: waitingForAction is true, forcing to false');
                            window.waitingForAction = false;
                            waitingForAction = false;
                        }
                        
                        // Use requestAnimationFrame to ensure DOM is updated, then advance
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                console.log('Calling nextTutorialStep after render...');
                                console.log('waitingForAction at call time. Local:', waitingForAction, 'Window:', window.waitingForAction);
                                
                                // Final check before calling
                                if (window.waitingForAction) {
                                    console.log('FINAL WARNING: waitingForAction is still true, forcing to false');
                                    window.waitingForAction = false;
                                    waitingForAction = false;
                                }
                                
                                // Try window.nextTutorialStep first
                                if (window.tutorialActive && typeof window.nextTutorialStep === 'function') {
                                    console.log('Calling window.nextTutorialStep()...');
                                    window.nextTutorialStep();
                                } 
                                // Fallback to local nextTutorialStep
                                else if (tutorialActive && typeof nextTutorialStep === 'function') {
                                    console.log('Calling local nextTutorialStep()...');
                                    nextTutorialStep();
                                } else {
                                    console.error('ERROR: Cannot call nextTutorialStep - neither window nor local function available');
                                }
                            });
                        });
                    } else {
                        console.log('Tutorial: Conditions not met for Extended Functions step');
                    }
                } else {
                    console.log('Tutorial: No valid step. steps:', steps, 'currentStepIndex:', currentStepIndex);
                }
            } else {
                console.log('Tutorial is not active, skipping detection');
            }
        } else if (listName === 'DIAGNOSTICS_MENU') {
            isDiagnosticsExpanded = !isDiagnosticsExpanded;
        }
        // Ensure we're on the SETUP_MENU screen when toggling
        if (currentScreen !== 'SETUP_MENU') {
            currentScreen = 'SETUP_MENU';
        }
        renderScreen();
    }

    function goBack() {
        // Tutorial: Detect back button click
        if (window.tutorialActive && window.waitingForAction !== undefined && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps.length > 0) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            if (step && (step.clickTarget === 'BACK_TO_SETUP' || step.clickTarget === 'BACK_TO_DEVICE_HOME')) {
                window.waitingForAction = false;
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 200);
            }
        }
        
        const previousScreen = history.pop();
        if (previousScreen) {
            currentScreen = previousScreen;
            renderScreen();
        } else {
            currentScreen = 'SENSOR_SELECTION';
            renderScreen();
        }
    }

    function renderScreen() {
        // Create lock overlay immediately when rendering OVERVIEW if tutorial is active
        // This ensures the overlay is in place before any user interaction can occur
        if (currentScreen === 'OVERVIEW' && window.tutorialActive && tutorialActive && tutorialSteps && tutorialSteps.length > 0) {
            const firstStep = tutorialSteps[0];
            if (firstStep && firstStep.screen === 'OVERVIEW' && currentTutorialStep === 0) {
                // Create overlay synchronously after DOM update
                requestAnimationFrame(() => {
                    if (currentScreen === 'OVERVIEW' && tutorialActive && !window.tutorialLockOverlay) {
                        createTutorialLockOverlay();
                    }
                });
            }
        }
        
        let content = '';
        switch (currentScreen) {
            case 'OVERVIEW':
                content = renderOverviewScreen();
                break;
            case 'SENSOR_SELECTION':
                content = renderSensorSelectionScreen();
                break;
            case 'DEVICE_LIST':
                content = renderDeviceListScreen();
                break;
            case 'CONNECTING':
                content = renderConnectingScreen();
                break;
            case 'ACCESS_CODE':
                content = renderAccessCodeScreen();
                break;
            case 'AUTHENTICATING':
                content = renderAuthenticatingScreen();
                break;
            case 'DEVICE_HOME':
                content = renderDeviceHomeScreen();
                break;
            case 'SETUP_MENU':
            case 'EXTENDED_FUNCTIONS':
            case 'DIAGNOSTICS_MENU':
                content = renderSetupMenuScreen();
                break;
            case 'APPLICATION':
                content = renderApplicationScreen();
                break;
            case 'ADJUSTMENT':
                content = renderAdjustmentScreen();
                break;
            case 'DEVICE_ADDRESS':
                content = renderDeviceAddressScreen();
                break;
            case 'RECAP':
                content = renderRecapScreen();
                break;
            default:
                content = renderOverviewScreen();
        }
        screenView.innerHTML = content;
        
        // Create lock overlay immediately after rendering OVERVIEW if tutorial is active
        // Do this synchronously right after innerHTML to prevent race conditions
        if (currentScreen === 'OVERVIEW' && window.tutorialActive && tutorialActive && tutorialSteps && tutorialSteps.length > 0) {
            const firstStep = tutorialSteps[0];
            if (firstStep && firstStep.screen === 'OVERVIEW' && currentTutorialStep === 0) {
                // Create overlay immediately (synchronously) to prevent bypass
                if (!window.tutorialLockOverlay) {
                    createTutorialLockOverlay();
                }
            }
        }
        
        // Initialize dial if on device address screen
        if (currentScreen === 'DEVICE_ADDRESS') {
            requestAnimationFrame(() => {
                initializeDeviceAddressDial();
            });
        }
        
        // Scroll to top smoothly when navigating to a new screen
        // BUT: Don't scroll for ANALOG tutorial when auto-expanding Extended Functions for ADJUSTMENT step
        const isAnalogAdjustmentExpansion = window.tutorialActive && window.tutorialSensorType === 'ANALOG' && 
                                           currentScreen === 'SETUP_MENU' && isExtendedFunctionsExpanded;
        if (!isAnalogAdjustmentExpansion) {
        // Use requestAnimationFrame to ensure content is rendered before scrolling
        requestAnimationFrame(() => {
            screenView.scrollTo({ top: 0, behavior: 'smooth' });
        }); 
        } 
    }

    function initializeDeviceAddressDial() {
        const clockFace = document.getElementById('device-address-dial');
        const pointer = document.getElementById('dial-pointer');
        
        if (!clockFace || !pointer) {
            return;
        }
        
        // REMOVE ALL CLICK HANDLERS - dial is display only, completely non-interactive
        // Disable pointer events on the entire dial container
        clockFace.style.pointerEvents = 'none';
        clockFace.style.cursor = 'default';
        pointer.style.pointerEvents = 'none';
        pointer.style.cursor = 'default';
        
        // Remove any existing event listeners by cloning and replacing
        const newClockFace = clockFace.cloneNode(false);
        newClockFace.style.pointerEvents = 'none';
        newClockFace.style.cursor = 'default';
        clockFace.parentNode.replaceChild(newClockFace, clockFace);
        
        const newPointer = document.createElement('div');
        newPointer.id = 'dial-pointer';
        newPointer.className = 'pointer-wrapper';
        newPointer.style.transform = 'rotate(-54deg)';
        newPointer.style.pointerEvents = 'none';
        newPointer.style.cursor = 'default';
        newClockFace.appendChild(newPointer);
        
        // Also disable the parent container
        const dialContainer = newClockFace.parentElement;
        if (dialContainer) {
            dialContainer.style.pointerEvents = 'none';
            dialContainer.style.cursor = 'default';
        }
        
        // Set pointer to position 1 immediately with NO animation/transition
        // For number 1: (1 * 360/10) - 90 = 36 - 90 = -54 degrees
        newPointer.style.transition = 'none';
        newPointer.style.transform = 'rotate(-54deg)';
        
        // Clear any existing numbers
        const existingNumbers = newClockFace.querySelectorAll('.dial-number');
        existingNumbers.forEach(el => el.remove());
        
        // Clock dimensions
        const clockSize = 80;
        const center = clockSize / 2;
        // Radius to place the numbers on
        const radius = 32; 
        // Total numbers (0-9)
        const numCount = 10; 

        for (let i = 0; i < numCount; i++) {
            // Calculate the angle for each number
            // (i / numCount) * 360 degrees, with a -90 degree offset to put '0' at the top
            const angleDeg = (i * (360 / numCount)) - 90;
            const angleRad = angleDeg * (Math.PI / 180);

            // Calculate (x, y) coordinates for the number
            const x = center + radius * Math.cos(angleRad);
            const y = center + radius * Math.sin(angleRad);

            // Create the number element
            const numEl = document.createElement('span');
            numEl.classList.add('dial-number');
            numEl.style.left = `${x}px`;
            numEl.style.top = `${y}px`;
            numEl.textContent = i; 
            // REMOVE any click handlers - dial is display only, not interactive
            numEl.style.pointerEvents = 'none';
            numEl.style.cursor = 'default';
            // Remove any onclick handlers
            numEl.removeAttribute('onclick');
            numEl.onclick = null;
            // Prevent any event listeners from being attached
            numEl.addEventListener = function() {}; // Override to prevent listeners
            numEl.attachEvent = function() {}; // For IE compatibility

            newClockFace.appendChild(numEl);

            // Mark number 1 as active (frozen, no interaction)
            if (i === 1) { 
                numEl.classList.add('active');
            }
        }
        
        // Force pointer to stay at position 1 with no transition
        newPointer.style.transition = 'none';
        newPointer.style.transform = 'rotate(-54deg)';
    }

    // --- Modal Logic ---

    function showModal(type, title, currentValue, range = null, description = null, fieldId = null) {
        // For input modals (address and distance), center them instead of bottom-aligned
        const isInputModal = type === 'DEVICE_ADDRESS_MODAL' || type === 'MODBUS_ADDRESS_MODAL' || type === 'ADJUSTMENT_INPUT';
        const modalOverlay = document.getElementById('modal-overlay');
        const modalBox = document.getElementById('modal-box');
        
        if (isInputModal && modalOverlay && modalBox) {
            // Center the modal for input fields
            modalOverlay.classList.remove('items-end');
            modalOverlay.classList.add('items-center');
            modalBox.classList.remove('rounded-t-lg');
            modalBox.classList.add('rounded-lg');
            // Add margin and ensure it's scrollable with keyboard
            modalBox.style.margin = '20px';
            modalBox.style.maxHeight = 'calc(100vh - 40px)';
            // Limit width: full width on mobile, but max 400px on desktop
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                modalBox.style.maxWidth = 'calc(100% - 40px)';
            } else {
                modalBox.style.maxWidth = '400px';
            }
            // Ensure input is visible when keyboard appears
            setTimeout(() => {
                const input = modalBox.querySelector('input[type="number"]');
                if (input) {
                    input.focus();
                    // Scroll input into view after a short delay to account for keyboard
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            }, 100);
        } else if (modalOverlay && modalBox) {
            // Restore bottom alignment for other modals
            modalOverlay.classList.remove('items-center');
            modalOverlay.classList.add('items-end');
            modalBox.classList.remove('rounded-lg');
            modalBox.classList.add('rounded-t-lg');
            modalBox.style.margin = '';
            modalBox.style.maxHeight = '';
        }
        // Tutorial: Smoothly move tooltip to top when modal opens (configuring)
        if (window.tutorialActive && tutorialTooltipElement) {
            // Use requestAnimationFrame for smooth transition
            requestAnimationFrame(() => {
            setTimeout(() => {
                if (tutorialTooltipElement) {
                    tutorialTooltipElement.classList.add('configuring');
                }
                }, 50);
            });
        }
        
        // Tutorial: Auto-advance to input step when DEVICE_ADDRESS_MODAL opens
        if (window.tutorialActive && type === 'DEVICE_ADDRESS_MODAL') {
            const step = tutorialSteps[currentTutorialStep];
            console.log('Tutorial: DEVICE_ADDRESS_MODAL opened. Current step:', step, 'clickTarget:', step?.clickTarget);
            if (step && step.clickTarget === 'DEVICE_ADDRESS_MODAL_OPENED') {
                // Mark action as complete and advance to input step (Step 11b)
                // Wait for tooltip to smoothly move to top before advancing
                console.log('Tutorial: Advancing to Step 11b (input step)');
                waitingForAction = false;
                window.waitingForAction = false;
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 600); // Increased delay to allow smooth transition
            }
        }
        
        // Tutorial: Auto-advance to input step when MODBUS_ADDRESS_MODAL opens
        if (window.tutorialActive && type === 'MODBUS_ADDRESS_MODAL') {
            const step = tutorialSteps[currentTutorialStep];
            console.log('Tutorial: MODBUS_ADDRESS_MODAL opened. Current step:', step, 'clickTarget:', step?.clickTarget);
            if (step && step.clickTarget === 'MODBUS_ADDRESS_OPENED') {
                // Mark action as complete and advance to input step (Step 11b)
                // Wait for tooltip to smoothly move to top before advancing
                console.log('Tutorial: Advancing to Step 11b (input step) for MODBUS');
                waitingForAction = false;
                window.waitingForAction = false;
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 600); // Increased delay to allow smooth transition
            }
        }
        
        // Tutorial: Auto-advance to input step when ADJUSTMENT_INPUT modal opens
        if (window.tutorialActive && type === 'ADJUSTMENT_INPUT') {
            const step = tutorialSteps[currentTutorialStep];
            console.log('Tutorial: ADJUSTMENT_INPUT opened. Current step:', step, 'clickTarget:', step?.clickTarget, 'fieldId:', fieldId);
            if (step && ((fieldId === 'distanceA' && step.clickTarget === 'DISTANCE_A_SET') || 
                         (fieldId === 'distanceB' && step.clickTarget === 'DISTANCE_B_SET'))) {
                // Mark action as complete and advance to input step (Step 10b or 11b)
                console.log('Tutorial: Advancing to input step for', fieldId);
                waitingForAction = false;
                window.waitingForAction = false;
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 600); // Increased delay to allow smooth transition
            }
        }
        
        // Tutorial: Remove highlight and pointer when configuration modal opens
        if (window.tutorialActive) {
            document.querySelectorAll('.tutorial-highlight-inline').forEach(el => {
                el.classList.remove('tutorial-highlight-inline');
            });
            // Fade out pointer quickly when configuration modals open (Application/Type of Medium)
            if (window.tutorialPointerElement) {
                // Fade out quickly
                window.tutorialPointerElement.classList.remove('visible');
                // Remove after fade completes (faster for Application/Type of Medium)
                setTimeout(() => {
                    if (window.tutorialPointerElement) {
                        window.tutorialPointerElement.remove();
                        window.tutorialPointerElement = null;
                    }
                }, 150); // Faster removal for Application/Type of Medium modals
            }
            document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                if (el !== window.tutorialPointerElement) {
                    el.classList.remove('visible');
                    setTimeout(() => el.remove(), 150);
                }
            });
        }
        let modalContent = '';
        
        document.body.style.overflow = 'hidden';

        switch(type) {
            case 'ADJUSTMENT_INPUT':
                // 1000000645.jpg / 1000000647.jpg
                const inputVal = currentValue.replace(/[^0-9.-]/g, ''); // Clean value to show only number
                const unit = currentValue.includes('ft') ? 'ft' : (currentValue.includes('%') ? '%' : '');

                modalContent = `
                    <div class="p-6">
                        <h2 class="text-sm font-medium text-gray-700">${title}</h2>
                        <div class="flex items-center mt-1 border-b-2 border-gray-400">
                            <!-- Input style refined to match image fidelity: large light text -->
                            <input id="modal-input-value" type="number" value="${inputVal}"
                                class="flex-grow text-3xl font-light py-2 focus:outline-none appearance-none"
                                style="width: 0;" inputmode="decimal" />
                            <button onclick="document.getElementById('modal-input-value').value = ''"
                                    class="text-gray-400 hover:text-gray-600 transition duration-150 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                            <span class="text-xl ml-2 text-gray-700">${unit}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">${range}</p>
                        <p class="text-sm text-gray-600 mt-4">${description}</p>
                    </div>
                    
                    <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
                        <button onclick="hideModal()"
                                class="px-4 py-2 text-gray-600 font-medium rounded hover:bg-gray-200 transition duration-150 mr-2">
                            CANCEL
                        </button>
                        <button onclick="updateDistanceValue('${fieldId}', '${unit}')"
                                class="px-4 py-2 text-gray-700 font-medium rounded bg-gray-300 hover:bg-gray-400 transition duration-150">
                            OK
                        </button>
                    </div>
                `;
                break;

            case 'DEVICE_ADDRESS_MODAL':
                // 1000000657.jpg
                modalContent = `
                    <div class="p-6">
                        <h2 class="text-lg font-normal text-gray-800 mb-4">Device address</h2>
                        <div class="flex items-center border-b-2 border-gray-400">
                            <!-- Input style refined to match image fidelity: large light text -->
                            <input id="modal-input-address" type="number" value="${currentValue}"
                                class="flex-grow text-3xl font-light py-2 focus:outline-none appearance-none"
                                style="width: 0;" min="1" max="63" inputmode="numeric" />
                            <!-- Up/Down scroll buttons for digits (between input and X button) -->
                            <div class="flex flex-col mx-2">
                                <button onclick="incrementDeviceAddress()" 
                                        class="text-gray-400 hover:text-gray-600 transition duration-150 p-1"
                                        style="line-height: 1; font-size: 0.75rem;">
                                    â²
                                </button>
                                <button onclick="decrementDeviceAddress()" 
                                        class="text-gray-400 hover:text-gray-600 transition duration-150 p-1"
                                        style="line-height: 1; font-size: 0.75rem;">
                                    â¼
                                </button>
                            </div>
                            <button onclick="document.getElementById('modal-input-address').value = ''"
                                    class="text-gray-400 hover:text-gray-600 transition duration-150 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Set address between 1-63. Address 0 is for Analog 4-20mA sensors only. HART must use a unique address above 0.</p>
                    </div>
                    
                    <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
                        <button onclick="hideModal()"
                                class="px-4 py-2 text-gray-600 font-medium rounded hover:bg-gray-200 transition duration-150 mr-2">
                            CANCEL
                        </button>
                        <button onclick="updateDeviceAddress(); return false;"
                                class="px-4 py-2 text-gray-700 font-medium rounded bg-gray-300 hover:bg-gray-400 transition duration-150">
                            OK
                        </button>
                    </div>
                `;
                break;

            case 'MODBUS_ADDRESS_MODAL':
                modalContent = `
                    <div class="p-6">
                        <h2 class="text-lg font-normal text-gray-800 mb-4">Instrument address Modbus</h2>
                        <div class="flex items-center border-b-2 border-gray-400">
                            <input id="modal-input-modbus-address" type="number" value="${currentValue}"
                                class="flex-grow text-3xl font-light py-2 focus:outline-none appearance-none"
                                style="width: 0;" min="1" max="247" inputmode="numeric" />
                            <!-- Up/Down scroll buttons for digits (between input and X button) -->
                            <div class="flex flex-col mx-2">
                                <button onclick="incrementModbusAddress()" 
                                        class="text-gray-400 hover:text-gray-600 transition duration-150 p-1"
                                        style="line-height: 1; font-size: 0.75rem;">
                                    â²
                                </button>
                                <button onclick="decrementModbusAddress()" 
                                        class="text-gray-400 hover:text-gray-600 transition duration-150 p-1"
                                        style="line-height: 1; font-size: 0.75rem;">
                                    â¼
                                </button>
                            </div>
                            <button onclick="document.getElementById('modal-input-modbus-address').value = ''"
                                    class="text-gray-400 hover:text-gray-600 transition duration-150 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">${range}</p>
                    </div>
                    
                    <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
                        <button onclick="hideModal()"
                                class="px-4 py-2 text-gray-600 font-medium rounded hover:bg-gray-200 transition duration-150 mr-2">
                            CANCEL
                        </button>
                        <button onclick="updateModbusAddress(); return false;"
                                class="px-4 py-2 text-gray-700 font-medium rounded bg-gray-300 hover:bg-gray-400 transition duration-150">
                            OK
                        </button>
                    </div>
                `;
                break;

            case 'LEVELMASTER_ADDRESS_MODAL':
                modalContent = `
                    <div class="p-6">
                        <h2 class="text-lg font-normal text-gray-800 mb-4">Instrument address Levelmaster</h2>
                        <div class="flex items-center border-b-2 border-gray-400">
                            <input id="modal-input-levelmaster-address" type="number" value="${currentValue}"
                                class="flex-grow text-3xl font-light py-2 focus:outline-none appearance-none"
                                style="width: 0;" min="0" max="247" inputmode="numeric" />
                            <button onclick="document.getElementById('modal-input-levelmaster-address').value = ''"
                                    class="text-gray-400 hover:text-gray-600 transition duration-150 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">${range}</p>
                    </div>
                    
                    <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
                        <button onclick="hideModal()"
                                class="px-4 py-2 text-gray-600 font-medium rounded hover:bg-gray-200 transition duration-150 mr-2">
                            CANCEL
                        </button>
                        <button onclick="updateLevelmasterAddress(); return false;"
                                class="px-4 py-2 text-gray-700 font-medium rounded bg-gray-300 hover:bg-gray-400 transition duration-150">
                            OK
                        </button>
                    </div>
                `;
                break;
            
            case 'MEDIUM_TYPE_MODAL':
                // 1000000663.jpg
                modalContent = createSelectionModal(title, [
                    { label: 'Liquids', selected: false },
                    { label: 'Bulk solid', selected: false }
                ], currentValue);
                break;

            case 'APPLICATION_TYPE_MODAL':
                // Show different options based on medium type
                let applicationOptions = [];
                if (mediumType === 'Liquids') {
                    applicationOptions = [
                        { label: 'Storage tank', selected: false },
                        { label: 'Stirred vessel', selected: false },
                        { label: 'Dosing vessel', selected: false },
                        { label: 'Pumping station', selected: false },
                        { label: 'Combined sewer overflow', selected: false },
                        { label: 'Vessel/Collecting basin', selected: false },
                        { label: 'Plastic tank (measurement through tank top)', selected: false },
                        { label: 'Mobile plastic tank (IBC)', selected: false },
                        { label: 'Gauge measurement in waters', selected: false },
                        { label: 'Flow measurement flume/weir', selected: false },
                        { label: 'Demonstration', selected: false }
                    ];
                } else {
                    // Bulk solid options
                    applicationOptions = [
                    { label: 'Vessel form for bulk solids', type: 'header' },
                    { label: 'Silo (tall and narrow)', selected: false },
                    { label: 'Bunker (large volume)', selected: true },
                    { label: 'Heap (point measurement/profile detection)', selected: false },
                    { label: 'Crusher', selected: false },
                    { label: 'Demonstration', selected: false }
                    ];
                }
                modalContent = createSelectionModal(title, applicationOptions, currentValue);
                break;
        }

        modalBox.innerHTML = modalContent;
        modalOverlay.classList.remove('hidden');
    }

    function createSelectionModal(title, options, selectedValue) {
        let optionsHtml = options.map(option => {
            if (option.type === 'header') {
                return `<div class="text-xs text-gray-500 px-6 pt-4 pb-2 font-medium">${option.label}</div>`;
            }
            const isSelected = option.label === selectedValue;
            const selectedClass = isSelected ? 'text-gray-900 font-medium' : 'text-gray-700';
            const checkmark = isSelected ? `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>` : '';
            return `
                <div class="flex justify-between items-center px-6 py-3 cursor-pointer hover:bg-gray-100 border-b border-gray-100" 
                     onclick="updateApplicationChoice('${option.label}', '${title}')">
                    <span class="text-base ${selectedClass}">${option.label}</span>
                    ${checkmark}
                </div>
            `;
        }).join('');

        return `
            <div class="flex flex-col h-full max-h-[85vh]">
                <h2 class="text-lg font-medium text-gray-800 p-6 pb-0">${title}</h2>
                <div class="mt-2 overflow-y-auto flex-grow">
                    ${optionsHtml}
                </div>
                
                <div class="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
                    <button onclick="hideModal()"
                            class="px-4 py-2 text-gray-600 font-medium rounded hover:bg-gray-200 transition duration-150 mr-2">
                        CANCEL
                    </button>
                    <button onclick="hideModal()"
                            class="px-4 py-2 text-gray-700 font-medium rounded bg-gray-300 hover:bg-gray-400 transition duration-150">
                        OK
                    </button>
                </div>
            </div>
        `;
    }

    function hideModal() {
        // Reset modal positioning to default (bottom-aligned) when closing
        const modalOverlay = document.getElementById('modal-overlay');
        const modalBox = document.getElementById('modal-box');
        if (modalOverlay && modalBox) {
            modalOverlay.classList.remove('items-center');
            modalOverlay.classList.add('items-end');
            modalBox.classList.remove('rounded-lg');
            modalBox.classList.add('rounded-t-lg');
            modalBox.style.margin = '';
            modalBox.style.maxHeight = '';
        }
        // Tutorial: Detect OK button click in modal
        // Handle both option selection (via updateApplicationChoice) and OK button click
        // Use window properties for consistency
        if (window.tutorialActive && window.waitingForAction !== undefined && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps.length > 0) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            // Check if modal was actually open (not just closing)
            const wasOpen = !modalOverlay.classList.contains('hidden');
            
            if (wasOpen) {
                // Handle MEDIUM_TYPE_MODAL or APPLICATION_TYPE_MODAL (if OK was clicked without selecting option)
                // Only advance if waitingForAction is still true (meaning option wasn't selected in updateApplicationChoice)
                if (step && (step.clickTarget === 'MEDIUM_TYPE_MODAL' || step.clickTarget === 'APPLICATION_TYPE_MODAL')) {
                    // OK was clicked - advance tutorial (only if option wasn't already selected)
                    // Check if we're still waiting (meaning updateApplicationChoice didn't advance it)
                    if (window.waitingForAction) {
                        window.waitingForAction = false;
                        setTimeout(() => {
                            if (window.tutorialActive && window.nextTutorialStep) {
                                window.nextTutorialStep();
                            }
                        }, 100);
                    }
                }
                // Handle distance steps
                else if (step && (step.clickTarget === 'DISTANCE_A_SET' || step.clickTarget === 'DISTANCE_B_SET')) {
                    // They clicked OK - advance after a short delay
                    setTimeout(() => {
                        if (window.tutorialActive && window.waitingForAction) {
                            window.waitingForAction = false;
                            setTimeout(() => {
                                if (window.tutorialActive && window.nextTutorialStep) {
                                    window.nextTutorialStep();
                                }
                            }, 200);
                        }
                    }, 100);
                }
                // Handle MODBUS_ADDRESS_MODAL - allow closing modal to advance (review step)
                else if (step && (step.selector === '#modal-input-modbus-address' || (step.inputTarget && step.screen === 'DEVICE_ADDRESS' && step.title && step.title.includes('Review Address Value')))) {
                    // This is Step 11b (review step) - allow closing modal to advance tutorial
                    console.log('Tutorial: MODBUS address modal closed, advancing from review step');
                    window.waitingForAction = false;
                    waitingForAction = false;
                    setTimeout(() => {
                        if (window.tutorialActive && window.nextTutorialStep) {
                            console.log('Tutorial: Calling nextTutorialStep after MODBUS modal close');
                            window.nextTutorialStep();
                        }
                    }, 100);
                }
            }
        }
        
        modalOverlay.classList.add('hidden');
        document.body.style.overflow = '';
        
        // Tutorial: When modal closes, remove tooltip from top (step is complete, will advance)
        if (window.tutorialActive && tutorialTooltipElement) {
            // Remove configuring class - tooltip will be removed when step advances
            tutorialTooltipElement.classList.remove('configuring');
        }
    }

    function updateDistanceValue(fieldId, unit) {
        const input = document.getElementById('modal-input-value');
        const inputValue = parseFloat(input.value);
        
        // Tutorial: Detect OK click for Distance A/B - ONLY advance if we're on the INPUT step (10b or 11b)
        if (window.tutorialActive && window.waitingForAction && window.currentTutorialStep !== undefined) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            
            // Only advance if we're on the INPUT step (not the click step)
            const isDistanceAInputStep = (fieldId === 'distanceA' && step && 
                step.selector === '#modal-input-value' && 
                step.title && step.title.includes('Distance A'));
            const isDistanceBInputStep = (fieldId === 'distanceB' && step && 
                step.selector === '#modal-input-value' && 
                step.title && step.title.includes('Distance B'));
            
            if (isDistanceAInputStep || isDistanceBInputStep) {
                console.log('Tutorial: Distance value saved. Field:', fieldId, 'Step:', step?.title);
                window.waitingForAction = false;
                if (typeof waitingForAction !== 'undefined') {
                    waitingForAction = false;
                }
                hideModal();
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 300);
                return; // Exit early to prevent double processing
            }
        }
        
        if (!isNaN(inputValue)) {
            // Format the value with 3 decimal places and add unit
            const formattedValue = inputValue.toFixed(3) + ' ' + unit;
            
            if (fieldId === 'distanceA') {
                distanceA = formattedValue;
            } else if (fieldId === 'distanceB') {
                distanceB = formattedValue;
            }
            
            hideModal();
            
            // Re-render the adjustment screen if we're currently on it
            if (currentScreen === 'ADJUSTMENT') {
                renderScreen();
            }
        } else {
            hideModal();
        }
    }

    function incrementDeviceAddress() {
        const input = document.getElementById('modal-input-address');
        if (!input) {
            return;
        }
        
        let currentValue = parseInt(input.value, 10);
        // Handle empty or NaN values - default to 1 for HART
        if (isNaN(currentValue) || currentValue === 0) {
            currentValue = 1;
        } else if (currentValue < 63) {
            currentValue = currentValue + 1; // Increment by 1 only
        }
        input.value = currentValue.toString();
        // Do NOT trigger input event - user must press OK to save
    }
    
    function decrementDeviceAddress() {
        const input = document.getElementById('modal-input-address');
        if (!input) {
            return;
        }
        
        let currentValue = parseInt(input.value, 10);
        // Handle empty or NaN values - default to 1 for HART
        if (isNaN(currentValue) || currentValue === 0) {
            currentValue = 1;
        } else if (currentValue > 1) {
            currentValue = currentValue - 1; // Decrement by 1 only
        }
        input.value = currentValue.toString();
        // Do NOT trigger input event - user must press OK to save
    }

    function updateDeviceAddress() {
        const input = document.getElementById('modal-input-address');
        if (!input) {
            console.error('Input element not found');
            return;
        }
        
        // Get the value directly from the input
        let inputValue = input.value;
        console.log('Raw input value:', inputValue);
        
        // Handle empty or whitespace-only input
        if (!inputValue || inputValue.trim() === '') {
            console.log('Input is empty, keeping current value:', deviceAddress);
            hideModal();
            return;
        }
        
        // Parse the value
        const newValue = parseInt(inputValue, 10);
        console.log('Parsed value:', newValue);
        
        // Check if parsing resulted in NaN
        if (isNaN(newValue)) {
            console.error('Invalid device address. Must be a number.');
            alert('Please enter a valid number between 1 and 63.');
            return;
        }
        
        // HART addresses must be 1-63 (0 is for Analog 4-20mA sensors only)
        if (newValue >= 1 && newValue <= 63) {
            // Update the global variables
            deviceAddress = newValue;
            
            // HART addresses are 1-63, so set loop current mode to Fixed current (4 mA)
            loopCurrentMode = 'Fixed current (4 mA)';
            
            console.log('Device address updated to:', deviceAddress);
            console.log('Loop current mode updated to:', loopCurrentMode);
            
            // Tutorial: Advance when OK is pressed - address was changed and saved
            // Valid address is between 1-63, so if we got here, address is valid
            if (newValue >= 1 && newValue <= 63) {
                console.log('Tutorial: Valid address saved (', newValue, '), checking if tutorial should advance');
                
                if (window.tutorialActive) {
                    // Get tutorial steps - check both window and local scope
                    const steps = window.tutorialSteps || (typeof tutorialSteps !== 'undefined' ? tutorialSteps : null);
                    const currentStepIndex = window.currentTutorialStep !== undefined ? window.currentTutorialStep : (typeof currentTutorialStep !== 'undefined' ? currentTutorialStep : null);
                    
                    if (steps && currentStepIndex !== null && currentStepIndex < steps.length) {
                        const currentStep = steps[currentStepIndex];
                        console.log('Tutorial: Current step:', currentStep?.title, 'selector:', currentStep?.selector, 'inputTarget:', currentStep?.inputTarget, 'screen:', currentStep?.screen);
                        
                        // Check if this step is waiting for address input - match Step 11b
                        // Step 11b has: screen: 'DEVICE_ADDRESS', selector: '#modal-input-address', inputTarget: true
                        const isAddressInputStep = currentStep && (
                            currentStep.selector === '#modal-input-address' || 
                            (currentStep.inputTarget === true && currentStep.screen === 'DEVICE_ADDRESS')
                        );
                        
                        if (isAddressInputStep) {
                            // Address was changed and saved with valid value (1-63) - advance tutorial
                            console.log('Tutorial: Step matches! Valid address (', newValue, ') saved. Advancing from step:', currentStep.title);
                            window.waitingForAction = false;
                            if (typeof waitingForAction !== 'undefined') {
                                waitingForAction = false;
                            }
            
            // Hide modal first
            hideModal();
                            
                            // Advance immediately after modal closes
                            setTimeout(() => {
                                if (window.tutorialActive && window.nextTutorialStep) {
                                    console.log('Tutorial: Calling nextTutorialStep after address save');
                                    window.nextTutorialStep();
                                }
                                renderScreen();
                            }, 300);
                            return; // Exit early since we handled tutorial advancement
                        } else {
                            console.log('Tutorial: Step does not match address input step. Step selector:', currentStep?.selector, 'inputTarget:', currentStep?.inputTarget, 'screen:', currentStep?.screen);
                        }
                    } else {
                        console.log('Tutorial: Could not find current step. Steps:', steps ? 'exists' : 'null', 'Index:', currentStepIndex);
                    }
                }
            }
            
            // Hide modal (if not already hidden by tutorial logic above)
            if (document.getElementById('modal-overlay') && document.getElementById('modal-overlay').style.display !== 'none') {
                hideModal();
            }
            
            // Force re-render after a brief delay to ensure modal is closed
            setTimeout(() => {
                renderScreen();
            }, 50);
        } else {
            console.error('Invalid device address. Must be between 1 and 63.'); 
            alert('Device address must be between 1 and 63. Address 0 is for Analog 4-20mA sensors only. HART must use a unique address above 0.');
        }
    }

    function incrementModbusAddress() {
        const input = document.getElementById('modal-input-modbus-address');
        if (!input) {
            return;
        }
        
        let currentValue = parseInt(input.value, 10);
        // Handle empty or NaN values - default to 1 for Modbus (valid range is 1-247)
        if (isNaN(currentValue) || currentValue < 1) {
            currentValue = 1;
        }
        if (currentValue < 247) {
            currentValue = currentValue + 1; // Increment by 1 only
            input.value = currentValue.toString();
            // Do NOT trigger input event - user must press OK to save
        }
    }
    
    function decrementModbusAddress() {
        const input = document.getElementById('modal-input-modbus-address');
        if (!input) {
            return;
        }
        
        let currentValue = parseInt(input.value, 10);
        // Handle empty or NaN values - default to 1 for Modbus (valid range is 1-247)
        if (isNaN(currentValue) || currentValue < 1) {
            currentValue = 1;
        }
        if (currentValue > 1) {
            currentValue = currentValue - 1; // Decrement by 1 only
            input.value = currentValue.toString();
            // Do NOT trigger input event - user must press OK to save
        }
    }
    
    function updateModbusAddress() {
        const input = document.getElementById('modal-input-modbus-address');
        if (!input) {
            console.error('Input element not found');
            return;
        }
        
        let inputValue = input.value;
        
        // Handle empty input - default to 1 for Modbus (valid range is 1-247)
        if (!inputValue || inputValue.trim() === '') {
            inputValue = '1';
            input.value = '1';
        }
        
        const newValue = parseInt(inputValue, 10);
        
        if (isNaN(newValue)) {
            alert('Please enter a valid number between 1 and 247.');
            return;
        }
        
        if (newValue >= 1 && newValue <= 247) {
            instrumentAddressModbus = newValue;
            
            // Tutorial: Advance when OK is pressed - this is a review step, so advance even if value unchanged
            if (window.tutorialActive && window.waitingForAction !== undefined && window.currentTutorialStep !== undefined && window.tutorialSteps && window.tutorialSteps.length > 0) {
                const step = window.tutorialSteps[window.currentTutorialStep];
                console.log('Tutorial: updateModbusAddress called. Step:', step, 'selector:', step?.selector, 'inputTarget:', step?.inputTarget, 'screen:', step?.screen);
                // Check if this step is waiting for Modbus address input (Step 11b - review step)
                if (step && (step.selector === '#modal-input-modbus-address' || (step.inputTarget && step.screen === 'DEVICE_ADDRESS'))) {
                    // This is a review step - advance tutorial when OK is pressed (even if value unchanged)
                    console.log('Tutorial: Modbus address reviewed/saved, advancing from step:', step.title);
                    window.waitingForAction = false;
                    waitingForAction = false;
                    // Advance immediately after setting flags
                    setTimeout(() => {
                        if (window.tutorialActive && window.nextTutorialStep) {
                            console.log('Tutorial: Calling nextTutorialStep after Modbus address review/save');
                            window.nextTutorialStep();
                        }
                    }, 100);
                }
            }
            
            hideModal();
            setTimeout(() => {
                renderScreen();
            }, 50);
        } else {
            alert('Instrument address must be between 1 and 247.');
        }
    }

    function updateLevelmasterAddress() {
        const input = document.getElementById('modal-input-levelmaster-address');
        if (!input) {
            console.error('Input element not found');
            return;
        }
        
        let inputValue = input.value;
        
        if (!inputValue || inputValue.trim() === '') {
            hideModal();
            return;
        }
        
        const newValue = parseInt(inputValue, 10);
        
        if (isNaN(newValue)) {
            alert('Please enter a valid number between 0 and 247.');
            return;
        }
        
        if (newValue >= 0 && newValue <= 247) {
            instrumentAddressLevelmaster = newValue;
            hideModal();
            setTimeout(() => {
                renderScreen();
            }, 50);
        } else {
            alert('Instrument address must be between 0 and 247.');
        }
    }

    function updateApplicationChoice(newSelection, title) {
        // Track if we should advance tutorial (declared at function level)
        let shouldAdvanceTutorial = false;
        
        // Update the state based on which setting is being changed
        if (title.includes('medium') || title.includes('Medium')) {
            const oldMediumType = mediumType;
            mediumType = newSelection;
            
            // If medium type changed, reset application type to a default for the new medium
            if (oldMediumType !== newSelection) {
                if (mediumType === 'Liquids') {
                    applicationType = 'Storage tank';
        } else {
                    applicationType = 'Bunker (large volume)';
                }
            }
            
            // Tutorial: Detect medium selection (option was selected) - ADVANCE IMMEDIATELY
            // If tutorial is active and we're on APPLICATION screen selecting medium type, advance
            if (window.tutorialActive && currentScreen === 'APPLICATION') {
                // Always advance if we're selecting medium type during tutorial
                // This ensures selecting "Liquids" or "Bulk solid" counts as completing the step
                console.log('Tutorial: Medium type option selected ("' + newSelection + '"), advancing NOW');
                window.waitingForAction = false;
                // Advance immediately
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 50);
                shouldAdvanceTutorial = true; // Mark so we don't advance twice
            }
        } else if (title.includes('Application') || title.includes('application')) {
            applicationType = newSelection;
            
            // Tutorial: Detect application selection (option was selected) - ADVANCE IMMEDIATELY
            // If tutorial is active and we're on APPLICATION screen selecting application type, advance
            if (window.tutorialActive && currentScreen === 'APPLICATION') {
                // Always advance if we're selecting application type during tutorial
                // This ensures selecting any application option counts as completing the step
                console.log('Tutorial: Application type option selected ("' + newSelection + '"), advancing NOW');
                window.waitingForAction = false;
                // Advance immediately
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 50);
                shouldAdvanceTutorial = true; // Mark so we don't advance twice
            }
        }
        
        // Close the modal and re-render the screen to show the updated value
        hideModal();
        
        // Remove any tutorial pointer and tap text that might be showing (shouldn't be, but clean up just in case)
        if (window.tutorialTapTextElement) {
            window.tutorialTapTextElement.remove();
            window.tutorialTapTextElement = null;
        }
        document.querySelectorAll('.tutorial-tap-text').forEach(el => el.remove());
        if (window.tutorialPointerElement) {
            window.tutorialPointerElement.classList.remove('visible');
            setTimeout(() => {
                if (window.tutorialPointerElement) {
                    window.tutorialPointerElement.remove();
                    window.tutorialPointerElement = null;
                }
            }, 300);
        }
        
        setTimeout(() => {
            renderScreen();
        }, 50);
        // Note: Tutorial advancement happens immediately when option is selected (above)
        // Don't advance again here to avoid double advancement
    }


    // --- Tutorial System (Inline Approach) ---
    let tutorialActive = false;
    let tutorialSteps = [];
    let currentTutorialStep = 0;
    let tutorialSensorType = null;
    let tutorialTooltipElement = null;
    let waitingForAction = false;
    let tutorialLockOverlay = null; // Overlay to block interaction on first step

    // Define tutorial steps for each sensor type
    const TUTORIAL_STEPS = {
        HART: [
            { screen: 'OVERVIEW', selector: null, title: 'Welcome to HART Setup!', message: 'I\'ll guide you through setting up your HART sensor step by step.', action: 'auto', delay: 400 },
            { screen: 'OVERVIEW', selector: 'div[onclick*="DEVICE_LIST"]', title: 'Step 1: Open Setup', message: 'Tap on "Setup & Diagnosis" below to start configuring your sensor.', action: 'wait', clickTarget: 'DEVICE_LIST' },
            { screen: 'DEVICE_LIST', selector: 'div[onclick*="selectedDeviceNumber = 1"][class*="flex items-center"]', title: 'Step 2: Select Your Sensor', message: 'Tap on the first device in the list to connect to it.', action: 'wait', clickTarget: 'DEVICE_SELECTED', autoAdvanceOnScreenChange: true },
            { screen: 'ACCESS_CODE', selector: 'button[onclick*="AUTHENTICATING"]', title: 'Step 3: Enter Code & Tap OK', message: 'Enter the 4-digit access code (e.g., 1234), then tap "OK" to connect.', action: 'wait', clickTarget: 'OK_CLICKED' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="SETUP_MENU"]', title: 'Step 4: Go to Setup Menu', message: 'Now tap "Setup" to configure your sensor settings.', action: 'wait', clickTarget: 'SETUP_MENU' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="APPLICATION"]', title: 'Step 5: Open Application Settings', message: 'Tap "Application" to configure your medium type.', action: 'wait', clickTarget: 'APPLICATION' },
            { screen: 'APPLICATION', selector: 'button[onclick*="MEDIUM_TYPE_MODAL"]', title: 'Step 6: Choose Medium Type', message: 'Tap "Type of medium" and choose either "Liquids" or "Bulk solid".', action: 'wait', clickTarget: 'MEDIUM_TYPE_MODAL' },
            { screen: 'APPLICATION', selector: 'button[onclick*="APPLICATION_TYPE_MODAL"]', title: 'Step 7: Choose Application Type', message: 'Tap "Application" to choose your vessel type. Tip: "Stirred vessel" is most common for Liquids, "Bunker (large volume)" for Bulk solid.', action: 'wait', clickTarget: 'APPLICATION_TYPE_MODAL' },
            { screen: 'APPLICATION', selector: 'button[onclick*="goBack()"]', title: 'Step 8: Return to Setup', message: 'Tap the back arrow to return to Setup menu.', action: 'wait', clickTarget: 'BACK_TO_SETUP' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="toggleList(\'EXTENDED_FUNCTIONS\')"]', title: 'Step 9: Open Extended Functions', message: 'Tap "Extended functions" to access additional settings.', action: 'wait', clickTarget: 'EXTENDED_FUNCTIONS' },
            { screen: 'SETUP_MENU', selector: 'button[onclick*="DEVICE_ADDRESS_MODAL"], div[onclick*="DEVICE_ADDRESS"]', title: 'Step 10: Configure Device Address', message: 'Tap "Device address" to set your HART address.', action: 'wait', clickTarget: 'DEVICE_ADDRESS' },
            { screen: 'DEVICE_ADDRESS', selector: 'button[onclick*="DEVICE_ADDRESS_MODAL"]', title: 'Step 11: Set Device Address', message: 'Tap "Device address" to open the address settings. Then set address between 1-63 using the up/down arrows or type directly. Address 0 is for Analog 4-20mA sensors only. HART must use a unique address above 0.', action: 'wait', clickTarget: 'DEVICE_ADDRESS_MODAL_OPENED' },
            { screen: 'DEVICE_ADDRESS', selector: '#modal-input-address', title: 'Step 11b: Enter Address Value', message: 'Set address between 1-63 using the up/down arrows or type directly. Press OK to save.', action: 'wait', inputTarget: true, nonIntrusive: true },
            { screen: 'DEVICE_ADDRESS', selector: 'button[onclick*="goBack()"]', title: 'Step 12: Return to Setup', message: 'Tap the back arrow to return to Setup menu.', action: 'wait', clickTarget: 'BACK_TO_SETUP' },
            { screen: 'SETUP_MENU', selector: 'button[onclick*="goBack()"]', title: 'Step 13: Return to Device Home', message: 'Tap the back arrow to return to Device Home.', action: 'wait', clickTarget: 'BACK_TO_DEVICE_HOME' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="cycleMeasurementType"]', title: 'Step 14: Find Distance Reading', message: 'Tap on any measurement value to cycle through options. Keep tapping until you see "Distance" displayed.', action: 'wait', clickTarget: 'MEASUREMENT_CYCLED' },
            { screen: 'DEVICE_HOME', selector: null, title: 'Step 15: About Distance Reading', message: 'Distance readings go to BinCloud. Compare the sensor distance reading to a headspace physical measurement using a tape measure or laser.', action: 'auto', delay: 3000 }
        ],
        MODBUS: [
            { screen: 'OVERVIEW', selector: null, title: 'Welcome to MODBUS Setup!', message: 'I\'ll guide you through setting up your MODBUS sensor step by step.', action: 'auto', delay: 400 },
            { screen: 'OVERVIEW', selector: 'div[onclick*="DEVICE_LIST"]', title: 'Step 1: Open Setup', message: 'Tap on "Setup & Diagnosis" below to start configuring your sensor.', action: 'wait', clickTarget: 'DEVICE_LIST' },
            { screen: 'DEVICE_LIST', selector: 'div[onclick*="selectedDeviceNumber = 1"][class*="flex items-center"]', title: 'Step 2: Select Your Sensor', message: 'Tap on the first device in the list to connect to it.', action: 'wait', clickTarget: 'DEVICE_SELECTED', autoAdvanceOnScreenChange: true },
            { screen: 'ACCESS_CODE', selector: 'button[onclick*="AUTHENTICATING"]', title: 'Step 3: Enter Code & Tap OK', message: 'Enter the 4-digit access code (e.g., 1234), then tap "OK" to connect.', action: 'wait', clickTarget: 'OK_CLICKED' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="SETUP_MENU"]', title: 'Step 4: Go to Setup Menu', message: 'Now tap "Setup" to configure your sensor settings.', action: 'wait', clickTarget: 'SETUP_MENU' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="APPLICATION"]', title: 'Step 5: Open Application Settings', message: 'Tap "Application" to configure your medium type.', action: 'wait', clickTarget: 'APPLICATION' },
            { screen: 'APPLICATION', selector: 'button[onclick*="MEDIUM_TYPE_MODAL"]', title: 'Step 6: Choose Medium Type', message: 'Tap "Type of medium" and choose either "Liquids" or "Bulk solid".', action: 'wait', clickTarget: 'MEDIUM_TYPE_MODAL' },
            { screen: 'APPLICATION', selector: 'button[onclick*="APPLICATION_TYPE_MODAL"]', title: 'Step 7: Choose Application Type', message: 'Tap "Application" to choose your vessel type. Tip: "Stirred vessel" is most common for Liquids, "Bunker (large volume)" for Bulk solid.', action: 'wait', clickTarget: 'APPLICATION_TYPE_MODAL' },
            { screen: 'APPLICATION', selector: 'button[onclick*="goBack()"]', title: 'Step 8: Return to Setup', message: 'Tap the back arrow to return to Setup menu.', action: 'wait', clickTarget: 'BACK_TO_SETUP' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="toggleList(\'EXTENDED_FUNCTIONS\')"]', title: 'Step 9: Open Extended Functions', message: 'Tap "Extended functions" to access additional settings.', action: 'wait', clickTarget: 'EXTENDED_FUNCTIONS' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="DEVICE_ADDRESS"]', title: 'Step 10: Configure Modbus Address', message: 'Tap "Device address" to configure your Modbus settings.', action: 'wait', clickTarget: 'DEVICE_ADDRESS' },
            { screen: 'DEVICE_ADDRESS', selector: 'button[onclick*="MODBUS_ADDRESS_MODAL"]', title: 'Step 11: Set Instrument Address', message: 'Tap "Instrument address Modbus" to set the address (1-247). Default is 1.', action: 'wait', clickTarget: 'MODBUS_ADDRESS_OPENED' },
            { screen: 'DEVICE_ADDRESS', selector: '#modal-input-modbus-address', title: 'Step 11b: Review Address Value', message: 'This is where the Modbus Address is set. Ensure the address is unique for all sensors. 1-247 is the valid Modbus Address range. Press OK to continue or type a value between 1-247.', action: 'wait', inputTarget: true, nonIntrusive: true },
            { screen: 'DEVICE_ADDRESS', selector: 'button[onclick*="goBack()"]', title: 'Step 12: Return to Setup', message: 'Tap the back arrow to return to Setup menu.', action: 'wait', clickTarget: 'BACK_TO_SETUP' },
            { screen: 'SETUP_MENU', selector: 'button[onclick*="goBack()"]', title: 'Step 13: Return to Device Home', message: 'Tap the back arrow to return to Device Home.', action: 'wait', clickTarget: 'BACK_TO_DEVICE_HOME' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="cycleMeasurementType"]', title: 'Step 14: Find Distance Reading', message: 'Tap on any measurement value to cycle through options. Keep tapping until you see "Distance" displayed.', action: 'wait', clickTarget: 'MEASUREMENT_CYCLED' },
            { screen: 'DEVICE_HOME', selector: null, title: 'Step 15: About Distance Reading', message: 'Distance readings go to BinCloud. Compare the sensor distance reading to a headspace physical measurement using a tape measure or laser.', action: 'auto', delay: 3000 }
        ],
        ANALOG: [
            { screen: 'OVERVIEW', selector: null, title: 'Welcome to ANALOG Setup!', message: 'I\'ll guide you through setting up your ANALOG sensor step by step.', action: 'auto', delay: 400 },
            { screen: 'OVERVIEW', selector: 'div[onclick*="DEVICE_LIST"]', title: 'Step 1: Open Setup', message: 'Tap on "Setup & Diagnosis" below to start configuring your sensor.', action: 'wait', clickTarget: 'DEVICE_LIST' },
            { screen: 'DEVICE_LIST', selector: 'div[onclick*="selectedDeviceNumber = 1"][class*="flex items-center"]', title: 'Step 2: Select Your Sensor', message: 'Tap on the first device in the list to connect to it.', action: 'wait', clickTarget: 'DEVICE_SELECTED', autoAdvanceOnScreenChange: true },
            { screen: 'ACCESS_CODE', selector: 'button[onclick*="AUTHENTICATING"]', title: 'Step 3: Enter Code & Tap OK', message: 'Enter the 4-digit access code (e.g., 1234), then tap "OK" to connect.', action: 'wait', clickTarget: 'OK_CLICKED' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="SETUP_MENU"]', title: 'Step 4: Go to Setup Menu', message: 'Now tap "Setup" to configure your sensor settings.', action: 'wait', clickTarget: 'SETUP_MENU' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="APPLICATION"]', title: 'Step 5: Open Application Settings', message: 'Tap "Application" to configure your medium type.', action: 'wait', clickTarget: 'APPLICATION' },
            { screen: 'APPLICATION', selector: 'button[onclick*="MEDIUM_TYPE_MODAL"]', title: 'Step 6: Choose Medium Type', message: 'Tap "Type of medium" and choose either "Liquids" or "Bulk solid".', action: 'wait', clickTarget: 'MEDIUM_TYPE_MODAL' },
            { screen: 'APPLICATION', selector: 'button[onclick*="APPLICATION_TYPE_MODAL"]', title: 'Step 7: Choose Application Type', message: 'Tap "Application" to choose your vessel type. Tip: "Stirred vessel" is most common for Liquids, "Bunker (large volume)" for Bulk solid.', action: 'wait', clickTarget: 'APPLICATION_TYPE_MODAL' },
            { screen: 'APPLICATION', selector: 'button[onclick*="goBack()"]', title: 'Step 8: Return to Setup', message: 'Tap the back arrow to return to Setup menu.', action: 'wait', clickTarget: 'BACK_TO_SETUP' },
            { screen: 'SETUP_MENU', selector: 'div[onclick*="ADJUSTMENT"]', title: 'Step 9: Configure Distance Settings', message: 'Tap "Adjustment" to set Distance A (20mA=FULL) and Distance B (4mA=EMPTY) values.', action: 'wait', clickTarget: 'ADJUSTMENT' },
            { screen: 'ADJUSTMENT', selector: 'button[onclick*="Distance A"]', title: 'Step 10: Set Distance A', message: 'Tap "Distance A" to set the 20mA (FULL) value.', action: 'wait', clickTarget: 'DISTANCE_A_SET' },
            { screen: 'ADJUSTMENT', selector: '#modal-input-value', title: 'Step 10b: Enter Distance A Value', message: 'This represents 20 mA, the maximum level. The sensors deadzone for bulk solid is 2 feet. It is recommended Distance A is at least 2 feet. Press OK to save.', action: 'wait', inputTarget: true, nonIntrusive: true },
            { screen: 'ADJUSTMENT', selector: 'button[onclick*="Distance B"]', title: 'Step 11: Set Distance B', message: 'Tap "Distance B" to set the 4mA (EMPTY) value.', action: 'wait', clickTarget: 'DISTANCE_B_SET' },
            { screen: 'ADJUSTMENT', selector: '#modal-input-value', title: 'Step 11b: Enter Distance B Value', message: 'This represents 4 mA, the minimum level. This is either the FULL vessel height, or the distance to the top of the cone. Press OK to save.', action: 'wait', inputTarget: true, nonIntrusive: true },
            { screen: 'ADJUSTMENT', selector: 'button[onclick*="goBack()"]', title: 'Step 12: Return to Setup', message: 'Tap the back arrow to return to Setup menu.', action: 'wait', clickTarget: 'BACK_TO_SETUP' },
            { screen: 'SETUP_MENU', selector: 'button[onclick*="goBack()"]', title: 'Step 13: Return to Device Home', message: 'Tap the back arrow to return to Device Home.', action: 'wait', clickTarget: 'BACK_TO_DEVICE_HOME' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="cycleMeasurementType(1)"]', title: 'Step 14: Reveal Distance Reading', message: 'Tap on the green main measurement value to cycle through options. Keep tapping until you see "Distance" displayed.', action: 'wait', clickTarget: 'MEASUREMENT_CYCLED' },
            { screen: 'DEVICE_HOME', selector: null, title: 'Step 15: About Distance Reading', message: 'The analog current output is scaled on the sensor distance reading. To ensure accuracy, compare the distance reading to a physical tape measure or laser reading.', action: 'wait', clickTarget: 'DISTANCE_EXPLANATION_OK' },
            { screen: 'DEVICE_HOME', selector: 'div[onclick*="cycleMeasurementType(2)"]', title: 'Step 16: Change to Current Output', message: 'Tap on "Lin. percent" (the top middle measurement) to cycle through options. Keep tapping until you see "Current output" displayed.', action: 'wait', clickTarget: 'CURRENT_OUTPUT_CYCLED' },
            { screen: 'DEVICE_HOME', selector: null, title: 'Step 17: About Current Output', message: 'Current output: This is the raw mA output the sensor is sending to BinCloud or your PLC System. Ensure your PLC or BinCloud is scaled properly to the same Distance A and B values set in the adjustment settings.', action: 'auto', delay: 3000 }
        ]
    };

    function startTutorial(sensorType) {
        tutorialActive = true;
        tutorialSensorType = sensorType;
        window.tutorialSensorType = sensorType;
        tutorialSteps = TUTORIAL_STEPS[sensorType] || [];
        currentTutorialStep = 0;
        window.currentTutorialStep = 0;
        waitingForAction = false;
        window.waitingForAction = false;
        
        if (tutorialSteps.length === 0) {
            console.error('No tutorial steps found for sensor type:', sensorType);
            return;
        }
        
        // Clear any existing tooltips before starting
        removeTutorialTooltip();
        
        // Create lock overlay immediately if we're going to OVERVIEW screen
        // This prevents users from bypassing the tutorial by clicking quickly
        const firstStep = tutorialSteps[0];
        if (firstStep && firstStep.screen === 'OVERVIEW') {
            // Create overlay immediately to lock the screen
            setTimeout(() => {
                if (currentScreen === 'OVERVIEW' && tutorialActive) {
                    createTutorialLockOverlay();
                }
            }, 50);
        }
        
        setTimeout(() => {
            showTutorialStep(0);
        }, 100);
    }

    function showTutorialStep(stepIndex) {
        if (stepIndex >= tutorialSteps.length) {
            endTutorial();
            return;
        }
        
        if (!tutorialActive) {
            return;
        }

        const step = tutorialSteps[stepIndex];
        if (!step) {
            console.error('No step found at index:', stepIndex);
            return;
        }
        
        const previousStepIndex = currentTutorialStep;
        currentTutorialStep = stepIndex;
        
        // For ANALOG tutorial: Auto-expand Extended Functions when going to ADJUSTMENT step
        if (tutorialSensorType === 'ANALOG' && step.clickTarget === 'ADJUSTMENT' && !isExtendedFunctionsExpanded) {
            console.log('Tutorial: Auto-expanding Extended Functions for ANALOG ADJUSTMENT step');
            isExtendedFunctionsExpanded = true;
            renderScreen();
            // Wait for render to complete, then show the step
            setTimeout(() => {
                if (tutorialActive && currentTutorialStep === stepIndex) {
                    // Recursively call showTutorialStep to continue with normal flow
                    showTutorialStep(stepIndex);
                }
            }, 150);
            // Return early to let the render complete, then the step will be shown via setTimeout
            return;
        }
        
        // Set waitingForAction based on step action
        // Only preserve false for Extended Functions case (same step, explicitly set to false)
        const isSameStep = previousStepIndex === stepIndex;
        const isExtendedFunctionsCase = isSameStep && 
                                       window.waitingForAction === false && 
                                       step.clickTarget === 'EXTENDED_FUNCTIONS';
        
        if (isExtendedFunctionsCase) {
            // Extended Functions case: keep it false so we can advance
            waitingForAction = false;
        } else {
            // Normal case: always set based on step action
            waitingForAction = step.action === 'wait';
            window.waitingForAction = waitingForAction;
        }

        // Only remove pointer if we're actually showing a step that's on a loading screen
        // Don't remove pointer if we're just transitioning through a loading screen
        const isLoadingScreen = currentScreen === 'AUTHENTICATING' || currentScreen === 'CONNECTING';
        const isStepOnLoadingScreen = step.screen === 'AUTHENTICATING' || step.screen === 'CONNECTING';
        
        if (isLoadingScreen && isStepOnLoadingScreen) {
            // We're actually showing a step on a loading screen - remove pointer
            if (window.tutorialPointerElement) {
                window.tutorialPointerElement.classList.remove('visible');
                setTimeout(() => {
                    if (window.tutorialPointerElement && (currentScreen === 'AUTHENTICATING' || currentScreen === 'CONNECTING')) {
                        window.tutorialPointerElement.remove();
                        window.tutorialPointerElement = null;
                    }
                }, 300);
            }
            document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                el.classList.remove('visible');
                setTimeout(() => {
                    if (currentScreen === 'AUTHENTICATING' || currentScreen === 'CONNECTING') {
                        el.remove();
                    }
                }, 300);
            });
            // Keep existing tooltip or show new one if needed
            if (!tutorialTooltipElement) {
                setTimeout(() => {
                    if (!tutorialActive || document.querySelector('.tutorial-inline-tooltip')) return;
                    const tooltip = createTooltip(step);
                    document.body.appendChild(tooltip);
                    tutorialTooltipElement = tooltip;
                }, 50);
            }
            return;
        }
        
        // If we're on a loading screen but this step is NOT for a loading screen,
        // it means we're transitioning - hide pointer but keep tooltip
        if (isLoadingScreen && !isStepOnLoadingScreen) {
            // Hide pointer on loading screens (even during transition)
            if (window.tutorialPointerElement) {
                window.tutorialPointerElement.classList.remove('visible');
            }
            document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                el.classList.remove('visible');
            });
            // Keep tooltip visible
            if (!tutorialTooltipElement) {
                setTimeout(() => {
                    if (!tutorialActive || document.querySelector('.tutorial-inline-tooltip')) return;
                    const tooltip = createTooltip(step);
                    document.body.appendChild(tooltip);
                    tutorialTooltipElement = tooltip;
                }, 50);
            }
            return;
        }
        
        // If we're coming from a loading screen, make sure pointer is visible again
        // (it might have been faded out but not removed if screen changed quickly)
        if (window.tutorialPointerElement && window.tutorialPointerElement.parentNode) {
            // Pointer still exists, make sure it's visible
            if (!window.tutorialPointerElement.classList.contains('visible')) {
                window.tutorialPointerElement.classList.add('visible');
            }
        }
        
        // Wait for screen to match - but don't keep retrying forever
        if (currentScreen !== step.screen) {
            // If we're transitioning through a loading screen, keep the pointer visible
            // Don't remove it just because the screen doesn't match yet
            if (isLoadingScreen && !isStepOnLoadingScreen) {
                // Keep pointer visible during transition
                if (window.tutorialPointerElement && window.tutorialPointerElement.parentNode) {
                    if (!window.tutorialPointerElement.classList.contains('visible')) {
                        window.tutorialPointerElement.classList.add('visible');
                    }
                }
            }
            setTimeout(() => {
                if (tutorialActive && currentTutorialStep === stepIndex) {
                    showTutorialStep(stepIndex);
                }
            }, 100);
            return;
        }

        // Remove tooltips and highlights, but PRESERVE pointer during any transition
        // The pointer will be updated/repositioned by highlightAndShowTooltip, not removed
        const preservePointerDuringTransition = isLoadingScreen && !isStepOnLoadingScreen;
        
        // Always preserve pointer - let highlightAndShowTooltip handle updating it
        if (currentScreen !== 'AUTHENTICATING' && currentScreen !== 'CONNECTING') {
            // Not on loading screen - remove tooltip/highlights but preserve pointer
            if (tutorialTooltipElement) {
                tutorialTooltipElement.remove();
                tutorialTooltipElement = null;
            }
            document.querySelectorAll('.tutorial-inline-tooltip').forEach(el => el.remove());
            document.querySelectorAll('.tutorial-highlight-inline').forEach(el => {
                el.classList.remove('tutorial-highlight-inline');
            });
            // DON'T remove pointer - let highlightAndShowTooltip update it
        } else {
            // On loading screen - preserve pointer if transitioning
            if (tutorialTooltipElement) {
                tutorialTooltipElement.remove();
                tutorialTooltipElement = null;
            }
            document.querySelectorAll('.tutorial-inline-tooltip').forEach(el => el.remove());
            document.querySelectorAll('.tutorial-highlight-inline').forEach(el => {
                el.classList.remove('tutorial-highlight-inline');
            });
            
            // Only remove pointer if step is FOR a loading screen
            if (isStepOnLoadingScreen && window.tutorialPointerElement) {
                window.tutorialPointerElement.classList.remove('visible');
                setTimeout(() => {
                    if (window.tutorialPointerElement) {
                        window.tutorialPointerElement.remove();
                        window.tutorialPointerElement = null;
                    }
                }, 300);
            }
        }
        
        // Minimal delay for instant response (use custom delay only for first welcome step)
        const delay = (stepIndex === 0 && step.delay) ? step.delay : 50;

        // Small delay to ensure DOM is ready
        setTimeout(() => {
            if (!tutorialActive || currentTutorialStep !== stepIndex) return;
            
            // Don't show pointer/circle on loading screens (but keep tooltip)
            if (currentScreen === 'AUTHENTICATING' || currentScreen === 'CONNECTING') {
                // Remove only pointer/circle
                if (window.tutorialPointerElement) {
                    window.tutorialPointerElement.classList.remove('visible');
                    setTimeout(() => {
                        if (window.tutorialPointerElement) {
                            window.tutorialPointerElement.remove();
                            window.tutorialPointerElement = null;
                        }
                    }, 300);
                }
                document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                    el.classList.remove('visible');
                    setTimeout(() => el.remove(), 300);
                });
                // Continue to show tooltip
            }
            
            // Only remove tooltip/pointer if NOT on loading screens (loading screens handled above)
            if (currentScreen !== 'AUTHENTICATING' && currentScreen !== 'CONNECTING') {
                // Only remove if we're actually going to show a new step (not just refreshing)
                // Check if this is a different step than what's currently showing
                const currentTooltip = document.querySelector('.tutorial-inline-tooltip');
                if (currentTooltip) {
                    // Remove old tooltip but keep pointer if it's for the same element
                    currentTooltip.remove();
                    tutorialTooltipElement = null;
                }
                // Don't remove pointer here - let highlightAndShowTooltip handle it
            }
            
            // Update step indicator
            updateStepIndicator(stepIndex + 1, tutorialSteps.length);

            // Find and display
            if (step.selector) {
                // Device Address needs special handling since it appears after Extended Functions expands
                const isDeviceAddressStep = (step.clickTarget === 'DEVICE_ADDRESS' && step.screen === 'SETUP_MENU') || 
                                           (step.clickTarget === 'DEVICE_ADDRESS_MODAL_OPENED' && step.screen === 'DEVICE_ADDRESS');
                // Modal inputs need special handling since they're inside modals that might not be open yet
                const isModalInputStep = step.selector === '#modal-input-address' || step.selector === '#modal-input-modbus-address';
                // Check if this is a back button step
                const isBackButtonStep = step.clickTarget === 'BACK_TO_SETUP' || step.clickTarget === 'BACK_TO_DEVICE_HOME';
                
                // Try to find element immediately - for Device Address, try both selectors
                let element = null;
                if (isDeviceAddressStep) {
                    // For DEVICE_ADDRESS screen, look for the button on that screen
                    if (step.screen === 'DEVICE_ADDRESS') {
                        // Find the button by its exact parent structure: .mt-4.bg-white
                        const container = document.querySelector('.mt-4.bg-white');
                        if (container) {
                            element = container.querySelector('button[onclick*="DEVICE_ADDRESS_MODAL"]');
                        }
                        
                        // Verify it's correct - must have "Device address" text and not be in tooltip
                        if (element) {
                            const text = (element.textContent || element.innerText || '').trim();
                            const isInTooltip = element.closest('.tutorial-inline-tooltip');
                            const isTutorialBtn = element.classList.contains('btn-skip-inline') || 
                                                 element.classList.contains('btn-next-inline');
                            
                            if (isInTooltip || isTutorialBtn || !text.includes('Device address')) {
                                element = null;
                            }
                        }
                        
                        // Final fallback: search all buttons and find the right one
                        if (!element) {
                            const buttons = document.querySelectorAll('button');
                            for (const btn of buttons) {
                                const txt = (btn.textContent || btn.innerText || '').trim();
                                const onclickStr = btn.onclick ? btn.onclick.toString() : '';
                                if (onclickStr.includes('DEVICE_ADDRESS_MODAL') && 
                                    txt.includes('Device address') &&
                                    !btn.closest('.tutorial-inline-tooltip') &&
                                    !btn.classList.contains('btn-skip-inline') &&
                                    !btn.classList.contains('btn-next-inline')) {
                                    element = btn;
                                    break;
                                }
                            }
                        }
                    } else {
                        // For SETUP_MENU screen - Device address is a div with class "setup-menu-item"
                        // Find the div that has onclick="goToScreen('DEVICE_ADDRESS')" and contains "Device address" text
                        const setupMenuItems = document.querySelectorAll('.setup-menu-item');
                        for (const item of setupMenuItems) {
                            const onclickStr = item.onclick ? item.onclick.toString() : '';
                            const text = (item.textContent || item.innerText || '').trim();
                            if (onclickStr.includes('DEVICE_ADDRESS') && text.includes('Device address')) {
                                element = item;
                                break;
                            }
                        }
                        // Fallback
                        if (!element) {
                            element = document.querySelector('div.setup-menu-item[onclick*="DEVICE_ADDRESS"]') ||
                                     document.querySelector('div[onclick*="goToScreen(\'DEVICE_ADDRESS\')"]');
                        }
                    }
                } else if (isBackButtonStep) {
                    // For back buttons, try multiple selectors - MUST find it
                    element = document.querySelector(step.selector) ||
                             document.querySelector('button[onclick*="goBack()"]') ||
                             document.querySelector('.header-bar button:first-child') ||
                             document.querySelector('button:has(svg)');
                } else if (isModalInputStep) {
                    // For modal inputs, check if modal is open and find the input
                    element = document.querySelector(step.selector);
                } else if (step.clickTarget === 'ADJUSTMENT') {
                    // For ADJUSTMENT step, find the element that navigates to ADJUSTMENT screen
                    // This is inside Extended Functions, so it may need to be expanded first
                    element = document.querySelector('div[onclick*="ADJUSTMENT"].setup-menu-item') ||
                             document.querySelector('div.setup-menu-item[onclick*="goToScreen(\'ADJUSTMENT\')"]') ||
                             document.querySelector(step.selector);
                } else if (step.clickTarget === 'CURRENT_OUTPUT_CYCLED' && window.tutorialSensorType === 'ANALOG') {
                    // For Step 16 (CURRENT_OUTPUT_CYCLED), find position 2 (Lin. percent)
                    element = document.querySelector('div[onclick*="cycleMeasurementType(2)"]');
                } else {
                    element = document.querySelector(step.selector);
                }
                
                if (element) {
                    console.log('Found element immediately for step:', step.title);
                    highlightAndShowTooltip(element, step);
                } else {
                    // Retry with multiple attempts and longer delays for elements that might not be ready
                    // Device Address needs more retries since it appears after Extended Functions expands
                    // Modal inputs need more retries since the modal might not be open yet
                    // Reduce retries for DEVICE_ADDRESS screen to reduce lag
                    let retryCount = 0;
                    const maxRetries = isDeviceAddressStep && step.screen === 'DEVICE_ADDRESS' ? 5 : (isDeviceAddressStep ? 10 : (isModalInputStep ? 10 : 5));
                    const retryDelay = isDeviceAddressStep && step.screen === 'DEVICE_ADDRESS' ? 150 : (isDeviceAddressStep ? 300 : (isModalInputStep ? 300 : 200));
                    
                    const tryFindElement = () => {
                        if (!tutorialActive || currentTutorialStep !== stepIndex) return;
                        if (currentScreen === 'AUTHENTICATING' || currentScreen === 'CONNECTING') {
                            // On loading screen, don't show pointer
                            return;
                        }
                        
                        // Check if this is a back button step
                        const isBackButtonStep = step.clickTarget === 'BACK_TO_SETUP' || step.clickTarget === 'BACK_TO_DEVICE_HOME';
                        
                        // For Device Address, try both selectors
                        if (isDeviceAddressStep) {
                            // For DEVICE_ADDRESS screen, look for the button on that screen
                            if (step.screen === 'DEVICE_ADDRESS') {
                                // Find the button by its exact parent structure: .mt-4.bg-white
                                const container = document.querySelector('.mt-4.bg-white');
                                if (container) {
                                    element = container.querySelector('button[onclick*="DEVICE_ADDRESS_MODAL"]');
                                }
                                
                                // Verify it's correct - must have "Device address" text and not be in tooltip
                                if (element) {
                                    const text = (element.textContent || element.innerText || '').trim();
                                    const isInTooltip = element.closest('.tutorial-inline-tooltip');
                                    const isTutorialBtn = element.classList.contains('btn-skip-inline') || 
                                                         element.classList.contains('btn-next-inline');
                                    
                                    if (isInTooltip || isTutorialBtn || !text.includes('Device address')) {
                                        element = null;
                                    }
                                }
                                
                                // Final fallback: search all buttons and find the right one
                                if (!element) {
                                    const buttons = document.querySelectorAll('button');
                                    for (const btn of buttons) {
                                        const txt = (btn.textContent || btn.innerText || '').trim();
                                        const onclickStr = btn.onclick ? btn.onclick.toString() : '';
                                        if (onclickStr.includes('DEVICE_ADDRESS_MODAL') && 
                                            txt.includes('Device address') &&
                                            !btn.closest('.tutorial-inline-tooltip') &&
                                            !btn.classList.contains('btn-skip-inline') &&
                                            !btn.classList.contains('btn-next-inline')) {
                                            element = btn;
                                            break;
                                        }
                                    }
                                }
                            } else {
                                // For SETUP_MENU screen - Device address is a div with class "setup-menu-item"
                                // Find the div that has onclick="goToScreen('DEVICE_ADDRESS')" and contains "Device address" text
                                const setupMenuItems = document.querySelectorAll('.setup-menu-item');
                                for (const item of setupMenuItems) {
                                    const onclickStr = item.onclick ? item.onclick.toString() : '';
                                    const text = (item.textContent || item.innerText || '').trim();
                                    if (onclickStr.includes('DEVICE_ADDRESS') && text.includes('Device address')) {
                                        element = item;
                                        break;
                                    }
                                }
                                // Fallback
                                if (!element) {
                                    element = document.querySelector('div.setup-menu-item[onclick*="DEVICE_ADDRESS"]') ||
                                             document.querySelector('div[onclick*="goToScreen(\'DEVICE_ADDRESS\')"]');
                                }
                            }
                        } else if (isBackButtonStep) {
                            // For back buttons, use the step selector directly, then try alternatives
                            // MUST find the back button - try header bar first
                            element = document.querySelector('.header-bar button:first-child') ||
                                     document.querySelector(step.selector) ||
                                     document.querySelector('button[onclick*="goBack()"]') ||
                                     document.querySelector('button[onclick*="goBack"]') ||
                                     document.querySelector('.header-bar button');
                        } else if (isModalInputStep) {
                            // For modal inputs, check if modal is open and find the input
                            element = document.querySelector(step.selector);
                        } else {
                            element = document.querySelector(step.selector);
                        }
                        
                        if (element) {
                            console.log('Found element for step:', step.title, 'element:', element);
                            highlightAndShowTooltip(element, step);
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            console.log('Retrying to find element for step:', step.title, 'retry:', retryCount);
                            setTimeout(tryFindElement, retryDelay);
                        } else {
                            // Element not found after retries
                            // For back buttons, try multiple times with different selectors
                            if (isBackButtonStep) {
                                let backButtonRetries = 0;
                                const findBackButton = () => {
                                    // Try header bar first - back button is always the first button in header
                                    element = document.querySelector('.header-bar button:first-child') ||
                                             document.querySelector('.header-bar button') ||
                                             document.querySelector(step.selector) ||
                                             document.querySelector('button[onclick*="goBack()"]') ||
                                             document.querySelector('button[onclick*="goBack"]');
                                    if (element && element.onclick && element.onclick.toString().includes('goBack')) {
                                        console.log('Found back button:', element);
                                        highlightAndShowTooltip(element, step);
                                    } else if (element) {
                                        // Found a button, verify it's the back button by checking if it's in header
                                        const isInHeader = element.closest('.header-bar');
                                        if (isInHeader) {
                                            console.log('Found back button in header:', element);
                                            highlightAndShowTooltip(element, step);
                                        } else if (backButtonRetries < 10) {
                                            element = null;
                                            backButtonRetries++;
                                            setTimeout(findBackButton, 100);
                                        } else {
                                            console.warn('Back button not found for step:', step.title);
                                            showCenterTooltip(step);
                                        }
                                    } else if (backButtonRetries < 10) {
                                        backButtonRetries++;
                                        setTimeout(findBackButton, 100);
                                    } else {
                                        console.warn('Back button not found for step:', step.title);
                                        showCenterTooltip(step);
                                    }
                                };
                                setTimeout(findBackButton, 100);
                            } else {
                            console.warn('Element not found for selector:', step.selector, 'after', maxRetries, 'retries');
                            showCenterTooltip(step);
                            }
                        }
                    };
                    
                    setTimeout(tryFindElement, retryDelay);
                }
            } else {
                // Check if this is the first step (welcome) on OVERVIEW screen - add lock overlay
                const isFirstStepOnOverview = stepIndex === 0 && currentScreen === 'OVERVIEW';
                if (isFirstStepOnOverview) {
                    // Create lock overlay to block interaction
                    createTutorialLockOverlay();
                } else {
                    // Remove overlay if we're past the first step
                    removeTutorialLockOverlay();
                }
                
                // Step 15 (About Distance Reading) should be positioned below Distance element
                if (step.title && step.title.includes('Step 15') && step.title.includes('Distance Reading')) {
                    // Remove "Tap!" text when Step 15 is shown (distance has been selected) or Step 17 (current output shown)
                    if (window.tutorialTapTextElement && window.tutorialTapTextElement.parentNode) {
                        window.tutorialTapTextElement.style.opacity = '0';
                        window.tutorialTapTextElement.style.transition = 'opacity 0.3s ease-out';
                        setTimeout(() => {
                            if (window.tutorialTapTextElement) {
                                window.tutorialTapTextElement.remove();
                                window.tutorialTapTextElement = null;
                            }
                        }, 300);
                    }
                    document.querySelectorAll('.tutorial-tap-text').forEach(el => {
                        el.style.opacity = '0';
                        el.style.transition = 'opacity 0.3s ease-out';
                        setTimeout(() => el.remove(), 300);
                    });
                    
                    const distanceElement = findDistanceElement();
                    if (distanceElement) {
                        showTooltipBelowDistance(distanceElement, step);
            } else {
                showCenterTooltip(step);
                    }
                } else if (step.title && step.title.includes('Step 17') && step.title.includes('Current Output')) {
                    // Step 17 (About Current Output) should be positioned below Current output element
                    // Remove "Tap!" text when Step 17 is shown
                    if (window.tutorialTapTextElement && window.tutorialTapTextElement.parentNode) {
                        window.tutorialTapTextElement.style.opacity = '0';
                        window.tutorialTapTextElement.style.transition = 'opacity 0.3s ease-out';
                        setTimeout(() => {
                            if (window.tutorialTapTextElement) {
                                window.tutorialTapTextElement.remove();
                                window.tutorialTapTextElement = null;
                            }
                        }, 300);
                    }
                    document.querySelectorAll('.tutorial-tap-text').forEach(el => {
                        el.style.opacity = '0';
                        el.style.transition = 'opacity 0.3s ease-out';
                        setTimeout(() => el.remove(), 300);
                    });
                    
                    const currentOutputElement = findCurrentOutputElement();
                    if (currentOutputElement) {
                        showTooltipBelowCurrentOutput(currentOutputElement, step);
                    } else {
                        showCenterTooltip(step);
                    }
                } else {
                    showCenterTooltip(step);
                }
            }
        }, delay);
    }

    function highlightAndShowTooltip(element, step) {
        // Check if we should preserve pointer during transition
        const isLoadingScreen = currentScreen === 'AUTHENTICATING' || currentScreen === 'CONNECTING';
        const isStepOnLoadingScreen = step.screen === 'AUTHENTICATING' || step.screen === 'CONNECTING';
        const preservePointer = isLoadingScreen && !isStepOnLoadingScreen;
        
        // Check if modal is open (only move to top when modal is actually open)
        const isModalOpen = document.getElementById('modal-overlay') && !document.getElementById('modal-overlay').classList.contains('hidden');
        
        // For Step 11b (modal input), smoothly transition existing tooltip instead of removing/recreating
        const isStep11b = step.selector === '#modal-input-address' || step.selector === '#modal-input-modbus-address';
        const isModalOpenForStep11b = isModalOpen && isStep11b;
        
        // Only remove tooltip if NOT transitioning to Step 11b (to avoid flashing)
        if (tutorialTooltipElement && !isModalOpenForStep11b) {
            tutorialTooltipElement.remove();
            tutorialTooltipElement = null;
        }
        // Only remove other tooltips if not transitioning to Step 11b
        if (!isModalOpenForStep11b) {
            document.querySelectorAll('.tutorial-inline-tooltip').forEach(el => {
                if (el !== tutorialTooltipElement) el.remove();
            });
        }
        
        // Remove highlights from previous elements
        document.querySelectorAll('.tutorial-highlight-inline').forEach(el => {
            el.classList.remove('tutorial-highlight-inline');
        });
        
        // Always try to update/reuse existing pointer instead of removing it
        // Only remove if we're on a loading screen and this step is NOT for a loading screen
        // (meaning we're transitioning away from a loading screen)
        if (preservePointer && window.tutorialPointerElement && window.tutorialPointerElement.parentNode) {
            // Pointer will be updated in place below, don't remove it
        } else {
            // For normal transitions, keep the pointer and update it
            // Only remove if we're transitioning FROM a loading screen TO a non-loading screen
            // and the pointer is pointing to something on the loading screen
            // (This case is rare - usually we just update the pointer position)
            
            // Remove any duplicate pointers
            document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                if (el !== window.tutorialPointerElement) {
                    el.classList.remove('visible');
                    setTimeout(() => el.remove(), 300);
                }
            });
            
            // Keep the existing pointer - it will be updated below
        }
        
        // For non-intrusive steps, don't highlight or add pointer - just show tooltip
        // EXCEPT for back buttons - they should always have pointers
        const isBackButtonStep = step.clickTarget === 'BACK_TO_SETUP' || step.clickTarget === 'BACK_TO_DEVICE_HOME';
        
        if (step.nonIntrusive && !isBackButtonStep) {
            // Scroll element into view gently
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Create and show tooltip only (no highlight, no pointer)
            setTimeout(() => {
                if (!tutorialActive) return;
                
                // For Step 11b, update existing tooltip smoothly instead of creating new one
                if (isModalOpenForStep11b && tutorialTooltipElement && tutorialTooltipElement.parentNode) {
                    // Update existing tooltip content and smoothly move to top
                    const existingTooltip = tutorialTooltipElement;
                    const newContent = createTooltip(step);
                    existingTooltip.innerHTML = newContent.innerHTML;
                    existingTooltip.className = 'tutorial-inline-tooltip visible configuring';
                    // Ensure it's visible and at top
                    if (!existingTooltip.classList.contains('visible')) {
                        existingTooltip.classList.add('visible');
                    }
                    if (!existingTooltip.classList.contains('configuring')) {
                        existingTooltip.classList.add('configuring');
                    }
                } else {
                    // Create new tooltip for other steps
                    if (document.querySelector('.tutorial-inline-tooltip')) return;
                const tooltip = createTooltip(step);
                // Move to top ONLY if modal is open
                if (isModalOpen) {
                    tooltip.classList.add('configuring');
                }
                document.body.appendChild(tooltip);
                tutorialTooltipElement = tooltip;
                    // Smooth fade-in - add visible class after a tiny delay
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            if (tooltip.parentNode) {
                                tooltip.classList.add('visible');
                            }
                        }, 10);
                    });
                }
            }, 50);
        } else {
            // Normal intrusive mode - highlight and point (but not on loading screens)
            element.classList.add('tutorial-highlight-inline');
            // For Device Address step, scroll to center to ensure it's visible after Extended Functions expands
            // On iPhone SE, use 'start' to ensure element is fully visible
            const isSmallScreen = window.innerWidth <= 375;
            // For ANALOG tutorial ADJUSTMENT step, don't scroll - just tell user to click it
            const isAnalogAdjustmentStep = tutorialSensorType === 'ANALOG' && step.clickTarget === 'ADJUSTMENT';
            if (isAnalogAdjustmentStep) {
                // Don't scroll for Analog Adjustment step - just show the tooltip
            } else if (step.clickTarget === 'DEVICE_ADDRESS') {
                element.scrollIntoView({ behavior: 'smooth', block: isSmallScreen ? 'start' : 'center' });
            } else if (isBackButtonStep) {
                // For back buttons, scroll into view gently
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Always add/update pointer/circle (unless on loading screen without preserve flag)
            // Back buttons MUST always have pointers - FORCE pointer creation
            const shouldCreatePointer = (!isLoadingScreen || preservePointer) || isBackButtonStep;
            if (shouldCreatePointer) {
                // Add visual pointer arrow with red circle - do this immediately
                const createOrUpdatePointer = () => {
                    // Re-check if this is a back button step (needed in this scope)
                    const isBackButtonStepLocal = step.clickTarget === 'BACK_TO_SETUP' || step.clickTarget === 'BACK_TO_DEVICE_HOME';
                    const rect = element.getBoundingClientRect();
                    
                    // Debug log for back buttons
                    if (isBackButtonStepLocal) {
                        console.log('Creating pointer for back button. Element:', element, 'Rect:', rect);
                    }
                    
                    // Make sure element is actually visible
                    if (rect.width === 0 && rect.height === 0) {
                        // Element not visible yet, retry
                        setTimeout(createOrUpdatePointer, 50);
                        return;
                    }
                    
                    // Calculate element center position (viewport coordinates)
                    const elementCenterX = rect.left + rect.width / 2;
                    const elementTop = rect.top;
                    const elementBottom = rect.bottom;
                    const elementHeight = rect.height;
                    
                    // Adjust for iPhone SE (375px width) - smaller pointer circle
                    const isSmallScreen = window.innerWidth <= 375;
                    const pointerCircleSize = isSmallScreen ? 50 : 60;
                    const pointerOffset = pointerCircleSize / 2;
                    
                    // Special handling for back buttons - position to the right, pointing left
                    if (isBackButtonStepLocal) {
                        // Position pointer to the RIGHT of the back button, pointing LEFT
                        // Back button is on the left side, so pointer should be on the right side of it
                        const buttonRight = rect.right;
                        const buttonCenterY = rect.top + rect.height / 2;
                        const spacingFromButton = isSmallScreen ? 10 : 15; // Space between button and pointer
                        pointerLeft = buttonRight + spacingFromButton;
                        // Move pointer up significantly to align with button center - very aggressive upward adjustment
                        // The pointer circle center needs to be much higher to align the arrow with the button
                        // verticalAdjustment: Negative values move the circle UP, making the arrow point higher
                        // Current values are tuned to align the ð emoji center with buttonCenterY
                        const verticalAdjustment = isSmallScreen ? -50 : -60; // Much more aggressive: -50/-60 to move pointer significantly higher
                        pointerTop = buttonCenterY - pointerOffset + verticalAdjustment;
                        
                        // DEBUG: Log the calculation for back buttons
                        console.log('Back button pointer calculation:', {
                            buttonCenterY,
                            pointerOffset,
                            verticalAdjustment,
                            calculatedPointerTop: pointerTop,
                            buttonTop: rect.top,
                            buttonBottom: rect.bottom,
                            buttonHeight: rect.height
                        });
                    } else {
                        // Check if this is Step 10 (Device address on SETUP_MENU) - NO POINTER for this step
                        const isStep10DeviceAddress = step.clickTarget === 'DEVICE_ADDRESS' && step.screen === 'SETUP_MENU';
                        
                        if (isStep10DeviceAddress) {
                            // Step 10: No pointer, just highlight and tooltip
                            // Remove any existing pointer
                            if (window.tutorialPointerElement) {
                                window.tutorialPointerElement.classList.remove('visible');
                                setTimeout(() => {
                                    if (window.tutorialPointerElement) {
                                        window.tutorialPointerElement.remove();
                                        window.tutorialPointerElement = null;
                                    }
                                }, 300);
                            }
                            return; // Don't create pointer for Step 10
                        }
                        
                        // DYNAMIC pointer positioning that works on ALL screen sizes
                        // Calculate based on actual element position and viewport
                        const isDeviceAddressStep = step.clickTarget === 'DEVICE_ADDRESS' || step.clickTarget === 'DEVICE_ADDRESS_MODAL_OPENED';
                        
                        // CRITICAL: Verify this is actually the device address button, not the exit tutorial button
                        if (isDeviceAddressStep) {
                            const buttonText = (element.textContent || element.innerText || '').trim();
                            const isInTooltip = element.closest('.tutorial-inline-tooltip');
                            const isTutorialButton = element.classList.contains('btn-skip-inline') || 
                                                    element.classList.contains('btn-next-inline') ||
                                                    isInTooltip;
                            const isDeviceAddressButton = !isTutorialButton && 
                                                          (buttonText.includes('Device address') || 
                                                           (element.onclick && element.onclick.toString().includes('DEVICE_ADDRESS_MODAL')));
                            
                            if (!isDeviceAddressButton) {
                                // Wrong element found - retry finding the correct one
                                console.warn('Wrong element selected for device address. Retrying...');
                                setTimeout(() => {
                                    const correctButton = document.querySelector('.mt-4.bg-white button[onclick*="DEVICE_ADDRESS_MODAL"]') ||
                                                         Array.from(document.querySelectorAll('button[onclick*="DEVICE_ADDRESS_MODAL"]')).find(btn => {
                                                             const txt = (btn.textContent || btn.innerText || '').trim();
                                                             return txt.includes('Device address') && !btn.closest('.tutorial-inline-tooltip');
                                                         });
                                    if (correctButton) {
                                        console.log('Found correct device address button, updating pointer');
                                        highlightAndShowTooltip(correctButton, step);
                                    }
                                }, 100);
                                return; // Don't create pointer for wrong element
                            }
                        }
                        
                        // REGULAR ELEMENT POSITIONING
                        // Define consistent spacing constants
                        // CRITICAL CHANGE: Set to 12 for small screens. This is a more aggressive compensation 
                        // to visually lift the arrow tip right onto the element's top boundary.
                        const ARROW_TIP_OFFSET = isSmallScreen ? 12 : 20;
                        // REGULAR_SPACING: Kept at 0 to eliminate the vertical gap.
                        const REGULAR_SPACING = isSmallScreen ? 0 : 5;
                        
                        // Calculate: circle center Y should be such that arrow tip = element top - REGULAR_SPACING
                        const circleCenterY = elementTop - REGULAR_SPACING - ARROW_TIP_OFFSET;
                        pointerTop = circleCenterY - pointerOffset;
                        pointerLeft = elementCenterX - pointerOffset;
                    }
                    
                    // Viewport bounds
                    const minLeft = 5;
                    const maxLeft = window.innerWidth - pointerCircleSize - 5;
                    // CRITICAL FIX: For back buttons, allow positioning even closer to top (0px) to allow upward adjustment
                    const minTop = isBackButtonStepLocal ? 0 : 1; // Changed from 5 to 0 for back buttons
                    const maxTop = window.innerHeight - pointerCircleSize - 5;
                    const FALLBACK_SPACING = isSmallScreen ? 2 : 5; // Consistent fallback spacing
                    
                    // Adjust if off-screen - but for back buttons, be more permissive
                    if (pointerTop < minTop) {
                        // For back buttons, don't use fallback that puts it below - just clamp to minTop
                        if (isBackButtonStepLocal) {
                            pointerTop = minTop; // Just clamp to top, don't move below button
                        } else {
                            // FALLBACK: Use the consistent FALLBACK_SPACING
                            pointerTop = elementBottom + FALLBACK_SPACING;
                            if (pointerTop > maxTop) {
                                pointerTop = maxTop;
                            }
                        }
                    } else {
                        // Only clamp if not a back button step, or if it's reasonable
                        if (!isBackButtonStepLocal) {
                            pointerTop = Math.max(minTop, pointerTop);
                        }
                        // For back buttons, trust the calculation and don't clamp
                    }
                    
                    // Keep pointer within horizontal bounds
                    pointerLeft = Math.max(minLeft, Math.min(pointerLeft, maxLeft));
                    
                    // ALWAYS update existing pointer or create new one
                    if (window.tutorialPointerElement && window.tutorialPointerElement.parentNode) {
                        // Update position smoothly (this is the key - always update, never remove)
                        window.tutorialPointerElement.style.left = pointerLeft + 'px';
                        window.tutorialPointerElement.style.top = pointerTop + 'px';
                        // Update arrow direction for back buttons
                        const pointerArrow = window.tutorialPointerElement.querySelector('.tutorial-pointer');
                        if (pointerArrow) {
                            if (isBackButtonStepLocal) {
                                pointerArrow.textContent = 'ð';
                                pointerArrow.style.transform = 'translate(-50%, -50%) rotate(-10deg)';
                            } else {
                                pointerArrow.textContent = 'ð';
                                pointerArrow.style.transform = 'translate(-50%, -50%)';
                            }
                        }
                        // Ensure it's visible
                        window.tutorialPointerElement.classList.add('visible');
                        
                // Add "Tap!" text for Step 14 (MEASUREMENT_CYCLED) and Step 16 (CURRENT_OUTPUT_CYCLED)
                const isStep14 = step.clickTarget === 'MEASUREMENT_CYCLED';
                const isStep16 = step.clickTarget === 'CURRENT_OUTPUT_CYCLED';
                if (isStep14 || isStep16) {
                    // Remove existing tap text if any
                    const existingTapText = document.querySelector('.tutorial-tap-text');
                    if (existingTapText) {
                        existingTapText.remove();
                    }
                    
                    // Create and position "Tap!" text next to pointer
                    const tapText = document.createElement('div');
                    tapText.className = 'tutorial-tap-text';
                    tapText.textContent = 'Tap!';
                    
                    // Position to the right of the pointer circle
                    const tapTextLeft = pointerLeft + pointerCircleSize + 10;
                    const tapTextTop = pointerTop + (pointerCircleSize / 2) - 10; // Center vertically with pointer
                    tapText.style.left = tapTextLeft + 'px';
                    tapText.style.top = tapTextTop + 'px';
                    
                    document.body.appendChild(tapText);
                    window.tutorialTapTextElement = tapText;
                } else {
                    // Remove tap text if not Step 14 or Step 16
                    const existingTapText = document.querySelector('.tutorial-tap-text');
                    if (existingTapText) {
                        existingTapText.remove();
                    }
                    window.tutorialTapTextElement = null;
                }
                    } else {
                        // Remove any old circles first
                        document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                            if (el !== window.tutorialPointerElement) {
                                el.classList.remove('visible');
                                setTimeout(() => el.remove(), 300);
                            }
                        });
                        
                        // Create red circle container
                        const circle = document.createElement('div');
                        circle.className = 'tutorial-pointer-circle first-appear';
                        circle.style.position = 'fixed';
                        
                        // Re-check if this is a back button step (needed in this scope too)
                        const isBackButtonStepLocal2 = step.clickTarget === 'BACK_TO_SETUP' || step.clickTarget === 'BACK_TO_DEVICE_HOME';
                        
                        // Adjust for iPhone SE (375px width) - smaller pointer circle
                        const isSmallScreen2 = window.innerWidth <= 375;
                        const pointerCircleSize2 = isSmallScreen2 ? 50 : 60;
                        const pointerOffset2 = pointerCircleSize2 / 2;
                        
                        // Calculate element center position (viewport coordinates)
                        const elementCenterX = rect.left + rect.width / 2;
                        const elementTop = rect.top;
                        const elementBottom = rect.bottom;
                        
                        // Special handling for back buttons - position to the right, pointing left
                        if (isBackButtonStepLocal2) {
                            // Position pointer to the RIGHT of the back button, pointing LEFT
                            // Back button is on the left side, so pointer should be on the right side of it
                            const buttonRight = rect.right;
                            const buttonCenterY = rect.top + rect.height / 2;
                            const spacingFromButton = isSmallScreen2 ? 10 : 15; // Space between button and pointer
                            pointerLeft = buttonRight + spacingFromButton;
                            // Move pointer up significantly to align with button center - very aggressive upward adjustment
                            // The pointer circle center needs to be much higher to align the arrow with the button
                            // verticalAdjustment: Negative values move the circle UP, making the arrow point higher
                            // Current values are tuned to align the ð emoji center with buttonCenterY
                            const verticalAdjustment = isSmallScreen2 ? -50 : -60; // Much more aggressive: -50/-60 to move pointer significantly higher
                            pointerTop = buttonCenterY - pointerOffset2 + verticalAdjustment;
                            
                            // DEBUG: Log the calculation for back buttons
                            console.log('Back button pointer calculation (create path):', {
                                buttonCenterY,
                                pointerOffset2,
                                verticalAdjustment,
                                calculatedPointerTop: pointerTop,
                                buttonTop: rect.top,
                                buttonBottom: rect.bottom,
                                buttonHeight: rect.height
                            });
                        } else {
                            // Check if this is Step 10 (Device address on SETUP_MENU) - NO POINTER for this step
                            const isStep10DeviceAddress2 = step.clickTarget === 'DEVICE_ADDRESS' && step.screen === 'SETUP_MENU';
                            
                            if (isStep10DeviceAddress2) {
                                // Step 10: No pointer, just highlight and tooltip
                                // Remove any existing pointer
                                if (window.tutorialPointerElement) {
                                    window.tutorialPointerElement.classList.remove('visible');
                                    setTimeout(() => {
                                        if (window.tutorialPointerElement) {
                                            window.tutorialPointerElement.remove();
                                            window.tutorialPointerElement = null;
                                        }
                                    }, 300);
                                }
                                return; // Don't create pointer for Step 10
                            }
                            
                            // DYNAMIC pointer positioning that works on ALL screen sizes
                            // Calculate based on actual element position and viewport
                            const isDeviceAddressStep2 = step.clickTarget === 'DEVICE_ADDRESS' || step.clickTarget === 'DEVICE_ADDRESS_MODAL_OPENED';
                            
                            // CRITICAL: Verify this is actually the device address button, not the exit tutorial button
                            if (isDeviceAddressStep2) {
                                const buttonText = (element.textContent || element.innerText || '').trim();
                                const isInTooltip = element.closest('.tutorial-inline-tooltip');
                                const isTutorialButton = element.classList.contains('btn-skip-inline') || 
                                                        element.classList.contains('btn-next-inline') ||
                                                        isInTooltip;
                                const isDeviceAddressButton = !isTutorialButton && 
                                                              (buttonText.includes('Device address') || 
                                                               (element.onclick && element.onclick.toString().includes('DEVICE_ADDRESS_MODAL')));
                                
                                if (!isDeviceAddressButton) {
                                    // Wrong element found - don't create pointer
                                    console.warn('Wrong element selected for device address (create). Skipping pointer creation.');
                                    return; // Exit early, don't create pointer
                                }
                            }
                            
                            // REGULAR ELEMENT POSITIONING
                            // Define consistent spacing constants
                            // CRITICAL CHANGE: Set to 12 for small screens. This is a more aggressive compensation 
                            // to visually lift the arrow tip right onto the element's top boundary.
                            const ARROW_TIP_OFFSET2 = isSmallScreen2 ? 12 : 20;
                            // REGULAR_SPACING2: Kept at 0 to eliminate the vertical gap.
                            const REGULAR_SPACING2 = isSmallScreen2 ? 0 : 5;
                            
                            // Calculate: circle center Y should be such that arrow tip = element top - REGULAR_SPACING2
                            const circleCenterY2 = elementTop - REGULAR_SPACING2 - ARROW_TIP_OFFSET2;
                            pointerTop = circleCenterY2 - pointerOffset2;
                            pointerLeft = elementCenterX - pointerOffset2;
                        }
                        
                        // Viewport bounds
                        const minLeft = 5;
                        const maxLeft = window.innerWidth - pointerCircleSize2 - 5;
                        // CRITICAL FIX: For back buttons, allow positioning even closer to top (0px) to allow upward adjustment
                        const minTop = isBackButtonStepLocal2 ? 0 : 1; // Changed from 5 to 0 for back buttons
                        const maxTop = window.innerHeight - pointerCircleSize2 - 5;
                        const FALLBACK_SPACING2 = isSmallScreen2 ? 2 : 5; // Consistent fallback spacing
                        
                        // Adjust if off-screen - but for back buttons, be more permissive
                        if (pointerTop < minTop) {
                            // For back buttons, don't use fallback that puts it below - just clamp to minTop
                            if (isBackButtonStepLocal2) {
                                pointerTop = minTop; // Just clamp to top, don't move below button
                            } else {
                                // FALLBACK: Use the consistent FALLBACK_SPACING
                                pointerTop = elementBottom + FALLBACK_SPACING2;
                                if (pointerTop > maxTop) {
                                    pointerTop = maxTop;
                                }
                            }
                        } else {
                            // Only clamp if not a back button step, or if it's reasonable
                            if (!isBackButtonStepLocal2) {
                                pointerTop = Math.max(minTop, pointerTop);
                            }
                            // For back buttons, trust the calculation and don't clamp
                        }
                        
                        // Keep pointer within horizontal bounds
                        pointerLeft = Math.max(minLeft, Math.min(pointerLeft, maxLeft));
                        
                        circle.style.left = pointerLeft + 'px';
                        circle.style.top = pointerTop + 'px';
                        
                        // Create pointer arrow inside circle (centered)
                        const pointer = document.createElement('div');
                        pointer.className = 'tutorial-pointer';
                        // For back buttons, use left arrow; for others, use down arrow
                        if (isBackButtonStepLocal2) {
                            pointer.textContent = 'ð';
                            // Rotate slightly to point more accurately at the button
                            pointer.style.transform = 'translate(-50%, -50%) rotate(-10deg)';
                        } else {
                        pointer.textContent = 'ð';
                            pointer.style.transform = 'translate(-50%, -50%)';
                        }
                        pointer.style.position = 'absolute';
                        pointer.style.left = '50%';
                        pointer.style.top = '50%';
                        pointer.style.margin = '0';
                        pointer.style.width = '40px';
                        pointer.style.height = '40px';
                        pointer.style.display = 'flex';
                        pointer.style.alignItems = 'center';
                        pointer.style.justifyContent = 'center';
                        
                        circle.appendChild(pointer);
                        document.body.appendChild(circle);
                        
                        // Make visible immediately (no fade) for first appearance
                        circle.classList.add('visible');
                        // Remove first-appear class after a moment to allow transitions for future moves
                        setTimeout(() => {
                            circle.classList.remove('first-appear');
                        }, 50);
                        
                        // Store for cleanup
                        window.tutorialPointerElement = circle;
                        
                        // Add "Tap!" text for Step 14 (MEASUREMENT_CYCLED)
                        const isStep14 = step.clickTarget === 'MEASUREMENT_CYCLED';
                        if (isStep14) {
                            // Remove existing tap text if any
                            const existingTapText = document.querySelector('.tutorial-tap-text');
                            if (existingTapText) {
                                existingTapText.remove();
                            }
                            
                            // Create and position "Tap!" text next to pointer
                            const tapText = document.createElement('div');
                            tapText.className = 'tutorial-tap-text';
                            tapText.textContent = 'Tap!';
                            
                            // Position to the right of the pointer circle
                            const tapTextLeft = pointerLeft + pointerCircleSize2 + 10;
                            const tapTextTop = pointerTop + (pointerCircleSize2 / 2) - 10; // Center vertically with pointer
                            tapText.style.left = tapTextLeft + 'px';
                            tapText.style.top = tapTextTop + 'px';
                            
                            document.body.appendChild(tapText);
                            window.tutorialTapTextElement = tapText;
                        } else {
                            // Remove tap text if not Step 14
                            const existingTapText = document.querySelector('.tutorial-tap-text');
                            if (existingTapText) {
                                existingTapText.remove();
                            }
                            window.tutorialTapTextElement = null;
                        }
                    }
                };
                
                // Try immediately, then retry if needed
                createOrUpdatePointer();
                setTimeout(createOrUpdatePointer, 50);
            } else {
                // On loading screen, just remove pointer/circle but keep tooltip
                if (window.tutorialPointerElement) {
                    window.tutorialPointerElement.classList.remove('visible');
                    setTimeout(() => {
                        if (window.tutorialPointerElement) {
                            window.tutorialPointerElement.remove();
                            window.tutorialPointerElement = null;
                        }
                    }, 300);
                }
                document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                    el.classList.remove('visible');
                    setTimeout(() => el.remove(), 300);
                });
            }
            
            // Create and show tooltip
            setTimeout(() => {
                if (!tutorialActive || document.querySelector('.tutorial-inline-tooltip')) return;
                const tooltip = createTooltip(step);
                // Move to top ONLY if modal is open
                if (isModalOpen) {
                    tooltip.classList.add('configuring');
                }
                document.body.appendChild(tooltip);
                tutorialTooltipElement = tooltip;
                // Smooth fade-in - add visible class after a tiny delay
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        if (tooltip.parentNode) {
                            tooltip.classList.add('visible');
                        }
                    }, 10);
                });
            }, 50);
        }
    }

    function showCenterTooltip(step) {
        removeTutorialTooltip();
        
        // Check if modal is open (only move to top when modal is actually open)
        const isModalOpen = document.getElementById('modal-overlay') && !document.getElementById('modal-overlay').classList.contains('hidden');
        
        // Check if this is the first step (welcome) on OVERVIEW screen - add lock overlay
        const isFirstStepOnOverview = currentTutorialStep === 0 && currentScreen === 'OVERVIEW';
        if (isFirstStepOnOverview) {
            createTutorialLockOverlay();
        } else {
            removeTutorialLockOverlay();
        }
        
        const tooltip = createTooltip(step);
        // Move to top ONLY if modal is open
        if (isModalOpen) {
            tooltip.classList.add('configuring');
        }
        document.body.appendChild(tooltip);
        tutorialTooltipElement = tooltip;
        // Smooth fade-in - add visible class after a tiny delay
        requestAnimationFrame(() => {
            setTimeout(() => {
                if (tooltip.parentNode) {
                    tooltip.classList.add('visible');
                }
            }, 10);
        });
    }
    
    // Function to create lock overlay that blocks interaction except tutorial buttons
    function createTutorialLockOverlay() {
        // Remove existing overlay if any
        removeTutorialLockOverlay();
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'tutorial-lock-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9998;
            pointer-events: auto;
        `;
        
        // Block all clicks except on tutorial tooltip
        overlay.addEventListener('click', (e) => {
            const target = e.target;
            // Check if click is on tutorial tooltip or its buttons
            const tooltip = document.querySelector('.tutorial-inline-tooltip');
            if (tooltip && (target.closest('.tutorial-inline-tooltip') || 
                target.classList.contains('btn-next-inline') || 
                target.classList.contains('btn-skip-inline'))) {
                // Allow the click to pass through - don't block it
                return;
            }
            // Block all other clicks
            e.stopPropagation();
            e.preventDefault();
        });
        
        document.body.appendChild(overlay);
        tutorialLockOverlay = overlay;
        
        // Ensure tooltip has higher z-index than overlay
        setTimeout(() => {
            const tooltip = document.querySelector('.tutorial-inline-tooltip');
            if (tooltip) {
                tooltip.style.zIndex = '9999';
            }
        }, 50);
    }
    
    // Function to remove lock overlay
    function removeTutorialLockOverlay() {
        if (tutorialLockOverlay) {
            tutorialLockOverlay.remove();
            tutorialLockOverlay = null;
        }
        // Also remove by ID in case it exists
        const existingOverlay = document.getElementById('tutorial-lock-overlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }
    }
    
    // Helper function to find the Distance measurement element
    function findDistanceElement() {
        // Distance is at index 3 in MEASUREMENT_TYPES
        // Check which position is showing Distance
        if (measurementTypeIndex1 === 3) {
            // Position 1 (left) is showing Distance
            return document.querySelector('div[onclick*="cycleMeasurementType(1)"]');
        } else if (measurementTypeIndex2 === 3) {
            // Position 2 (middle top) is showing Distance
            return document.querySelector('div[onclick*="cycleMeasurementType(2)"]');
        } else if (measurementTypeIndex3 === 3) {
            // Position 3 (middle bottom) is showing Distance
            return document.querySelector('div[onclick*="cycleMeasurementType(3)"]');
        }
        return null;
    }
    
    // Helper function to find the Current output measurement element
    function findCurrentOutputElement() {
        // Current output is at index 8 in MEASUREMENT_TYPES
        // Check which position is showing Current output
        if (measurementTypeIndex1 === 8) {
            // Position 1 (left) is showing Current output
            return document.querySelector('div[onclick*="cycleMeasurementType(1)"]');
        } else if (measurementTypeIndex2 === 8) {
            // Position 2 (middle top) is showing Current output
            return document.querySelector('div[onclick*="cycleMeasurementType(2)"]');
        } else if (measurementTypeIndex3 === 8) {
            // Position 3 (middle bottom) is showing Current output
            return document.querySelector('div[onclick*="cycleMeasurementType(3)"]');
        }
        return null;
    }
    
    // Function to show tooltip below the Distance element
    function showTooltipBelowDistance(distanceElement, step) {
removeTutorialTooltip();
        
        const tooltip = createTooltip(step);
        document.body.appendChild(tooltip);
        tutorialTooltipElement = tooltip;
        // Smooth fade-in - add visible class after a tiny delay
        requestAnimationFrame(() => {
            setTimeout(() => {
                if (tooltip.parentNode) {
                    tooltip.classList.add('visible');
                }
            }, 10);
        });
        
        // Position tooltip below the Distance element
        setTimeout(() => {
            if (!distanceElement || !tooltip.parentNode) return;
            
            const rect = distanceElement.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            // Position below the element with some spacing
            const top = rect.bottom + scrollTop + 15; // 15px spacing
            const left = rect.left + scrollLeft + (rect.width / 2) - (tooltip.offsetWidth / 2);
            
            // Use fixed positioning to keep it in view, but maintain normal tooltip styling
            tooltip.style.position = 'fixed';
            tooltip.style.top = (rect.bottom + 15) + 'px'; // Use viewport coordinates
            tooltip.style.left = Math.max(10, Math.min(left, window.innerWidth - tooltip.offsetWidth - 10)) + 'px'; // Keep within viewport
            tooltip.style.bottom = 'auto'; // Override default bottom positioning
            tooltip.style.transform = 'none'; // Override default transform
            tooltip.style.zIndex = '10000';
            // Adjust max-width for small screens (iPhone SE)
            if (window.innerWidth <= 375) {
                tooltip.style.maxWidth = 'calc(100% - 16px)';
                tooltip.style.minWidth = 'auto';
                tooltip.style.width = 'calc(100% - 16px)';
            } else {
                tooltip.style.maxWidth = '320px'; // Use normal tooltip max-width
                tooltip.style.minWidth = '280px'; // Use normal tooltip min-width
            }
            
            // Ensure it doesn't go off-screen
            const tooltipRect = tooltip.getBoundingClientRect();
            if (tooltipRect.bottom > window.innerHeight - 20) {
                // If tooltip would go off bottom, position it above the element instead
                tooltip.style.top = (rect.top - tooltipRect.height - 15) + 'px';
            }
            if (tooltipRect.right > window.innerWidth - 10) {
                tooltip.style.left = (window.innerWidth - tooltipRect.width - 10) + 'px';
            }
            if (tooltipRect.left < 10) {
                tooltip.style.left = '10px';
            }
        }, 50);
    }
    
    // Function to show tooltip below the Current output element
    function showTooltipBelowCurrentOutput(currentOutputElement, step) {
        removeTutorialTooltip();
        
        const tooltip = createTooltip(step);
        document.body.appendChild(tooltip);
        tutorialTooltipElement = tooltip;
        // Smooth fade-in - add visible class after a tiny delay
        requestAnimationFrame(() => {
            setTimeout(() => {
                if (tooltip.parentNode) {
                    tooltip.classList.add('visible');
                }
            }, 10);
        });
        
        // Position tooltip below the Current output element
        setTimeout(() => {
            if (!currentOutputElement || !tooltip.parentNode) return;
            
            const rect = currentOutputElement.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            // Position below the element with some spacing
            const top = rect.bottom + scrollTop + 15; // 15px spacing
            const left = rect.left + scrollLeft + (rect.width / 2) - (tooltip.offsetWidth / 2);
            
            // Use fixed positioning to keep it in view, but maintain normal tooltip styling
            tooltip.style.position = 'fixed';
            tooltip.style.top = (rect.bottom + 15) + 'px'; // Use viewport coordinates
            tooltip.style.left = Math.max(10, Math.min(left, window.innerWidth - tooltip.offsetWidth - 10)) + 'px'; // Keep within viewport
            tooltip.style.bottom = 'auto'; // Override default bottom positioning
            tooltip.style.transform = 'none'; // Override default transform
            tooltip.style.zIndex = '10000';
            // Adjust max-width for small screens (iPhone SE)
            if (window.innerWidth <= 375) {
                tooltip.style.maxWidth = 'calc(100% - 16px)';
                tooltip.style.minWidth = 'auto';
                tooltip.style.width = 'calc(100% - 16px)';
            } else {
                tooltip.style.maxWidth = '320px'; // Use normal tooltip max-width
                tooltip.style.minWidth = '280px'; // Use normal tooltip min-width
            }
            
            // Ensure it doesn't go off-screen
            const tooltipRect = tooltip.getBoundingClientRect();
            if (tooltipRect.bottom > window.innerHeight - 20) {
                // If tooltip would go off bottom, position it above the element instead
                tooltip.style.top = (rect.top - tooltipRect.height - 15) + 'px';
            }
            if (tooltipRect.right > window.innerWidth - 10) {
                tooltip.style.left = (window.innerWidth - tooltipRect.width - 10) + 'px';
            }
            if (tooltipRect.left < 10) {
                tooltip.style.left = '10px';
            }
        }, 50);
    }

    function createTooltip(step) {
        const tooltip = document.createElement('div');
        tooltip.className = 'tutorial-inline-tooltip';
        
        // Check if this is the final step
        const isFinalStep = currentTutorialStep === tutorialSteps.length - 1;
        // Show Next button ONLY on welcome screen (first step with action: 'auto')
        const showNextButton = step.action === 'auto' && !isFinalStep;
        // Show Complete button on final step
        const showCompleteButton = isFinalStep;
        // Show OK button for Step 15 (DISTANCE_EXPLANATION_OK) in ANALOG tutorial
        const showOKButton = step.clickTarget === 'DISTANCE_EXPLANATION_OK';
        
        const nextButtonText = (showNextButton && currentTutorialStep === 0) ? 'Start' : 'Next';
        tooltip.innerHTML = `
            <h4 style="margin: 0 0 0.25rem 0;">${step.title}</h4>
            <p style="margin: 0 0 0.375rem 0;">${step.message}</p>
            ${showNextButton ? `<button class="btn-next-inline" onclick="nextTutorialStep()" style="margin-bottom: 0.25rem;">${nextButtonText}</button>` : ''}
            ${showOKButton ? '<button class="btn-next-inline" onclick="handleDistanceExplanationOK()" style="margin-bottom: 0.25rem;">OK</button>' : ''}
            ${showCompleteButton ? '<button class="btn-next-inline" onclick="showRecap()" style="margin-bottom: 0.25rem;">Recap</button>' : ''}
            <button class="btn-skip-inline" onclick="endTutorial()" style="margin: 0;">Exit Tutorial</button>
        `;
        return tooltip;
    }

    function updateStepIndicator(current, total) {
        let indicator = document.getElementById('tutorial-step-indicator-inline');
        
        // Hide indicator on welcome screen (step 0) and final step (completion message)
        if (current === 0 || currentTutorialStep === 0 || current === total) {
            if (indicator) {
                indicator.style.display = 'none';
            }
            return;
        }
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'tutorial-step-indicator-inline';
            indicator.className = 'tutorial-step-indicator-inline';
            document.body.appendChild(indicator);
        }
        indicator.style.display = 'block';
        // Adjust the count to exclude the welcome screen
        indicator.textContent = `Step ${current} of ${total - 1}`;
    }

    function removeTutorialTooltip(preservePointer = false) {
        // Remove the tracked tooltip
        if (tutorialTooltipElement) {
            tutorialTooltipElement.remove();
            tutorialTooltipElement = null;
        }
        
        // Only remove pointers if not preserving them
        if (!preservePointer) {
            // Remove ALL pointers and circles (with fade out)
            if (window.tutorialPointerElement) {
                window.tutorialPointerElement.classList.remove('visible');
                setTimeout(() => {
                    if (window.tutorialPointerElement) {
                        window.tutorialPointerElement.remove();
                        window.tutorialPointerElement = null;
                    }
                }, 300);
            }
            document.querySelectorAll('.tutorial-pointer-circle').forEach(el => {
                el.classList.remove('visible');
                setTimeout(() => el.remove(), 300);
            });
            document.querySelectorAll('.tutorial-pointer').forEach(el => el.remove());
        }
        
        // Remove ALL tooltips (safety measure to prevent duplicates)
        document.querySelectorAll('.tutorial-inline-tooltip').forEach(el => {
            el.remove();
        });
        
        // Remove all highlights
        document.querySelectorAll('.tutorial-highlight-inline').forEach(el => {
            el.classList.remove('tutorial-highlight-inline');
        });
    }

    function nextTutorialStep() {
        // Remove lock overlay when advancing from first step
        if (currentTutorialStep === 0) {
            removeTutorialLockOverlay();
        }
        if (!tutorialActive) return;
        
        const currentStep = tutorialSteps[currentTutorialStep];
        
        // Allow advancing if it's the welcome screen (auto action)
        // Otherwise, don't advance if we're waiting for user action
        // ALWAYS use window.waitingForAction first, then fallback to local
        // This ensures we get the most up-to-date value
        const isWaiting = (window.waitingForAction !== undefined) ? window.waitingForAction : waitingForAction;
        console.log('nextTutorialStep: checking waitingForAction. window:', window.waitingForAction, 'local:', waitingForAction, 'isWaiting:', isWaiting);
        
        if (currentStep && currentStep.action === 'wait' && isWaiting) {
            console.log('Waiting for user action, cannot advance. waitingForAction:', isWaiting);
            return;
        }
        
        // If we got here, we can advance - sync local variable with window
        if (window.waitingForAction !== undefined && !window.waitingForAction) {
            waitingForAction = false;
        }
        
        // Don't remove pointer here - let the next step handle it
        // Only remove tooltip
        if (tutorialTooltipElement) {
            tutorialTooltipElement.remove();
            tutorialTooltipElement = null;
        }
        document.querySelectorAll('.tutorial-inline-tooltip').forEach(el => el.remove());
        
        // Move to next step
        currentTutorialStep++;
        
        if (currentTutorialStep >= tutorialSteps.length) {
            endTutorial();
            return;
        }
        
        // Show the next step
        showTutorialStep(currentTutorialStep);
    }
    
    // Make nextTutorialStep available globally for tutorial advancement
    window.nextTutorialStep = nextTutorialStep;
    
    // Helper function to check if the clicked element matches the expected target
    function checkClickTarget(element, clickTarget) {
        if (!element || !clickTarget) return false;
        
        // Check onclick attribute
        const onclick = element.getAttribute('onclick');
        if (onclick) {
            if (clickTarget === 'DEVICE_LIST' && onclick.includes('DEVICE_LIST')) return true;
            if (clickTarget === 'DEVICE_SELECTED' && onclick.includes('selectedDeviceNumber')) return true;
            if (clickTarget === 'OK_CLICKED' && onclick.includes('AUTHENTICATING')) return true;
            if (clickTarget === 'CONNECT_CLICKED' && onclick.includes('AUTHENTICATING')) return true;
            if (clickTarget === 'SETUP_MENU' && onclick.includes('SETUP_MENU')) return true;
            if (clickTarget === 'APPLICATION' && onclick.includes('APPLICATION')) return true;
            if (clickTarget === 'DEVICE_ADDRESS' && onclick.includes('DEVICE_ADDRESS')) return true;
            if (clickTarget === 'ADJUSTMENT' && onclick.includes('ADJUSTMENT')) return true;
            if (clickTarget === 'MEDIUM_TYPE_MODAL' && onclick.includes('MEDIUM_TYPE_MODAL')) return true;
            if (clickTarget === 'APPLICATION_TYPE_MODAL' && onclick.includes('APPLICATION_TYPE_MODAL')) return true;
            if (clickTarget === 'BACK_TO_SETUP' && onclick.includes('goBack()')) return true;
            if (clickTarget === 'BACK_TO_DEVICE_HOME' && onclick.includes('goBack()')) return true;
            if (clickTarget === 'MODBUS_ADDRESS_OPENED' && onclick.includes('MODBUS_ADDRESS_MODAL')) return true;
            if (clickTarget === 'DEVICE_ADDRESS_MODAL_OPENED' && onclick.includes('DEVICE_ADDRESS_MODAL')) return true;
            if (clickTarget === 'EXTENDED_FUNCTIONS' && onclick.includes('EXTENDED_FUNCTIONS')) return true;
            if (clickTarget === 'DISTANCE_A_SET' && onclick.includes('Distance A')) return true;
            if (clickTarget === 'DISTANCE_B_SET' && onclick.includes('Distance B')) return true;
            if (clickTarget === 'MEASUREMENT_CYCLED' && onclick.includes('cycleMeasurementType')) return true;
        }
        
        return false;
    }

    // Monitor for user interactions - CLICK events
    document.addEventListener('click', function(e) {
        // Debug logging for Extended Functions
        if (e.target && (e.target.textContent && e.target.textContent.includes('Extended') || 
            e.target.parentElement && e.target.parentElement.textContent && e.target.parentElement.textContent.includes('Extended'))) {
            console.log('Click detected on Extended Functions area. tutorialActive:', tutorialActive, 'waitingForAction:', waitingForAction);
        }
        
        if (!tutorialActive || !waitingForAction) {
            if (e.target && e.target.textContent && e.target.textContent.includes('Extended')) {
                console.log('Click listener returning early - tutorialActive:', tutorialActive, 'waitingForAction:', waitingForAction);
            }
            return;
        }
        
        const step = tutorialSteps[currentTutorialStep];
        if (!step || step.action !== 'wait' || !step.clickTarget) {
            if (e.target && e.target.textContent && e.target.textContent.includes('Extended')) {
                console.log('Click listener returning - no valid step. step:', step, 'action:', step ? step.action : 'none', 'clickTarget:', step ? step.clickTarget : 'none');
            }
            return;
        }
        
        // Debug for Extended Functions step
        if (step.clickTarget === 'EXTENDED_FUNCTIONS') {
            console.log('Extended Functions step active! Checking click...');
        }
        
        // Don't advance for modal buttons - let the modal OK button handle it
        if (step.clickTarget === 'MEDIUM_TYPE_MODAL' || step.clickTarget === 'APPLICATION_TYPE_MODAL') {
            // Just mark that they clicked the button, but don't advance yet
            // The modal OK button will advance via updateApplicationChoice or hideModal
            return;
        }
        
        // Handle EXTENDED_FUNCTIONS click directly here
        if (step.clickTarget === 'EXTENDED_FUNCTIONS') {
            // Check if the clicked element is the Extended Functions header
            // Check by onclick, class name, or text content
            let element = e.target;
            let isExtendedFunctions = false;
            for (let i = 0; i < 8; i++) { // Check more levels up
                if (!element) break;
                
                // Check onclick attribute
                const onclick = element.getAttribute('onclick');
                if (onclick && onclick.includes('EXTENDED_FUNCTIONS')) {
                    isExtendedFunctions = true;
                    console.log('Click event: Extended Functions detected via onclick!');
                    break;
                }
                
                // Check class name
                if (element.classList && element.classList.contains('setup-section-header')) {
                    // Check if it contains "Extended functions" text
                    const text = element.textContent || element.innerText || '';
                    if (text.includes('Extended functions') || text.includes('Extended')) {
                        isExtendedFunctions = true;
                        console.log('Click event: Extended Functions detected via class and text!');
                        break;
                    }
                }
                
                // Check text content directly
                const text = element.textContent || element.innerText || '';
                if (text.includes('Extended functions') && element.closest && element.closest('.setup-section-header')) {
                    isExtendedFunctions = true;
                    console.log('Click event: Extended Functions detected via text!');
                    break;
                }
                
                element = element.parentElement;
            }
            
            // If it's Extended Functions, handle it directly
            if (isExtendedFunctions) {
                console.log('Handling Extended Functions click in event listener');
                // Mark action as complete IMMEDIATELY
                waitingForAction = false;
                window.waitingForAction = false;
                // Let toggleList execute first (onclick will fire), then advance
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        console.log('Advancing tutorial after Extended Functions click, waitingForAction:', waitingForAction);
                        window.nextTutorialStep();
                    } else {
                        console.log('Cannot advance: tutorialActive:', window.tutorialActive, 'nextTutorialStep:', typeof window.nextTutorialStep);
                    }
                }, 300); // Give toggleList time to execute and render
                return;
            } else {
                console.log('Extended Functions click NOT detected. Element:', e.target, 'Parent:', e.target.parentElement);
            }
        }
        
        // Check if the clicked element or any parent matches the target
        // This is a fallback for EXTENDED_FUNCTIONS if the above didn't catch it
        let element = e.target;
        let found = false;
        
        for (let i = 0; i < 8; i++) { // Check more levels
            if (!element) break;
            if (checkClickTarget(element, step.clickTarget)) {
                found = true;
                break;
            }
            element = element.parentElement;
        }
        
        if (found) {
            // For EXTENDED_FUNCTIONS, we already handled it above, but double-check here
            if (step.clickTarget === 'EXTENDED_FUNCTIONS') {
                console.log('Extended Functions also detected via checkClickTarget fallback');
                waitingForAction = false;
                window.waitingForAction = false;
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 300);
                return;
            }
            
            // For DEVICE_SELECTED, don't advance immediately - wait for screen change
            if (step.clickTarget === 'DEVICE_SELECTED') {
                // Mark that action was taken, but wait for screen change to advance
                waitingForAction = false;
                // Don't call nextTutorialStep here - let autoAdvanceOnScreenChange handle it
                // The pointer should persist through the transition
                return;
            }
            
            waitingForAction = false;
            // Minimal delay to let the action complete before advancing
            setTimeout(() => {
                if (tutorialActive) {
                    nextTutorialStep();
                }
            }, 100);
        }
    });
    
    // Monitor for user interactions - INPUT events
    document.addEventListener('input', function(e) {
        if (!tutorialActive || !waitingForAction) return;
        
        const step = tutorialSteps[currentTutorialStep];
        if (!step || step.action !== 'wait' || !step.inputTarget) return;
        
        // Check if input matches the expected selector
        if (step.selector) {
            const matchesSelector = e.target.matches(step.selector) || e.target.id === step.selector.replace('#', '');
            if (matchesSelector) {
                // For access code with auto-advance on screen change, just mark as ready but don't advance
                if (step.screen === 'ACCESS_CODE' && e.target.value.length >= 4) {
                    if (step.autoAdvanceOnScreenChange) {
                        // Don't advance yet - wait for screen change when they click Connect
                        // But we can update the UI or tooltip here if needed
                        console.log('Access code entered, waiting for Connect button click');
                    } else {
                        // Normal behavior - advance immediately
                        waitingForAction = false;
                        setTimeout(() => {
                            if (tutorialActive) {
                                nextTutorialStep();
                            }
                        }, 200);
                    }
                }
                // For device address (HART) and Modbus address - DO NOT auto-advance on input
                // User must press OK button to save and advance
                // Removed auto-advance - they must press OK to save
            }
        }
    });

    function showRecap() {
        // Remove tutorial tooltip and pointer
        removeTutorialTooltip();
        const indicator = document.getElementById('tutorial-step-indicator-inline');
        if (indicator) indicator.remove();
        if (window.tutorialPointerElement) {
            window.tutorialPointerElement.remove();
            window.tutorialPointerElement = null;
        }
        if (window.tutorialTapTextElement) {
            window.tutorialTapTextElement.remove();
            window.tutorialTapTextElement = null;
        }
        
        // Go to recap screen
        currentScreen = 'RECAP';
        renderScreen();
    }
    
    // Function to show text recap without starting tutorial
    function showTextRecap(sensorType) {
        // Set the sensor type
        selectedSensorType = sensorType;
        tutorialSensorType = sensorType;
        window.tutorialSensorType = sensorType;
        
        // Load the tutorial steps for the selected sensor type
        if (TUTORIAL_STEPS[sensorType]) {
            tutorialSteps = TUTORIAL_STEPS[sensorType];
        }
        
        // Go to recap screen
        currentScreen = 'RECAP';
        renderScreen();
    }
    
    // Expose globally
    window.showTextRecap = showTextRecap;
    
    function renderRecapScreen() {
        if (!tutorialSensorType || !tutorialSteps || tutorialSteps.length === 0) {
            return '<div class="p-4">No tutorial data available.</div>';
        }
        
        const steps = tutorialSteps;
        let recapHTML = `
            ${createHeader('Training Recap', false, 'settings')}
            <div class="px-4 py-6 bg-white">
                <h2 class="text-2xl font-bold mb-4" style="color: #764ba2;">${tutorialSensorType} Sensor Setup Recap</h2>
                <div class="space-y-4">
        `;
        
        steps.forEach((step, index) => {
            if (step.title && step.title !== 'Welcome' && !step.title.includes('Welcome')) {
                recapHTML += `
                    <div class="mb-4 pb-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold mb-2" style="color: #3B82F6;">${step.title}</h3>
                        <p class="text-gray-700 mb-2">${step.message}</p>
                `;
                
                // Add navigation instructions based on screen and clickTarget or inputTarget
                if (step.screen && (step.clickTarget || step.inputTarget)) {
                    let navigationText = '';
                    if (step.screen === 'OVERVIEW' && step.clickTarget === 'DEVICE_LIST') {
                        navigationText = 'Navigate to: Overview â Setup & Diagnosis';
                    } else if (step.screen === 'DEVICE_LIST' && step.clickTarget === 'DEVICE_SELECTED') {
                        navigationText = 'Navigate to: Device List â Select first device';
                    } else if (step.screen === 'ACCESS_CODE' && step.clickTarget === 'OK_CLICKED') {
                        navigationText = 'Navigate to: Access Code â Enter code â Tap OK';
                    } else if (step.screen === 'DEVICE_HOME' && step.clickTarget === 'SETUP_MENU') {
                        navigationText = 'Navigate to: Device Home â Setup';
                    } else if (step.screen === 'SETUP_MENU' && step.clickTarget === 'APPLICATION') {
                        navigationText = 'Navigate to: Setup Menu â Application';
                    } else if (step.screen === 'APPLICATION' && step.clickTarget === 'MEDIUM_TYPE_MODAL') {
                        navigationText = 'Navigate to: Application â Type of medium';
                    } else if (step.screen === 'APPLICATION' && step.clickTarget === 'APPLICATION_TYPE_MODAL') {
                        navigationText = 'Navigate to: Application â Application';
                    } else if (step.screen === 'APPLICATION' && step.clickTarget === 'BACK_TO_SETUP') {
                        navigationText = 'Navigate to: Application â Back arrow';
                    } else if (step.screen === 'SETUP_MENU' && step.clickTarget === 'EXTENDED_FUNCTIONS') {
                        navigationText = 'Navigate to: Setup Menu â Extended functions (expand)';
                    } else if (step.screen === 'SETUP_MENU' && step.clickTarget === 'DEVICE_ADDRESS') {
                        navigationText = 'Navigate to: Setup Menu â Device address';
                    } else if (step.screen === 'DEVICE_ADDRESS' && step.clickTarget === 'DEVICE_ADDRESS_MODAL_OPENED') {
                        navigationText = 'Navigate to: Device Address â Device address button';
                    } else if (step.screen === 'DEVICE_ADDRESS' && step.clickTarget === 'MODBUS_ADDRESS_OPENED') {
                        navigationText = 'Navigate to: Device Address â Instrument address Modbus';
                    } else if (step.screen === 'DEVICE_ADDRESS' && step.selector === '#modal-input-address') {
                        navigationText = 'Navigate to: Device Address â Device address modal â Enter value 1-63 â Press OK';
                    } else if (step.screen === 'DEVICE_ADDRESS' && step.selector === '#modal-input-modbus-address') {
                        navigationText = 'Navigate to: Device Address â Modbus address modal â Review/Enter value 1-247 â Press OK';
                    } else if (step.screen === 'DEVICE_ADDRESS' && step.clickTarget === 'BACK_TO_SETUP') {
                        navigationText = 'Navigate to: Device Address â Back arrow';
                    } else if (step.screen === 'SETUP_MENU' && step.clickTarget === 'BACK_TO_DEVICE_HOME') {
                        navigationText = 'Navigate to: Setup Menu â Back arrow';
                    } else if (step.screen === 'DEVICE_HOME' && step.clickTarget === 'MEASUREMENT_CYCLED') {
                        navigationText = 'Navigate to: Device Home â Tap measurement value to cycle until Distance is shown';
                    } else if (step.screen === 'DEVICE_HOME' && !step.clickTarget && step.title && step.title.includes('Distance Reading')) {
                        navigationText = 'Information: Distance readings go to BinCloud. Compare sensor reading to physical measurement.';
                    } else if (step.screen === 'SETUP_MENU' && step.clickTarget === 'ADJUSTMENT') {
                        navigationText = 'Navigate to: Setup Menu â Extended functions â Adjustment (auto-expanded for ANALOG)';
                    } else if (step.screen === 'ADJUSTMENT' && step.clickTarget === 'DISTANCE_A_SET') {
                        navigationText = 'Navigate to: Adjustment â Distance A â Enter 20mA (FULL) value â Press OK';
                    } else if (step.screen === 'ADJUSTMENT' && step.clickTarget === 'DISTANCE_B_SET') {
                        navigationText = 'Navigate to: Adjustment â Distance B â Enter 4mA (EMPTY) value â Press OK';
                    } else if (step.screen === 'ADJUSTMENT' && step.clickTarget === 'BACK_TO_SETUP') {
                        navigationText = 'Navigate to: Adjustment â Back arrow';
                    }
                    
                    if (navigationText) {
                        recapHTML += `<p class="text-sm text-gray-600 italic">${navigationText}</p>`;
                    }
                }
                
                recapHTML += `</div>`;
            }
        });
        
        recapHTML += `
                </div>
                <div class="mt-8 pt-6 border-t border-gray-300">
                    <button onclick="endTutorialAndReset()" class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">
                        Back to Home
                    </button>
                </div>
            </div>
        `;
        
        return recapHTML;
    }
    
    function endTutorialAndReset() {
        // Remove "Tap!" text if it exists
        if (window.tutorialTapTextElement) {
            window.tutorialTapTextElement.remove();
            window.tutorialTapTextElement = null;
        }
        document.querySelectorAll('.tutorial-tap-text').forEach(el => el.remove());
        
        // Reset all tutorial state
        tutorialActive = false;
        window.tutorialActive = false;
        waitingForAction = false;
        window.waitingForAction = false;
        tutorialSteps = [];
        currentTutorialStep = 0;
        tutorialSensorType = null;
        tutorialTooltipElement = null;
        
        // Unlock distance display if it was locked
        if (window.tutorialDistanceLocked) {
            window.tutorialDistanceLocked = false;
            // Re-enable onclick handlers for measurement cycling
            const measurementElements = document.querySelectorAll('[onclick*="cycleMeasurementType"]');
            measurementElements.forEach(el => {
                el.style.pointerEvents = '';
                el.style.cursor = 'pointer';
                el.style.opacity = '';
            });
        }
        
        // Remove all tutorial UI elements
        removeTutorialTooltip();
        const indicator = document.getElementById('tutorial-step-indicator-inline');
        if (indicator) indicator.remove();
        if (window.tutorialPointerElement) {
            window.tutorialPointerElement.remove();
            window.tutorialPointerElement = null;
        }
        
        // Reset Extended Functions expansion
        isExtendedFunctionsExpanded = false;
        isDiagnosticsExpanded = false;
        
        // Reset screen to home (SENSOR_SELECTION)
        currentScreen = 'SENSOR_SELECTION';
        history = [];
        renderScreen();
    }

    function endTutorial() {
        // Remove lock overlay when exiting tutorial
        removeTutorialLockOverlay();
        // Remove "Tap!" text if it exists
        if (window.tutorialTapTextElement) {
            window.tutorialTapTextElement.remove();
            window.tutorialTapTextElement = null;
        }
        document.querySelectorAll('.tutorial-tap-text').forEach(el => el.remove());
        tutorialActive = false;
        window.tutorialActive = false;
        waitingForAction = false;
        window.waitingForAction = false;
        
        // Unlock distance display if it was locked
        if (window.tutorialDistanceLocked) {
            window.tutorialDistanceLocked = false;
            // Re-enable onclick handlers for measurement cycling
            const measurementElements = document.querySelectorAll('[onclick*="cycleMeasurementType"]');
            measurementElements.forEach(el => {
                el.style.pointerEvents = '';
                el.style.cursor = 'pointer';
                el.style.opacity = '';
            });
        }
        
        removeTutorialTooltip();
        const indicator = document.getElementById('tutorial-step-indicator-inline');
        if (indicator) indicator.remove();
        
        // Remove tutorial pointer if it exists
        if (window.tutorialPointerElement) {
            window.tutorialPointerElement.remove();
            window.tutorialPointerElement = null;
        }
        document.querySelectorAll('.tutorial-pointer-circle').forEach(el => el.remove());
        
        // Remove tutorial highlights
        document.querySelectorAll('.tutorial-highlight-inline').forEach(el => {
            el.classList.remove('tutorial-highlight-inline');
        });
        
        // Reset tutorial state
        tutorialSteps = [];
        currentTutorialStep = 0;
        window.currentTutorialStep = 0;
        tutorialSensorType = null;
        window.tutorialSensorType = null;
        
        // Return to home page (sensor selection screen)
        currentScreen = 'SENSOR_SELECTION';
        history = [];
        
        // Re-render to show home page
        renderScreen();
    }
    
    // Make functions and state globally available
    Object.defineProperty(window, 'tutorialActive', {
        get: () => tutorialActive,
        set: (val) => { tutorialActive = val; }
    });
    Object.defineProperty(window, 'waitingForAction', {
        get: () => waitingForAction,
        set: (val) => { waitingForAction = val; }
    });
    Object.defineProperty(window, 'tutorialSteps', {
        get: () => tutorialSteps
    });
    Object.defineProperty(window, 'currentTutorialStep', {
        get: () => currentTutorialStep,
        set: (val) => { currentTutorialStep = val; }
    });
    Object.defineProperty(window, 'tutorialSensorType', {
        get: () => tutorialSensorType
    });
    function handleDistanceExplanationOK() {
        // Advance tutorial from Step 15 to Step 16
        if (window.tutorialActive && window.waitingForAction && window.currentTutorialStep !== undefined) {
            const step = window.tutorialSteps[window.currentTutorialStep];
            if (step && step.clickTarget === 'DISTANCE_EXPLANATION_OK') {
                console.log('Tutorial: Distance explanation OK clicked. Advancing to Step 16');
                window.waitingForAction = false;
                if (typeof waitingForAction !== 'undefined') {
                    waitingForAction = false;
                }
                setTimeout(() => {
                    if (window.tutorialActive && window.nextTutorialStep) {
                        window.nextTutorialStep();
                    }
                }, 300);
            }
        }
    }
    
    window.startTutorial = startTutorial;
    window.nextTutorialStep = nextTutorialStep;
    window.endTutorial = endTutorial;
    window.showRecap = showRecap;
    window.endTutorialAndReset = endTutorialAndReset;
    window.handleDistanceExplanationOK = handleDistanceExplanationOK;

    // Store original functions
    const originalGoToScreenFunction = goToScreen;
    const originalRenderSensorSelectionFunction = renderSensorSelectionScreen;
    const originalRenderScreenFunction = renderScreen;
    
    // Override goToScreen
    window.goToScreen = function(newScreen, replaceHistory = false) {
        const oldScreen = currentScreen;
        originalGoToScreenFunction(newScreen, replaceHistory);
        
        // Don't remove pointer when transitioning - only remove when actually showing a step on loading screen
        // The pointer will be handled by showTutorialStep when it detects loading screens
        
        if (tutorialActive && tutorialSteps.length > 0) {
            const currentStep = tutorialSteps[currentTutorialStep];
            
            // Check if this step should auto-advance when screen changes
            if (currentStep && currentStep.autoAdvanceOnScreenChange && oldScreen === currentStep.screen && newScreen !== oldScreen) {
                // Screen changed away from the step's screen, advance tutorial
                waitingForAction = false;
                setTimeout(() => {
                    if (tutorialActive) {
                        nextTutorialStep();
                    }
                }, 100);
            } else {
                // Normal screen change - only show step if we're on the correct screen
                // Don't show step if we just advanced (to avoid showing pointer randomly)
                setTimeout(() => {
                    if (tutorialActive && currentStep && currentScreen === currentStep.screen) {
                        // Only show step if we're actually waiting for action (not just after advancing)
                        // This prevents random pointer appearance after application type selection
                        const isWaiting = (window.waitingForAction !== undefined) ? window.waitingForAction : waitingForAction;
                        if (isWaiting) {
                        showTutorialStep(currentTutorialStep);
                        }
                    }
                    // Update tooltip position - only move to top if modal is open
                    if (tutorialTooltipElement) {
                        const isModalOpen = document.getElementById('modal-overlay') && !document.getElementById('modal-overlay').classList.contains('hidden');
                        if (isModalOpen) {
                            tutorialTooltipElement.classList.add('configuring');
                        } else {
                            tutorialTooltipElement.classList.remove('configuring');
                        }
                    }
                }, 150);
            }
        }
    };

    // Function to ask user if they want tutorial
    window.askForTutorial = function(sensorType) {
        if (confirm('Would you like a step-by-step tutorial to help set up your ' + sensorType + ' sensor?\n\nClick OK for guided setup, or Cancel to skip.')) {
            startTutorial(sensorType);
        }
        setTimeout(() => goToScreen('OVERVIEW'), 100);
    };
    
    // Override renderSensorSelectionScreen
    window.renderSensorSelectionScreen = function() {
        const html = originalRenderSensorSelectionFunction();
        return html.replace(
            /onclick="selectedSensorType = '(\w+)'; goToScreen\('OVERVIEW'\)"/g,
            "onclick=\"selectedSensorType = '$1'; askForTutorial('$1')\""
        );
    };
    
    // Hook into renderScreen
    window.renderScreen = function() {
        originalRenderScreenFunction();
        
        if (tutorialActive && tutorialSteps.length > 0) {
            setTimeout(() => {
                const currentStep = tutorialSteps[currentTutorialStep];
                if (currentStep && currentScreen === currentStep.screen) {
                    showTutorialStep(currentTutorialStep);
                }
            }, 100);
        }
    };

    // --- Initialization ---

    renderScreen(); 

</script>
</body>
</html>
